<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KlangReise ‚Äì Entdecke die Magie der Musik</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@300;400;500;600&family=Nunito:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-gradient-start: #1a1a2e;
            --bg-gradient-end: #16213e;
            --accent-warm: #ff6b6b;
            --accent-gold: #ffd93d;
            --accent-teal: #6bcb77;
            --accent-blue: #4d96ff;
            --accent-purple: #9b5de5;
            --text-light: #f8f8f8;
            --text-muted: #a0a0b0;
            --card-bg: rgba(255, 255, 255, 0.08);
            --card-border: rgba(255, 255, 255, 0.12);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Nunito', sans-serif;
            background: linear-gradient(135deg, var(--bg-gradient-start) 0%, var(--bg-gradient-end) 100%);
            min-height: 100vh;
            color: var(--text-light);
            overflow-x: hidden;
        }

        /* Animated background particles */
        .bg-particles {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            overflow: hidden;
            z-index: 0;
        }

        .particle {
            position: absolute;
            border-radius: 50%;
            opacity: 0.3;
            animation: float 20s infinite ease-in-out;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0) rotate(0deg); }
            50% { transform: translateY(-100px) rotate(180deg); }
        }

        /* Main container */
        .app-container {
            position: relative;
            z-index: 1;
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        /* Header */
        .header {
            text-align: center;
            margin-bottom: 3rem;
            animation: fadeInDown 0.8s ease-out;
        }

        @keyframes fadeInDown {
            from { opacity: 0; transform: translateY(-30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .logo {
            font-family: 'Fredoka', sans-serif;
            font-size: 3.5rem;
            font-weight: 600;
            background: linear-gradient(135deg, var(--accent-gold) 0%, var(--accent-warm) 50%, var(--accent-purple) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 0.5rem;
            letter-spacing: -1px;
        }

        .tagline {
            font-size: 1.2rem;
            color: var(--text-muted);
            font-weight: 400;
        }

        /* Navigation Tabs */
        .nav-tabs {
            display: flex;
            justify-content: center;
            gap: 0.5rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
        }

        .nav-tab {
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: 2rem;
            padding: 0.8rem 1.5rem;
            font-family: 'Nunito', sans-serif;
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-muted);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .nav-tab:hover {
            background: rgba(255, 255, 255, 0.12);
            color: var(--text-light);
        }

        .nav-tab.active {
            background: linear-gradient(135deg, var(--accent-purple), var(--accent-blue));
            color: white;
            border-color: transparent;
            box-shadow: 0 4px 20px rgba(155, 93, 229, 0.4);
        }

        /* Screens */
        .screen {
            display: none;
            animation: fadeIn 0.5s ease-out;
        }

        .screen.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Welcome Screen */
        .welcome-container {
            text-align: center;
            padding: 3rem;
        }

        .welcome-illustration {
            width: 200px;
            height: 200px;
            margin: 0 auto 2rem;
            background: linear-gradient(135deg, var(--accent-purple) 0%, var(--accent-blue) 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 5rem;
            animation: pulse 3s infinite ease-in-out;
            box-shadow: 0 0 60px rgba(155, 93, 229, 0.5);
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); box-shadow: 0 0 60px rgba(155, 93, 229, 0.5); }
            50% { transform: scale(1.05); box-shadow: 0 0 80px rgba(155, 93, 229, 0.7); }
        }

        .welcome-text {
            font-size: 1.4rem;
            line-height: 1.8;
            max-width: 600px;
            margin: 0 auto 2rem;
            color: var(--text-light);
        }

        .start-btn {
            background: linear-gradient(135deg, var(--accent-gold) 0%, var(--accent-warm) 100%);
            border: none;
            border-radius: 3rem;
            padding: 1.2rem 3rem;
            font-family: 'Fredoka', sans-serif;
            font-size: 1.4rem;
            font-weight: 500;
            color: #1a1a2e;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 30px rgba(255, 107, 107, 0.4);
        }

        .start-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 40px rgba(255, 107, 107, 0.6);
        }

        /* Play Screen */
        .play-container {
            display: grid;
            grid-template-columns: 1fr;
            gap: 2rem;
        }

        /* Visualization Canvas */
        .visualization-area {
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: 2rem;
            padding: 2rem;
            min-height: 300px;
            position: relative;
            overflow: hidden;
        }

        .visualization-canvas {
            width: 100%;
            height: 250px;
            border-radius: 1rem;
        }

        .mood-label {
            position: absolute;
            top: 1rem;
            left: 1.5rem;
            font-family: 'Fredoka', sans-serif;
            font-size: 1.2rem;
            color: var(--accent-gold);
        }

        /* Controls */
        .controls-area {
            display: flex;
            justify-content: center;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .control-btn {
            background: var(--card-bg);
            border: 2px solid var(--card-border);
            border-radius: 50%;
            width: 70px;
            height: 70px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .control-btn:hover {
            transform: scale(1.1);
            border-color: var(--accent-purple);
        }

        .control-btn.recording {
            background: var(--accent-warm);
            border-color: var(--accent-warm);
            animation: recordPulse 1s infinite;
        }

        @keyframes recordPulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(255, 107, 107, 0.4); }
            50% { box-shadow: 0 0 0 15px rgba(255, 107, 107, 0); }
        }

        .control-btn.listening {
            background: var(--accent-teal);
            border-color: var(--accent-teal);
        }

        /* Detected Notes Display */
        .notes-display {
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: 1.5rem;
            padding: 1.5rem;
            text-align: center;
        }

        .notes-label {
            font-size: 0.9rem;
            color: var(--text-muted);
            margin-bottom: 0.5rem;
        }

        .detected-note {
            font-family: 'Fredoka', sans-serif;
            font-size: 3rem;
            font-weight: 600;
            color: var(--accent-gold);
            min-height: 4rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .note-history {
            display: flex;
            justify-content: center;
            gap: 0.5rem;
            margin-top: 1rem;
            flex-wrap: wrap;
        }

        .note-bubble {
            background: linear-gradient(135deg, var(--accent-purple), var(--accent-blue));
            border-radius: 1rem;
            padding: 0.5rem 1rem;
            font-family: 'Fredoka', sans-serif;
            font-size: 1rem;
            animation: popIn 0.3s ease-out;
        }

        @keyframes popIn {
            from { transform: scale(0); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        /* Klangwelten (Sound Worlds) */
        .worlds-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
        }

        .world-card {
            background: var(--card-bg);
            border: 2px solid var(--card-border);
            border-radius: 1.5rem;
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .world-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .world-card:hover {
            transform: translateY(-5px);
            border-color: var(--accent-purple);
        }

        .world-card:hover::before {
            opacity: 0.1;
        }

        .world-card.mysterious { --world-color: #9b5de5; }
        .world-card.mysterious::before { background: var(--world-color); }
        .world-card.joyful { --world-color: #ffd93d; }
        .world-card.joyful::before { background: var(--world-color); }
        .world-card.dreamy { --world-color: #4d96ff; }
        .world-card.dreamy::before { background: var(--world-color); }
        .world-card.exciting { --world-color: #ff6b6b; }
        .world-card.exciting::before { background: var(--world-color); }
        .world-card.calm { --world-color: #6bcb77; }
        .world-card.calm::before { background: var(--world-color); }

        .world-card.active {
            border-color: var(--world-color);
            box-shadow: 0 0 30px rgba(155, 93, 229, 0.3);
        }

        .world-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }

        .world-name {
            font-family: 'Fredoka', sans-serif;
            font-size: 1.4rem;
            font-weight: 500;
            margin-bottom: 0.5rem;
        }

        .world-desc {
            font-size: 0.95rem;
            color: var(--text-muted);
            line-height: 1.5;
        }

        /* Klangtagebuch (Sound Diary) */
        .diary-container {
            max-width: 800px;
            margin: 0 auto;
        }

        .diary-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        .diary-title {
            font-family: 'Fredoka', sans-serif;
            font-size: 2rem;
            font-weight: 500;
        }

        .diary-stats {
            display: flex;
            gap: 2rem;
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-family: 'Fredoka', sans-serif;
            font-size: 2rem;
            font-weight: 600;
            color: var(--accent-gold);
        }

        .stat-label {
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        .diary-entries {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .diary-entry {
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: 1.5rem;
            padding: 1.5rem;
            display: flex;
            align-items: center;
            gap: 1.5rem;
            transition: all 0.3s ease;
        }

        .diary-entry:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateX(5px);
        }

        .entry-emoji {
            font-size: 2.5rem;
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--card-bg);
            border-radius: 1rem;
        }

        .entry-info {
            flex: 1;
        }

        .entry-date {
            font-size: 0.85rem;
            color: var(--text-muted);
            margin-bottom: 0.3rem;
        }

        .entry-title {
            font-family: 'Fredoka', sans-serif;
            font-size: 1.2rem;
            font-weight: 500;
        }

        .entry-duration {
            font-size: 0.85rem;
            color: var(--accent-teal);
            margin-top: 0.3rem;
        }

        .entry-play {
            background: linear-gradient(135deg, var(--accent-purple), var(--accent-blue));
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .entry-play:hover {
            transform: scale(1.1);
        }

        .empty-diary {
            text-align: center;
            padding: 4rem 2rem;
            color: var(--text-muted);
        }

        .empty-diary-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        /* Garden Progress */
        .garden-container {
            text-align: center;
            padding: 2rem;
        }

        .garden-title {
            font-family: 'Fredoka', sans-serif;
            font-size: 2rem;
            font-weight: 500;
            margin-bottom: 1rem;
        }

        .garden-subtitle {
            color: var(--text-muted);
            margin-bottom: 2rem;
        }

        .garden-visual {
            background: linear-gradient(180deg, #1a1a2e 0%, #2d4a3e 100%);
            border-radius: 2rem;
            padding: 3rem;
            min-height: 300px;
            position: relative;
            overflow: hidden;
        }

        .garden-ground {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 60px;
            background: linear-gradient(180deg, #3d5a4a 0%, #2d4a3e 100%);
            border-radius: 0 0 2rem 2rem;
        }

        .plant {
            position: absolute;
            bottom: 50px;
            font-size: 3rem;
            animation: sway 3s infinite ease-in-out;
        }

        @keyframes sway {
            0%, 100% { transform: rotate(-5deg); }
            50% { transform: rotate(5deg); }
        }

        .garden-message {
            position: relative;
            z-index: 1;
            font-family: 'Fredoka', sans-serif;
            font-size: 1.2rem;
            color: var(--accent-gold);
        }

        /* Prompt Cards */
        .prompt-card {
            background: linear-gradient(135deg, rgba(155, 93, 229, 0.2), rgba(77, 150, 255, 0.2));
            border: 1px solid var(--accent-purple);
            border-radius: 1.5rem;
            padding: 2rem;
            text-align: center;
            margin-bottom: 2rem;
        }

        .prompt-label {
            font-size: 0.9rem;
            color: var(--accent-purple);
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .prompt-text {
            font-family: 'Fredoka', sans-serif;
            font-size: 1.6rem;
            font-weight: 500;
            line-height: 1.4;
        }

        .prompt-refresh {
            background: transparent;
            border: 1px solid var(--card-border);
            border-radius: 2rem;
            padding: 0.5rem 1.5rem;
            color: var(--text-muted);
            font-family: 'Nunito', sans-serif;
            cursor: pointer;
            margin-top: 1rem;
            transition: all 0.3s ease;
        }

        .prompt-refresh:hover {
            border-color: var(--accent-purple);
            color: var(--text-light);
        }

        /* Microphone Permission Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background: var(--bg-gradient-start);
            border: 1px solid var(--card-border);
            border-radius: 2rem;
            padding: 3rem;
            max-width: 500px;
            text-align: center;
            transform: scale(0.9);
            transition: transform 0.3s ease;
        }

        .modal-overlay.active .modal-content {
            transform: scale(1);
        }

        .modal-icon {
            font-size: 4rem;
            margin-bottom: 1.5rem;
        }

        .modal-title {
            font-family: 'Fredoka', sans-serif;
            font-size: 1.8rem;
            margin-bottom: 1rem;
        }

        .modal-text {
            color: var(--text-muted);
            margin-bottom: 2rem;
            line-height: 1.6;
        }

        .modal-btn {
            background: linear-gradient(135deg, var(--accent-teal), var(--accent-blue));
            border: none;
            border-radius: 2rem;
            padding: 1rem 2.5rem;
            font-family: 'Fredoka', sans-serif;
            font-size: 1.1rem;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .modal-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(107, 203, 119, 0.4);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .app-container {
                padding: 1rem;
            }

            .logo {
                font-size: 2.5rem;
            }

            .nav-tab {
                padding: 0.6rem 1rem;
                font-size: 0.9rem;
            }

            .worlds-grid {
                grid-template-columns: 1fr;
            }

            .diary-header {
                flex-direction: column;
                gap: 1rem;
            }
        }

        @media (prefers-reduced-motion: reduce) {
            * {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }

            .bg-particles {
                display: none;
            }
        }
    </style>
</head>
<body>
    <!-- Background particles -->
    <div class="bg-particles" id="particles"></div>

    <div class="app-container">
        <!-- Header -->
        <header class="header">
            <h1 class="logo">üéπ KlangReise</h1>
            <p class="tagline">Entdecke die Magie der Musik</p>
        </header>

        <!-- Navigation -->
        <nav class="nav-tabs">
            <button class="nav-tab active" data-screen="welcome">Start</button>
            <button class="nav-tab" data-screen="play">Spielen</button>
            <button class="nav-tab" data-screen="worlds">Klangwelten</button>
            <button class="nav-tab" data-screen="diary">Klangtagebuch</button>
            <button class="nav-tab" data-screen="garden">Mein Garten</button>
        </nav>

        <!-- Welcome Screen -->
        <section class="screen active" id="welcome">
            <div class="welcome-container">
                <div class="welcome-illustration">üéµ</div>
                <p class="welcome-text">
                    Hallo, kleiner Klangentdecker! üåü<br><br>
                    Hier gibt es keine richtigen oder falschen T√∂ne ‚Äì nur <em>deine</em> Musik.
                    Stell dein Klavier bereit und lass uns zusammen herausfinden, 
                    welche Geschichten heute in deinen Fingern stecken!
                </p>
                <button class="start-btn" id="startBtn">Los geht's! ‚ú®</button>
            </div>
        </section>

        <!-- Play Screen -->
        <section class="screen" id="play">
            <!-- Daily Prompt -->
            <div class="prompt-card">
                <div class="prompt-label">Heute k√∂nntest du...</div>
                <div class="prompt-text" id="dailyPrompt">Spiel mal, wie sich ein Schmetterling anh√∂rt! ü¶ã</div>
                <button class="prompt-refresh" id="newPromptBtn">Andere Idee üé≤</button>
            </div>

            <div class="play-container">
                <!-- Visualization -->
                <div class="visualization-area">
                    <div class="mood-label" id="moodLabel">Frei spielen</div>
                    <canvas class="visualization-canvas" id="visualizer"></canvas>
                </div>

                <!-- Notes Display -->
                <div class="notes-display">
                    <div class="notes-label">Du spielst gerade:</div>
                    <div class="detected-note" id="currentNote">üéπ</div>
                    <div class="note-history" id="noteHistory"></div>
                </div>

                <!-- Controls -->
                <div class="controls-area">
                    <button class="control-btn" id="micBtn" title="Mikrofon starten">üé§</button>
                    <button class="control-btn" id="recordBtn" title="Aufnehmen">‚è∫Ô∏è</button>
                    <button class="control-btn" id="saveBtn" title="Speichern">üíæ</button>
                </div>
            </div>
        </section>

        <!-- Klangwelten Screen -->
        <section class="screen" id="worlds">
            <div class="worlds-grid">
                <div class="world-card mysterious" data-world="mysterious">
                    <div class="world-icon">üîÆ</div>
                    <div class="world-name">Geheimnisvoll</div>
                    <div class="world-desc">Die schwarzen Tasten erz√§hlen magische Geschichten...</div>
                </div>
                <div class="world-card joyful" data-world="joyful">
                    <div class="world-icon">‚òÄÔ∏è</div>
                    <div class="world-name">Fr√∂hlich</div>
                    <div class="world-desc">Lass die T√∂ne h√ºpfen und tanzen!</div>
                </div>
                <div class="world-card dreamy" data-world="dreamy">
                    <div class="world-icon">üåô</div>
                    <div class="world-name">Vertr√§umt</div>
                    <div class="world-desc">Sanfte Kl√§nge wie Wolken am Himmel...</div>
                </div>
                <div class="world-card exciting" data-world="exciting">
                    <div class="world-icon">‚ö°</div>
                    <div class="world-name">Aufregend</div>
                    <div class="world-desc">Schnell, laut, voller Energie!</div>
                </div>
                <div class="world-card calm" data-world="calm">
                    <div class="world-icon">üåø</div>
                    <div class="world-name">Ruhig</div>
                    <div class="world-desc">Wie ein stiller See im Wald...</div>
                </div>
            </div>
        </section>

        <!-- Diary Screen -->
        <section class="screen" id="diary">
            <div class="diary-container">
                <div class="diary-header">
                    <h2 class="diary-title">üìî Mein Klangtagebuch</h2>
                    <div class="diary-stats">
                        <div class="stat-item">
                            <div class="stat-value" id="totalRecordings">0</div>
                            <div class="stat-label">Aufnahmen</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="totalMinutes">0</div>
                            <div class="stat-label">Minuten</div>
                        </div>
                    </div>
                </div>
                <div class="diary-entries" id="diaryEntries">
                    <div class="empty-diary">
                        <div class="empty-diary-icon">üéµ</div>
                        <p>Noch keine Aufnahmen ‚Äì deine erste Klanggeschichte wartet auf dich!</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- Garden Screen -->
        <section class="screen" id="garden">
            <div class="garden-container">
                <h2 class="garden-title">üå± Mein Klanggarten</h2>
                <p class="garden-subtitle">Jede Entdeckung l√§sst etwas wachsen...</p>
                <div class="garden-visual" id="gardenVisual">
                    <div class="garden-message">Spiele und entdecke, um deinen Garten wachsen zu lassen!</div>
                    <div class="garden-ground"></div>
                </div>
            </div>
        </section>
    </div>

    <!-- Microphone Permission Modal -->
    <div class="modal-overlay" id="micModal">
        <div class="modal-content">
            <div class="modal-icon">üé§</div>
            <h3 class="modal-title">Darf ich zuh√∂ren?</h3>
            <p class="modal-text">
                Damit ich h√∂ren kann, was du spielst, brauche ich Zugriff auf dein Mikrofon. 
                Keine Sorge ‚Äì ich speichere nichts ohne deine Erlaubnis!
            </p>
            <button class="modal-btn" id="allowMicBtn">Ja, h√∂r zu! üëÇ</button>
        </div>
    </div>

    <script>
        // ==================== APP STATE ====================
        const state = {
            isListening: false,
            isRecording: false,
            currentWorld: null,
            audioContext: null,
            analyser: null,
            microphone: null,
            recordings: JSON.parse(localStorage.getItem('klangreise_recordings') || '[]'),
            gardenProgress: parseInt(localStorage.getItem('klangreise_garden') || '0'),
            noteHistory: [],
            recordedChunks: [],
            mediaRecorder: null,
            recordingStart: null,
            recordingStop: null
        };

        const VISUALIZATION_FPS = 30;
        const NOTE_DETECT_MS = 60;
        const GARDEN_SAVE_MS = 1000;
        const reduceMotionQuery = window.matchMedia('(prefers-reduced-motion: reduce)');

        let gardenSaveTimeout = null;
        let visualizerStarted = false;
        let activeAudio = null;

        // ==================== PROMPTS ====================
        const prompts = [
            "Spiel mal, wie sich ein Schmetterling anh√∂rt! ü¶ã",
            "Wie klingt es, wenn es regnet? üåßÔ∏è",
            "Kannst du einen Elefanten spielen? üêò",
            "Wie h√∂rt sich dein Lieblingstier an?",
            "Spiel mal ganz leise... und dann ganz laut!",
            "Wie klingt ein Sonnenaufgang? ‚òÄÔ∏è",
            "Kannst du Fr√∂hlichkeit spielen?",
            "Wie h√∂rt sich Nebel an? üå´Ô∏è",
            "Spiel mal nur mit einem Finger!",
            "Wie klingt ein springender Ball?",
            "Kannst du eine Wolke spielen? ‚òÅÔ∏è",
            "Wie h√∂rt sich Aufregung an?",
            "Spiel mal, wie du dich gerade f√ºhlst!",
            "Wie klingt ein Geheimnis? ü§´",
            "Kannst du eine Geschichte ohne Worte erz√§hlen?"
        ];

        // ==================== NOTE DETECTION ====================
        const noteStrings = ["C", "C#", "D", "D#", "E", "F", "F#", "G", "G#", "A", "A#", "B"];
        
        function frequencyToNote(frequency) {
            if (frequency < 20 || frequency > 5000) return null;
            const noteNum = 12 * (Math.log(frequency / 440) / Math.log(2));
            const note = Math.round(noteNum) + 69;
            const octave = Math.floor(note / 12) - 1;
            const noteName = noteStrings[note % 12];
            return { name: noteName, octave: octave, full: `${noteName}${octave}` };
        }

        function autoCorrelate(buffer, sampleRate) {
            let SIZE = buffer.length;
            let sumOfSquares = 0;
            for (let i = 0; i < SIZE; i++) {
                const val = buffer[i];
                sumOfSquares += val * val;
            }
            const rootMeanSquare = Math.sqrt(sumOfSquares / SIZE);
            if (rootMeanSquare < 0.01) return -1;

            let r1 = 0, r2 = SIZE - 1;
            const threshold = 0.2;
            for (let i = 0; i < SIZE / 2; i++) {
                if (Math.abs(buffer[i]) < threshold) { r1 = i; break; }
            }
            for (let i = 1; i < SIZE / 2; i++) {
                if (Math.abs(buffer[SIZE - i]) < threshold) { r2 = SIZE - i; break; }
            }

            buffer = buffer.slice(r1, r2);
            SIZE = buffer.length;

            const c = new Array(SIZE).fill(0);
            for (let i = 0; i < SIZE; i++) {
                for (let j = 0; j < SIZE - i; j++) {
                    c[i] += buffer[j] * buffer[j + i];
                }
            }

            let d = 0;
            while (c[d] > c[d + 1]) d++;
            let maxval = -1, maxpos = -1;
            for (let i = d; i < SIZE; i++) {
                if (c[i] > maxval) {
                    maxval = c[i];
                    maxpos = i;
                }
            }
            let T0 = maxpos;

            const x1 = c[T0 - 1], x2 = c[T0], x3 = c[T0 + 1];
            const a = (x1 + x3 - 2 * x2) / 2;
            const b = (x3 - x1) / 2;
            if (a) T0 -= b / (2 * a);

            return sampleRate / T0;
        }

        // ==================== AUDIO SETUP ====================
        async function setupAudio() {
            try {
                state.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });

                if (state.audioContext.state === 'suspended') {
                    await state.audioContext.resume();
                }
                
                state.microphone = state.audioContext.createMediaStreamSource(stream);
                state.analyser = state.audioContext.createAnalyser();
                state.analyser.fftSize = 2048;
                state.microphone.connect(state.analyser);

                // Setup MediaRecorder for recordings
                if (typeof MediaRecorder !== 'undefined') {
                    state.mediaRecorder = new MediaRecorder(stream);
                    state.mediaRecorder.ondataavailable = (e) => {
                        if (e.data.size > 0) state.recordedChunks.push(e.data);
                    };
                    state.mediaRecorder.onstop = saveRecording;
                } else {
                    state.mediaRecorder = null;
                    console.warn('MediaRecorder is not supported in this browser.');
                }

                return true;
            } catch (err) {
                console.error('Audio setup failed:', err);
                return false;
            }
        }

        // ==================== VISUALIZATION ====================
        function setupVisualization() {
            if (visualizerStarted) return;
            visualizerStarted = true;

            const canvas = document.getElementById('visualizer');
            const ctx = canvas.getContext('2d');
            const particles = [];
            const barCount = 64;
            const maxParticles = reduceMotionQuery.matches ? 0 : 120;
            const frameInterval = 1000 / (reduceMotionQuery.matches ? 12 : VISUALIZATION_FPS);
            let dataArray = null;
            let bufferLength = 0;
            let lastFrameTime = 0;

            function resize() {
                const dpr = window.devicePixelRatio || 1;
                const rect = canvas.getBoundingClientRect();
                canvas.width = Math.max(1, Math.floor(rect.width * dpr));
                canvas.height = Math.max(1, Math.floor(rect.height * dpr));
            }
            resize();
            window.addEventListener('resize', resize, { passive: true });

            function getAnalyzerData() {
                if (!state.analyser) return null;
                if (!dataArray || bufferLength !== state.analyser.frequencyBinCount) {
                    bufferLength = state.analyser.frequencyBinCount;
                    dataArray = new Uint8Array(bufferLength);
                }
                state.analyser.getByteFrequencyData(dataArray);
                return dataArray;
            }

            function animate(now) {
                requestAnimationFrame(animate);
                if (document.hidden) return;
                if (now - lastFrameTime < frameInterval) return;
                lastFrameTime = now;

                ctx.fillStyle = 'rgba(26, 26, 46, 0.1)';
                ctx.fillRect(0, 0, canvas.width, canvas.height);

                if (state.isListening && state.analyser) {
                    const data = getAnalyzerData();
                    if (data) {
                        let sum = 0;
                        for (let i = 0; i < bufferLength; i++) {
                            sum += data[i];
                        }
                        const average = sum / bufferLength;
                        
                        if (average > 20 && particles.length < maxParticles) {
                            particles.push({
                                x: canvas.width / 2 + (Math.random() - 0.5) * 200,
                                y: canvas.height / 2,
                                vx: (Math.random() - 0.5) * 10,
                                vy: (Math.random() - 0.5) * 10 - 5,
                                radius: Math.random() * 20 + 5,
                                color: getWorldColor(),
                                life: 1
                            });
                        }

                        const barWidth = canvas.width / barCount;
                        const step = Math.max(1, Math.floor(bufferLength / barCount));
                        for (let i = 0; i < barCount; i++) {
                            const barHeight = data[i * step] * 1.5;
                            const hue = (i * 4) + (state.currentWorld ? getWorldHue() : 260);
                            ctx.fillStyle = `hsla(${hue}, 80%, 60%, 0.6)`;
                            ctx.fillRect(
                                i * barWidth,
                                canvas.height - barHeight,
                                barWidth - 2,
                                barHeight
                            );
                        }
                    }
                }

                for (let i = particles.length - 1; i >= 0; i--) {
                    const p = particles[i];
                    p.x += p.vx;
                    p.y += p.vy;
                    p.vy += 0.1;
                    p.life -= 0.02;
                    
                    if (p.life <= 0) {
                        particles.splice(i, 1);
                        continue;
                    }

                    ctx.beginPath();
                    ctx.arc(p.x, p.y, p.radius * p.life, 0, Math.PI * 2);
                    ctx.fillStyle = p.color.replace('1)', `${p.life})`);
                    ctx.fill();
                }
            }
            requestAnimationFrame(animate);
        }

        function getWorldColor() {
            const colors = {
                mysterious: 'rgba(155, 93, 229, 1)',
                joyful: 'rgba(255, 217, 61, 1)',
                dreamy: 'rgba(77, 150, 255, 1)',
                exciting: 'rgba(255, 107, 107, 1)',
                calm: 'rgba(107, 203, 119, 1)'
            };
            return colors[state.currentWorld] || 'rgba(155, 93, 229, 1)';
        }

        function getWorldHue() {
            const hues = {
                mysterious: 270,
                joyful: 45,
                dreamy: 210,
                exciting: 0,
                calm: 140
            };
            return hues[state.currentWorld] || 260;
        }

        // ==================== NOTE DETECTION LOOP ====================
        function startNoteDetection() {
            if (!state.analyser) return;

            const bufferLength = state.analyser.fftSize;
            const buffer = new Float32Array(bufferLength);
            let lastDetectTime = 0;

            function detect(now) {
                if (!state.isListening) return;
                if (document.hidden) {
                    requestAnimationFrame(detect);
                    return;
                }
                if (now - lastDetectTime < NOTE_DETECT_MS) {
                    requestAnimationFrame(detect);
                    return;
                }
                lastDetectTime = now;
                
                state.analyser.getFloatTimeDomainData(buffer);
                const frequency = autoCorrelate(buffer, state.audioContext.sampleRate);
                
                if (frequency > 0) {
                    const note = frequencyToNote(frequency);
                    if (note) {
                        updateNoteDisplay(note);
                    }
                }
                
                requestAnimationFrame(detect);
            }
            requestAnimationFrame(detect);
        }

        function updateNoteDisplay(note) {
            const noteEl = document.getElementById('currentNote');
            const historyEl = document.getElementById('noteHistory');
            
            noteEl.textContent = note.full;
            noteEl.style.color = getWorldColor();

            // Add to history (avoid duplicates)
            if (state.noteHistory.length === 0 || 
                state.noteHistory[state.noteHistory.length - 1] !== note.full) {
                state.noteHistory.push(note.full);
                if (state.noteHistory.length > 8) state.noteHistory.shift();
                
                historyEl.innerHTML = state.noteHistory
                    .map(n => `<span class="note-bubble">${n}</span>`)
                    .join('');

                // Grow garden
                state.gardenProgress++;
                scheduleGardenSave();
            }
        }

        function scheduleGardenSave() {
            if (gardenSaveTimeout) return;
            gardenSaveTimeout = setTimeout(() => {
                localStorage.setItem('klangreise_garden', state.gardenProgress);
                gardenSaveTimeout = null;
            }, GARDEN_SAVE_MS);
        }

        // ==================== RECORDING ====================
        function toggleRecording() {
            const btn = document.getElementById('recordBtn');
            
            if (!state.mediaRecorder) {
                alert('Aufnahmen werden in diesem Browser nicht unterst√ºtzt.');
                return;
            }
            
            if (!state.isRecording) {
                state.recordedChunks = [];
                state.recordingStart = performance.now();
                state.recordingStop = null;
                state.mediaRecorder.start();
                state.isRecording = true;
                btn.classList.add('recording');
                btn.textContent = '‚èπÔ∏è';
            } else {
                state.recordingStop = performance.now();
                state.mediaRecorder.stop();
                state.isRecording = false;
                btn.classList.remove('recording');
                btn.textContent = '‚è∫Ô∏è';
            }
        }

        function saveRecording() {
            const blob = new Blob(state.recordedChunks, { type: 'audio/webm' });
            const url = URL.createObjectURL(blob);
            const durationMs = (state.recordingStart && state.recordingStop)
                ? (state.recordingStop - state.recordingStart)
                : null;
            const duration = durationMs
                ? Math.max(1, Math.round(durationMs / 1000))
                : Math.floor(state.recordedChunks.length / 2);
            
            const recording = {
                id: Date.now(),
                url: url,
                date: new Date().toLocaleDateString('de-DE'),
                time: new Date().toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' }),
                emoji: ['üéµ', 'üé∂', 'üéπ', '‚ú®', 'üåü', 'üí´', 'üéº'][Math.floor(Math.random() * 7)],
                world: state.currentWorld,
                duration: duration
            };
            
            state.recordings.unshift(recording);
            localStorage.setItem('klangreise_recordings', JSON.stringify(
                state.recordings.map(r => ({ ...r, url: null })) // Don't store blob URLs
            ));
            state.recordingStart = null;
            state.recordingStop = null;
            
            updateDiaryView();
            
            // Show feedback
            alert('üéâ Toll gemacht! Deine Aufnahme wurde im Klangtagebuch gespeichert!');
        }

        function playRecording(url) {
            if (!url) return;
            if (activeAudio) {
                activeAudio.pause();
                activeAudio.currentTime = 0;
            }
            const audio = new Audio(url);
            activeAudio = audio;
            audio.play();
            audio.addEventListener('ended', () => {
                if (activeAudio === audio) activeAudio = null;
            });
        }

        // ==================== UI UPDATES ====================
        function updateDiaryView() {
            const container = document.getElementById('diaryEntries');
            const totalEl = document.getElementById('totalRecordings');
            const minutesEl = document.getElementById('totalMinutes');
            
            totalEl.textContent = state.recordings.length;
            minutesEl.textContent = Math.floor(state.recordings.reduce((a, r) => a + (r.duration || 0), 0) / 60);
            
            if (state.recordings.length === 0) {
                container.innerHTML = `
                    <div class="empty-diary">
                        <div class="empty-diary-icon">üéµ</div>
                        <p>Noch keine Aufnahmen ‚Äì deine erste Klanggeschichte wartet auf dich!</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = state.recordings.map(r => `
                <div class="diary-entry">
                    <div class="entry-emoji">${r.emoji}</div>
                    <div class="entry-info">
                        <div class="entry-date">${r.date} um ${r.time}</div>
                        <div class="entry-title">${r.world ? 'Klangwelt: ' + r.world : 'Freies Spielen'}</div>
                        <div class="entry-duration">${r.duration || '?'} Sekunden</div>
                    </div>
                    ${r.url ? `<button class="entry-play" onclick="playRecording('${r.url}')">‚ñ∂Ô∏è</button>` : ''}
                </div>
            `).join('');
        }

        function updateGardenView() {
            const garden = document.getElementById('gardenVisual');
            const progress = state.gardenProgress;
            
            // Add plants based on progress
            const plants = ['üå±', 'üåø', 'üå∏', 'üå∫', 'üåª', 'üå∑', 'üåπ', 'ü™ª', 'üåº', 'üíê'];
            const trees = ['üå≤', 'üå≥', 'üå¥'];
            
            let plantsHTML = '';
            const numPlants = Math.min(Math.floor(progress / 10), 15);
            
            for (let i = 0; i < numPlants; i++) {
                const plant = progress > 100 && i < 3 ? trees[i % 3] : plants[i % plants.length];
                const left = 10 + (i * 6) + (Math.random() * 3);
                const delay = i * 0.2;
                plantsHTML += `<div class="plant" style="left: ${left}%; animation-delay: ${delay}s;">${plant}</div>`;
            }
            
            const message = progress < 10 
                ? 'Spiele und entdecke, um deinen Garten wachsen zu lassen!'
                : progress < 50 
                    ? 'Dein Garten beginnt zu wachsen! üå±'
                    : progress < 100 
                        ? 'Wunderbar! So viele sch√∂ne Pflanzen! üå∏'
                        : 'Wow! Dein Garten ist ein Paradies! üå≥‚ú®';
            
            garden.innerHTML = `
                <div class="garden-message">${message}</div>
                ${plantsHTML}
                <div class="garden-ground"></div>
            `;
        }

        // ==================== EVENT HANDLERS ====================
        document.querySelectorAll('.nav-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
                
                tab.classList.add('active');
                document.getElementById(tab.dataset.screen).classList.add('active');
                
                if (tab.dataset.screen === 'garden') updateGardenView();
                if (tab.dataset.screen === 'diary') updateDiaryView();
            });
        });

        document.getElementById('startBtn').addEventListener('click', () => {
            document.querySelector('[data-screen="play"]').click();
            document.getElementById('micModal').classList.add('active');
        });

        document.getElementById('allowMicBtn').addEventListener('click', async () => {
            const success = await setupAudio();
            if (success) {
                document.getElementById('micModal').classList.remove('active');
                state.isListening = true;
                document.getElementById('micBtn').classList.add('listening');
                startNoteDetection();
                setupVisualization();
            }
        });

        document.getElementById('micBtn').addEventListener('click', async () => {
            if (!state.audioContext) {
                document.getElementById('micModal').classList.add('active');
                return;
            }
            
            state.isListening = !state.isListening;
            document.getElementById('micBtn').classList.toggle('listening', state.isListening);
            
            if (state.isListening) {
                startNoteDetection();
            }
        });

        document.getElementById('recordBtn').addEventListener('click', () => {
            if (!state.audioContext) {
                alert('Bitte aktiviere zuerst das Mikrofon! üé§');
                return;
            }
            toggleRecording();
        });

        document.getElementById('newPromptBtn').addEventListener('click', () => {
            const prompt = prompts[Math.floor(Math.random() * prompts.length)];
            document.getElementById('dailyPrompt').textContent = prompt;
        });

        document.querySelectorAll('.world-card').forEach(card => {
            card.addEventListener('click', () => {
                document.querySelectorAll('.world-card').forEach(c => c.classList.remove('active'));
                card.classList.add('active');
                state.currentWorld = card.dataset.world;
                document.getElementById('moodLabel').textContent = card.querySelector('.world-name').textContent;
                document.querySelector('[data-screen="play"]').click();
            });
        });

        // ==================== BACKGROUND PARTICLES ====================
        function createBackgroundParticles() {
            if (reduceMotionQuery.matches) return;
            const container = document.getElementById('particles');
            const colors = ['#9b5de5', '#4d96ff', '#6bcb77', '#ffd93d', '#ff6b6b'];
            const fragment = document.createDocumentFragment();
            
            for (let i = 0; i < 20; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                particle.style.width = `${Math.random() * 100 + 20}px`;
                particle.style.height = particle.style.width;
                particle.style.left = `${Math.random() * 100}%`;
                particle.style.top = `${Math.random() * 100}%`;
                particle.style.background = colors[Math.floor(Math.random() * colors.length)];
                particle.style.animationDelay = `${Math.random() * 20}s`;
                particle.style.animationDuration = `${Math.random() * 20 + 15}s`;
                fragment.appendChild(particle);
            }
            container.appendChild(fragment);
        }

        // ==================== INIT ====================
        window.addEventListener('beforeunload', () => {
            if (gardenSaveTimeout) {
                localStorage.setItem('klangreise_garden', state.gardenProgress);
                gardenSaveTimeout = null;
            }
        });

        createBackgroundParticles();
        updateDiaryView();
        
        // Random prompt on load
        document.getElementById('dailyPrompt').textContent = 
            prompts[Math.floor(Math.random() * prompts.length)];
    </script>
</body>
</html>
