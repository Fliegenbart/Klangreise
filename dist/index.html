<!doctype html><html lang="de"><head><meta charset="UTF-8"><meta content="width=device-width,initial-scale=1" name="viewport"><title>KlangReise ‚Äì Entdecke die Magie der Musik</title><meta content="#1a1a2e" name="theme-color"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="KlangReise" name="apple-mobile-web-app-title"><link href="manifest.json" rel="manifest"><link href="assets/images/icon-180.png" rel="apple-touch-icon"><link href="https://fonts.googleapis.com" rel="preconnect"><link href="https://fonts.gstatic.com" rel="preconnect" crossorigin><link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@300;400;500;600&family=Nunito:wght@400;600;700&display=swap" rel="stylesheet"><style>:root{--bg-gradient-start:#1a1a2e;--bg-gradient-end:#16213e;--accent-warm:#ff6b6b;--accent-gold:#ffd93d;--accent-teal:#6bcb77;--accent-blue:#4d96ff;--accent-purple:#9b5de5;--text-light:#f8f8f8;--text-muted:#a0a0b0;--card-bg:rgba(255, 255, 255, 0.08);--card-border:rgba(255, 255, 255, 0.12)}*{margin:0;padding:0;box-sizing:border-box}body{font-family:Nunito,sans-serif;background:linear-gradient(135deg,var(--bg-gradient-start) 0,var(--bg-gradient-end) 100%);min-height:100vh;color:var(--text-light);overflow-x:hidden}body.island-mode{background:linear-gradient(135deg,#0b1020 0,#0a1428 100%)}.bg-particles{position:fixed;top:0;left:0;width:100%;height:100%;pointer-events:none;overflow:hidden;z-index:0}body.island-mode .bg-particles{display:none}.particle{position:absolute;border-radius:50%;opacity:.3;animation:float 20s infinite ease-in-out}@keyframes float{0%,100%{transform:translateY(0) rotate(0)}50%{transform:translateY(-100px) rotate(180deg)}}.app-container{position:relative;z-index:1;max-width:1200px;margin:0 auto;padding:2rem}.header{text-align:center;margin-bottom:3rem;animation:fadeInDown .8s ease-out}@keyframes fadeInDown{from{opacity:0;transform:translateY(-30px)}to{opacity:1;transform:translateY(0)}}.logo{font-family:Fredoka,sans-serif;font-size:3.5rem;font-weight:600;background:linear-gradient(135deg,var(--accent-gold) 0,var(--accent-warm) 50%,var(--accent-purple) 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;margin-bottom:.5rem;letter-spacing:-1px}.tagline{font-size:1.2rem;color:var(--text-muted);font-weight:400}.nav-tabs{display:none}.nav-tab{background:var(--card-bg);border:1px solid var(--card-border);border-radius:2rem;padding:.8rem 1.5rem;font-family:Nunito,sans-serif;font-size:1rem;font-weight:600;color:var(--text-muted);cursor:pointer;transition:all .3s ease}.nav-tab:hover{background:rgba(255,255,255,.12);color:var(--text-light)}.nav-tab.active{background:linear-gradient(135deg,var(--accent-purple),var(--accent-blue));color:#fff;border-color:transparent;box-shadow:0 4px 20px rgba(155,93,229,.4)}.parent-btn{position:fixed;top:1.4rem;right:1.4rem;width:52px;height:52px;border-radius:999px;border:1px solid rgba(255,255,255,.18);background:rgba(255,255,255,.08);color:var(--text-light);font-size:1.4rem;cursor:pointer;z-index:20;display:flex;align-items:center;justify-content:center;transition:transform .2s ease,box-shadow .2s ease}.parent-btn.holding{transform:scale(.98);box-shadow:0 0 0 4px rgba(255,217,61,.25)}.parent-backdrop{position:fixed;inset:0;background:rgba(8,10,20,.55);backdrop-filter:blur(2px);opacity:0;pointer-events:none;transition:opacity .25s ease;z-index:18}.parent-backdrop.active{opacity:1;pointer-events:auto}.parent-drawer{position:fixed;top:0;right:0;height:100%;width:min(320px,90vw);background:rgba(16,20,40,.96);border-left:1px solid rgba(255,255,255,.12);transform:translateX(110%);transition:transform .25s ease;z-index:19;padding:1.6rem 1.4rem;display:flex;flex-direction:column;gap:1.2rem}.parent-drawer.open{transform:translateX(0)}.parent-drawer h3{font-family:Fredoka,sans-serif;font-size:1.3rem}.parent-drawer .nav-tabs{display:flex;flex-direction:column;gap:.6rem}.parent-close{align-self:flex-start;border:none;background:rgba(255,255,255,.08);color:var(--text-light);border-radius:999px;padding:.5rem .9rem;cursor:pointer}.screen{display:none;animation:fadeIn .5s ease-out}.screen.active{display:block}@keyframes fadeIn{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}.welcome-container{text-align:center;padding:3rem}.welcome-illustration{width:200px;height:200px;margin:0 auto 2rem;background:linear-gradient(135deg,var(--accent-purple) 0,var(--accent-blue) 100%);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:5rem;animation:pulse 3s infinite ease-in-out;box-shadow:0 0 60px rgba(155,93,229,.5)}@keyframes pulse{0%,100%{transform:scale(1);box-shadow:0 0 60px rgba(155,93,229,.5)}50%{transform:scale(1.05);box-shadow:0 0 80px rgba(155,93,229,.7)}}.welcome-text{font-size:1.4rem;line-height:1.8;max-width:600px;margin:0 auto 2rem;color:var(--text-light)}.start-btn{background:linear-gradient(135deg,var(--accent-gold) 0,var(--accent-warm) 100%);border:none;border-radius:3rem;padding:1.2rem 3rem;font-family:Fredoka,sans-serif;font-size:1.4rem;font-weight:500;color:#1a1a2e;cursor:pointer;transition:all .3s ease;box-shadow:0 4px 30px rgba(255,107,107,.4)}.start-btn:hover{transform:translateY(-3px);box-shadow:0 8px 40px rgba(255,107,107,.6)}.play-container{display:grid;grid-template-columns:1fr;gap:2rem}.visualization-area{background:var(--card-bg);border:1px solid var(--card-border);border-radius:2rem;padding:2rem;min-height:300px;position:relative;overflow:hidden}.visualization-canvas{width:100%;height:250px;border-radius:1rem}.mood-label{position:absolute;top:1rem;left:1.5rem;font-family:Fredoka,sans-serif;font-size:1.2rem;color:var(--accent-gold)}.controls-area{display:flex;justify-content:center;gap:1rem;flex-wrap:wrap}.control-btn{background:var(--card-bg);border:2px solid var(--card-border);border-radius:50%;width:70px;height:70px;display:flex;align-items:center;justify-content:center;font-size:1.8rem;cursor:pointer;transition:all .3s ease}.control-btn:hover{transform:scale(1.1);border-color:var(--accent-purple)}.control-btn.recording{background:var(--accent-warm);border-color:var(--accent-warm);animation:recordPulse 1s infinite}@keyframes recordPulse{0%,100%{box-shadow:0 0 0 0 rgba(255,107,107,.4)}50%{box-shadow:0 0 0 15px rgba(255,107,107,0)}}.control-btn.listening{background:var(--accent-teal);border-color:var(--accent-teal)}.notes-display{background:var(--card-bg);border:1px solid var(--card-border);border-radius:1.5rem;padding:1.5rem;text-align:center;display:none}.notes-label{font-size:.9rem;color:var(--text-muted);margin-bottom:.5rem}.detected-note{font-family:Fredoka,sans-serif;font-size:3rem;font-weight:600;color:var(--accent-gold);min-height:4rem;display:flex;align-items:center;justify-content:center}.note-history{display:flex;justify-content:center;gap:.5rem;margin-top:1rem;flex-wrap:wrap}.note-bubble{background:linear-gradient(135deg,var(--accent-purple),var(--accent-blue));border-radius:1rem;padding:.5rem 1rem;font-family:Fredoka,sans-serif;font-size:1rem;animation:popIn .3s ease-out}@keyframes popIn{from{transform:scale(0);opacity:0}to{transform:scale(1);opacity:1}}.worlds-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:1.5rem}.world-card{background:var(--card-bg);border:2px solid var(--card-border);border-radius:1.5rem;padding:2rem;text-align:center;cursor:pointer;transition:all .3s ease;position:relative;overflow:hidden}.world-card::before{content:'';position:absolute;top:0;left:0;right:0;bottom:0;opacity:0;transition:opacity .3s ease}.world-card:hover{transform:translateY(-5px);border-color:var(--accent-purple)}.world-card:hover::before{opacity:.1}.world-card.mysterious{--world-color:#9b5de5}.world-card.mysterious::before{background:var(--world-color)}.world-card.joyful{--world-color:#ffd93d}.world-card.joyful::before{background:var(--world-color)}.world-card.dreamy{--world-color:#4d96ff}.world-card.dreamy::before{background:var(--world-color)}.world-card.exciting{--world-color:#ff6b6b}.world-card.exciting::before{background:var(--world-color)}.world-card.calm{--world-color:#6bcb77}.world-card.calm::before{background:var(--world-color)}.world-card.active{border-color:var(--world-color);box-shadow:0 0 30px rgba(155,93,229,.3)}.world-icon{font-size:3rem;margin-bottom:1rem}.world-name{font-family:Fredoka,sans-serif;font-size:1.4rem;font-weight:500;margin-bottom:.5rem}.world-desc{font-size:.95rem;color:var(--text-muted);line-height:1.5}.diary-container{max-width:800px;margin:0 auto}.diary-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:2rem}.diary-title{font-family:Fredoka,sans-serif;font-size:2rem;font-weight:500}.diary-stats{display:flex;gap:2rem}.stat-item{text-align:center}.stat-value{font-family:Fredoka,sans-serif;font-size:2rem;font-weight:600;color:var(--accent-gold)}.stat-label{font-size:.85rem;color:var(--text-muted)}.diary-entries{display:flex;flex-direction:column;gap:1rem}.diary-entry{background:var(--card-bg);border:1px solid var(--card-border);border-radius:1.5rem;padding:1.5rem;display:flex;align-items:center;gap:1.5rem;transition:all .3s ease}.diary-entry:hover{background:rgba(255,255,255,.1);transform:translateX(5px)}.entry-emoji{font-size:2.5rem;width:60px;height:60px;display:flex;align-items:center;justify-content:center;background:var(--card-bg);border-radius:1rem}.entry-info{flex:1}.entry-date{font-size:.85rem;color:var(--text-muted);margin-bottom:.3rem}.entry-title{font-family:Fredoka,sans-serif;font-size:1.2rem;font-weight:500}.entry-duration{font-size:.85rem;color:var(--accent-teal);margin-top:.3rem}.entry-play{background:linear-gradient(135deg,var(--accent-purple),var(--accent-blue));border:none;border-radius:50%;width:50px;height:50px;display:flex;align-items:center;justify-content:center;font-size:1.2rem;cursor:pointer;transition:all .3s ease}.entry-play:hover{transform:scale(1.1)}.empty-diary{text-align:center;padding:4rem 2rem;color:var(--text-muted)}.empty-diary-icon{font-size:4rem;margin-bottom:1rem;opacity:.5}.garden-container{text-align:center;padding:2rem}.garden-title{font-family:Fredoka,sans-serif;font-size:2rem;font-weight:500;margin-bottom:1rem}.garden-subtitle{color:var(--text-muted);margin-bottom:2rem}.garden-visual{background:linear-gradient(180deg,#1a1a2e 0,#2d4a3e 100%);border-radius:2rem;padding:3rem;min-height:300px;position:relative;overflow:hidden}.garden-ground{position:absolute;bottom:0;left:0;right:0;height:60px;background:linear-gradient(180deg,#3d5a4a 0,#2d4a3e 100%);border-radius:0 0 2rem 2rem}.plant{position:absolute;bottom:50px;font-size:3rem;animation:sway 3s infinite ease-in-out}@keyframes sway{0%,100%{transform:rotate(-5deg)}50%{transform:rotate(5deg)}}.garden-message{position:relative;z-index:1;font-family:Fredoka,sans-serif;font-size:1.2rem;color:var(--accent-gold)}.prompt-card{background:linear-gradient(135deg,rgba(155,93,229,.2),rgba(77,150,255,.2));border:1px solid var(--accent-purple);border-radius:1.5rem;padding:2rem;text-align:center;margin-bottom:2rem}.prompt-label{font-size:.9rem;color:var(--accent-purple);margin-bottom:.5rem;text-transform:uppercase;letter-spacing:1px}.prompt-text{font-family:Fredoka,sans-serif;font-size:1.6rem;font-weight:500;line-height:1.4}.prompt-refresh{background:0 0;border:1px solid var(--card-border);border-radius:2rem;padding:.5rem 1.5rem;color:var(--text-muted);font-family:Nunito,sans-serif;cursor:pointer;margin-top:1rem;transition:all .3s ease}.prompt-refresh:hover{border-color:var(--accent-purple);color:var(--text-light)}.modal-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.8);display:flex;align-items:center;justify-content:center;z-index:1000;opacity:0;visibility:hidden;transition:all .3s ease}.modal-overlay.active{opacity:1;visibility:visible}.modal-content{background:var(--bg-gradient-start);border:1px solid var(--card-border);border-radius:2rem;padding:3rem;max-width:500px;text-align:center;transform:scale(.9);transition:transform .3s ease}.modal-overlay.active .modal-content{transform:scale(1)}.modal-icon{font-size:4rem;margin-bottom:1.5rem}.modal-title{font-family:Fredoka,sans-serif;font-size:1.8rem;margin-bottom:1rem}.modal-text{color:var(--text-muted);margin-bottom:2rem;line-height:1.6}.modal-btn{background:linear-gradient(135deg,var(--accent-teal),var(--accent-blue));border:none;border-radius:2rem;padding:1rem 2.5rem;font-family:Fredoka,sans-serif;font-size:1.1rem;color:#fff;cursor:pointer;transition:all .3s ease}.modal-btn:hover{transform:translateY(-2px);box-shadow:0 4px 20px rgba(107,203,119,.4)}.island-screen{padding:2rem 0 3rem}.island-map{position:relative;isolation:isolate;min-height:520px;border-radius:2.5rem;padding:2.5rem;background:radial-gradient(circle at 20% 20%,rgba(255,217,61,.25),rgba(26,26,46,.95)),radial-gradient(circle at 80% 30%,rgba(77,150,255,.18),transparent 55%),linear-gradient(160deg,rgba(22,33,62,.9),rgba(10,12,28,.98));border:1px solid rgba(255,255,255,.08);overflow:hidden;transition:transform .45s ease,filter .45s ease;transform-origin:var(--zoom-origin-x,50%) var(--zoom-origin-y,50%);will-change:transform}.island-map.zooming{transform:scale(1.06);filter:saturate(1.08) brightness(1.05)}.island-video{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;z-index:0;opacity:1;pointer-events:none}.island-map::after{content:'';position:absolute;inset:0;z-index:1;pointer-events:none;background:radial-gradient(circle at 20% 20%,rgba(255,217,61,.12),rgba(0,0,0,.45)),radial-gradient(circle at 80% 30%,rgba(77,150,255,.12),transparent 55%),linear-gradient(160deg,rgba(22,33,62,.38),rgba(6,8,20,.6))}.island-map[data-theme=night]{background:radial-gradient(circle at 20% 20%,rgba(77,150,255,.2),rgba(10,12,28,.98)),radial-gradient(circle at 80% 20%,rgba(155,93,229,.18),transparent 55%),linear-gradient(160deg,rgba(10,12,28,.95),rgba(6,8,20,.98))}.island-map[data-theme=sunrise]{background:radial-gradient(circle at 20% 20%,rgba(255,217,61,.4),rgba(26,26,46,.92)),radial-gradient(circle at 80% 30%,rgba(255,107,107,.25),transparent 55%),linear-gradient(160deg,rgba(22,33,62,.9),rgba(10,12,28,.95))}.island-map[data-theme=sunset]{background:radial-gradient(circle at 20% 20%,rgba(255,107,107,.35),rgba(26,26,46,.95)),radial-gradient(circle at 80% 30%,rgba(255,217,61,.2),transparent 55%),linear-gradient(160deg,rgba(22,33,62,.9),rgba(10,12,28,.98))}.island-glow{position:absolute;inset:-40% -40% auto auto;width:380px;height:380px;background:radial-gradient(circle,rgba(255,217,61,.15),transparent 70%);opacity:.35;pointer-events:none;z-index:2}.island-title{font-family:Fredoka,sans-serif;font-size:2rem;margin-bottom:.6rem}.island-subtitle{color:var(--text-muted);margin-bottom:1.5rem}.island-landmark{position:absolute;background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.15);border-radius:1.5rem;padding:.9rem 1.2rem;min-width:150px;text-align:center;cursor:pointer;transition:transform .2s ease,box-shadow .2s ease,border-color .2s ease;z-index:3}.island-landmark:hover{transform:translateY(-3px);border-color:rgba(255,255,255,.35);box-shadow:0 12px 24px rgba(0,0,0,.3)}.island-landmark.disabled{opacity:.45;cursor:not-allowed;transform:none;box-shadow:none}.island-landmark.disabled::after{content:'';position:absolute;inset:-6px;background:radial-gradient(circle,rgba(255,255,255,.25),rgba(10,12,26,.75));filter:blur(6px);opacity:.6;border-radius:1.8rem;pointer-events:none}.landmark-icon{font-size:2rem;margin-bottom:.2rem}.landmark-label{font-family:Fredoka,sans-serif;font-size:1rem}.landmark-badge{display:inline-flex;align-items:center;justify-content:center;margin-top:.4rem;font-size:.85rem;padding:.2rem .6rem;border-radius:999px;background:rgba(0,0,0,.35);color:var(--text-light)}.landmark-badge.mist{background:rgba(255,255,255,.18);color:rgba(255,255,255,.85)}.island-garden{position:absolute;left:50%;top:52%;transform:translate(-50%,-50%);background:rgba(255,255,255,.1);border:1px solid rgba(255,255,255,.16);border-radius:2rem;padding:1.2rem 1.4rem;text-align:center;min-width:180px;z-index:3}.island-garden .landmark-icon{font-size:2.4rem}.compass-btn{position:fixed;right:1.5rem;bottom:1.5rem;width:62px;height:62px;border-radius:50%;background:rgba(255,255,255,.12);border:1px solid rgba(255,255,255,.2);display:flex;align-items:center;justify-content:center;font-size:1.6rem;cursor:pointer;box-shadow:0 12px 24px rgba(0,0,0,.25);transition:transform .2s ease,box-shadow .2s ease,opacity .2s ease;z-index:20}.compass-btn:hover{transform:translateY(-2px);box-shadow:0 16px 30px rgba(0,0,0,.3)}.compass-btn.hidden{opacity:0;pointer-events:none}.module-tabs{display:flex;justify-content:center;gap:.5rem;margin:1.25rem 0 1.5rem;flex-wrap:wrap}.module-tab{background:rgba(255,255,255,.06);border:1px solid var(--card-border);border-radius:2rem;padding:.6rem 1.1rem;font-family:Nunito,sans-serif;font-size:.95rem;font-weight:700;color:var(--text-muted);cursor:pointer;transition:all .25s ease}.module-tab:hover{background:rgba(255,255,255,.1);color:var(--text-light)}.module-tab.active{background:linear-gradient(135deg,var(--accent-teal),var(--accent-blue));color:#fff;border-color:transparent;box-shadow:0 4px 18px rgba(77,150,255,.28)}.module-tab:disabled{opacity:.45;cursor:not-allowed}.module-screen{display:none;animation:fadeIn .45s ease-out}.module-screen.active{display:block}.echo-card{background:var(--card-bg);border:1px solid var(--card-border);border-radius:2rem;padding:2rem;overflow:hidden;position:relative}.echo-header{display:flex;align-items:flex-start;justify-content:space-between;gap:1rem;margin-bottom:1rem}.echo-title{font-family:Fredoka,sans-serif;font-size:1.8rem;font-weight:600;margin-bottom:.25rem}.echo-subtitle{color:var(--text-muted);line-height:1.5}.echo-progress{display:flex;gap:.45rem;margin-top:.35rem;flex-shrink:0}.echo-dot{width:12px;height:12px;border-radius:999px;background:rgba(255,255,255,.12);border:1px solid rgba(255,255,255,.16)}.echo-dot.filled{background:linear-gradient(135deg,var(--accent-gold),var(--accent-warm));border-color:rgba(255,255,255,.18);box-shadow:0 0 18px rgba(255,217,61,.25)}.echo-status{background:rgba(0,0,0,.18);border:1px solid rgba(255,255,255,.12);border-radius:1.2rem;padding:1rem 1.2rem;color:var(--text-light);line-height:1.6;margin:1rem 0 1.2rem;min-height:3.6rem}.echo-controls{display:flex;gap:.75rem;justify-content:center;flex-wrap:wrap;margin-bottom:1.5rem}.echo-btn{background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.14);border-radius:2rem;padding:.9rem 1.4rem;font-family:Fredoka,sans-serif;font-size:1.05rem;font-weight:500;color:var(--text-light);cursor:pointer;transition:transform .2s ease,box-shadow .2s ease,background .2s ease}.echo-btn:hover{transform:translateY(-1px);background:rgba(255,255,255,.12);box-shadow:0 8px 24px rgba(0,0,0,.22)}.echo-btn.primary{background:linear-gradient(135deg,var(--accent-gold),var(--accent-warm));border-color:transparent;color:#1a1a2e;box-shadow:0 8px 26px rgba(255,107,107,.25)}.echo-btn:disabled{opacity:.5;cursor:not-allowed;transform:none;box-shadow:none}.echo-piano-wrap{background:rgba(0,0,0,.16);border:1px solid rgba(255,255,255,.12);border-radius:1.5rem;padding:1.25rem}.echo-piano{position:relative;width:100%;max-width:820px;margin:0 auto;height:190px;user-select:none;touch-action:manipulation}.echo-white-keys{position:absolute;inset:0;display:flex;gap:6px;padding:6px}.echo-key{border-radius:14px;transition:transform .12s ease,box-shadow .12s ease,background .12s ease}.echo-key.white{flex:1;background:rgba(255,255,255,.92);border:1px solid rgba(0,0,0,.22);box-shadow:0 10px 26px rgba(0,0,0,.18)}.echo-key.black{position:absolute;top:6px;height:58%;background:rgba(15,16,28,.92);border:1px solid rgba(255,255,255,.12);box-shadow:0 10px 24px rgba(0,0,0,.35);border-radius:12px;z-index:2}.echo-key.playing{transform:translateY(-2px);box-shadow:0 0 0 4px rgba(255,217,61,.28),0 18px 38px rgba(0,0,0,.28)}.echo-key.playing.white{background:rgba(255,217,61,.95)}.echo-key.playing.black{background:rgba(255,107,107,.95)}.echo-key.heard{transform:translateY(-2px);box-shadow:0 0 0 4px rgba(107,203,119,.26),0 18px 38px rgba(0,0,0,.26)}.echo-key.heard.white{background:rgba(107,203,119,.92)}.echo-key.heard.black{background:rgba(107,203,119,.85)}.echo-key.target{box-shadow:0 0 0 3px rgba(255,217,61,.22),0 0 22px rgba(255,217,61,.25);animation:echoPulse 1.6s ease-in-out infinite}.echo-key.flash{box-shadow:0 0 0 4px rgba(255,107,107,.32),0 0 28px rgba(255,107,107,.38)}@keyframes echoPulse{0%,100%{transform:translateY(0)}50%{transform:translateY(-3px)}}.echo-magnet{position:absolute;width:16px;height:16px;border-radius:999px;background:radial-gradient(circle,rgba(107,203,119,.95),rgba(107,203,119,.2));box-shadow:0 0 18px rgba(107,203,119,.45);opacity:0;transform:translate(-9999px,-9999px);pointer-events:none;transition:transform .5s ease-out,opacity .3s ease-out;z-index:5}.echo-magnet.active{opacity:1}.echo-celebrate{position:absolute;inset:0;pointer-events:none;opacity:0;display:flex;align-items:center;justify-content:center;font-size:3rem;transform:scale(.98)}.echo-celebrate.active{animation:echoCelebrate 1.1s ease-out}@keyframes echoCelebrate{0%{opacity:0;transform:scale(.92)}12%{opacity:1;transform:scale(1.02)}100%{opacity:0;transform:scale(1.08)}}.chord-card{background:var(--card-bg);border:1px solid var(--card-border);border-radius:2rem;padding:2rem;position:relative;overflow:hidden}.chord-header{display:flex;align-items:flex-start;justify-content:space-between;gap:1rem;margin-bottom:1rem}.chord-title{font-family:Fredoka,sans-serif;font-size:1.8rem;font-weight:600;margin-bottom:.2rem}.chord-subtitle{color:var(--text-muted);line-height:1.5}.chord-status{background:rgba(0,0,0,.18);border:1px solid rgba(255,255,255,.12);border-radius:1.2rem;padding:1rem 1.2rem;color:var(--text-light);line-height:1.6;margin:1rem 0;min-height:3.4rem}.chord-prompt{display:flex;align-items:center;gap:.8rem;flex-wrap:wrap;margin:1rem 0 .6rem;font-size:1rem}.chord-notes{display:none;gap:.5rem;flex-wrap:wrap}.chord-note{background:rgba(255,255,255,.12);border:1px solid rgba(255,255,255,.18);border-radius:999px;padding:.35rem .75rem;font-family:Fredoka,sans-serif;font-size:1rem}.chord-controls{display:flex;gap:.75rem;justify-content:center;flex-wrap:wrap;margin:1.2rem 0}.chord-btn{background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.14);border-radius:2rem;padding:.9rem 1.4rem;font-family:Fredoka,sans-serif;font-size:1.05rem;font-weight:500;color:var(--text-light);cursor:pointer;transition:transform .2s ease,box-shadow .2s ease,background .2s ease}.chord-btn:hover{transform:translateY(-1px);background:rgba(255,255,255,.12);box-shadow:0 8px 24px rgba(0,0,0,.22)}.chord-btn.primary{background:linear-gradient(135deg,var(--accent-gold),var(--accent-warm));border-color:transparent;color:#1a1a2e}.chord-visual{position:relative;background:rgba(10,12,24,.35);border-radius:1.6rem;border:1px solid rgba(255,255,255,.08);min-height:140px;display:flex;align-items:center;justify-content:center;margin:1rem 0 1.4rem;overflow:hidden}.chord-aura{width:130px;height:130px;border-radius:999px;background:radial-gradient(circle,rgba(255,217,61,.78),rgba(255,217,61,.12));box-shadow:0 0 40px rgba(255,217,61,.35);opacity:.25;transform:scale(.9);transition:transform .25s ease,opacity .25s ease,filter .25s ease;z-index:2}.chord-particles{position:absolute;inset:0;pointer-events:none;opacity:0;transition:opacity .3s ease;z-index:1}.chord-visual.flutter .chord-particles{opacity:1;background:radial-gradient(circle,rgba(255,255,255,.7) 0 18%,transparent 20%),radial-gradient(circle,rgba(255,217,61,.55) 0 12%,transparent 18%),radial-gradient(circle,rgba(107,203,119,.55) 0 14%,transparent 20%);background-size:32px 32px,40px 40px,36px 36px;animation:flutterGlow 1.2s infinite ease-in-out}.chord-visual.deep .chord-particles{opacity:.85;background:radial-gradient(circle,rgba(77,150,255,.4) 0 22%,transparent 30%),radial-gradient(circle,rgba(10,12,26,.7) 0 35%,transparent 45%);background-size:80px 80px,120px 120px;animation:deepPulse 2.8s infinite ease-in-out}@keyframes flutterGlow{0%{transform:translateY(0) scale(1)}50%{transform:translateY(-6px) scale(1.03)}100%{transform:translateY(0) scale(1)}}@keyframes deepPulse{0%{transform:scale(.98)}50%{transform:scale(1.02)}100%{transform:scale(.98)}}.chord-visual.active .chord-aura{opacity:1;transform:scale(1.05)}.chord-emoji-grid{position:relative;width:200px;height:200px;margin:.8rem auto 0}.chord-emoji-btn{background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.16);border-radius:1rem;padding:.6rem .2rem;font-size:1.8rem;cursor:pointer;transition:transform .2s ease,box-shadow .2s ease;position:absolute;left:50%;top:50%;transform:rotate(var(--angle,0deg)) translateX(var(--ring-radius,70px)) rotate(calc(var(--angle,0deg) * -1))}.chord-emoji-btn:hover{transform:translateY(-2px);box-shadow:0 10px 22px rgba(0,0,0,.25)}.chord-emoji-btn.suggested{box-shadow:0 0 0 2px rgba(255,217,61,.45)}.chord-piano-wrap{background:rgba(0,0,0,.16);border:1px solid rgba(255,255,255,.12);border-radius:1.5rem;padding:1.25rem}.chord-piano{position:relative;width:100%;max-width:820px;margin:0 auto;height:180px;user-select:none}.chord-white-keys{position:absolute;inset:0;display:flex;gap:6px;padding:6px}.chord-key{border-radius:14px;transition:transform .12s ease,box-shadow .12s ease,background .12s ease,opacity .12s ease;opacity:.65}.chord-key.white{flex:1;background:rgba(255,255,255,.9);border:1px solid rgba(0,0,0,.2)}.chord-key.black{position:absolute;top:6px;height:58%;background:rgba(15,16,28,.9);border:1px solid rgba(255,255,255,.12);border-radius:12px;z-index:2;opacity:.5}.chord-key.target{opacity:1;box-shadow:0 0 0 3px rgba(255,217,61,.28)}.chord-key.playing{transform:translateY(-2px);box-shadow:0 0 0 4px rgba(107,203,119,.28),0 12px 28px rgba(0,0,0,.25)}.impro-card{background:var(--card-bg);border:1px solid var(--card-border);border-radius:2rem;padding:2rem;position:relative;overflow:hidden}.impro-header{display:flex;align-items:flex-start;justify-content:space-between;gap:1rem;margin-bottom:1.2rem}.impro-title{font-family:Fredoka,sans-serif;font-size:1.8rem;font-weight:600;margin-bottom:.2rem}.impro-subtitle{color:var(--text-muted);line-height:1.5}.impro-worlds{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:.8rem;margin-bottom:1.2rem}.impro-world{background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.14);border-radius:1.2rem;padding:1rem 1.1rem;cursor:pointer;transition:transform .2s ease,box-shadow .2s ease,border-color .2s ease}.impro-world strong{font-family:Fredoka,sans-serif;font-size:1.15rem;display:block;margin-bottom:.3rem}.impro-world span{color:var(--text-muted);font-size:.95rem;line-height:1.4}.impro-world.sun{--impro-color:#ffd93d}.impro-world.moon{--impro-color:#4d96ff}.impro-world.adventure{--impro-color:#9b5de5}.impro-world.active{border-color:var(--impro-color);box-shadow:0 12px 30px rgba(0,0,0,.25);transform:translateY(-2px)}.impro-status{background:rgba(0,0,0,.2);border:1px solid rgba(255,255,255,.12);border-radius:1.2rem;padding:1rem 1.2rem;min-height:3.4rem;line-height:1.6;margin-bottom:1.4rem}.impro-visual{position:relative;background:rgba(10,12,24,.35);border-radius:1.6rem;border:1px solid rgba(255,255,255,.08);min-height:160px;display:flex;align-items:center;justify-content:center;margin-bottom:1.4rem;overflow:hidden}.impro-aura{width:120px;height:120px;border-radius:999px;background:radial-gradient(circle,rgba(255,217,61,.75),rgba(255,217,61,.1));box-shadow:0 0 40px rgba(255,217,61,.35);opacity:.3;transform:scale(.9);transition:transform .25s ease,opacity .25s ease,filter .25s ease}.impro-visual.active .impro-aura{opacity:1;transform:scale(1.05)}.impro-visual.contrast .impro-aura{background:radial-gradient(circle,rgba(255,107,255,.85),rgba(255,107,255,.1));box-shadow:0 0 40px rgba(255,107,255,.4);filter:saturate(130%)}.impro-visual.soft .impro-aura{opacity:.15;transform:scale(.85)}.impro-piano-wrap{background:rgba(0,0,0,.16);border:1px solid rgba(255,255,255,.12);border-radius:1.5rem;padding:1.25rem}.impro-piano{position:relative;width:100%;max-width:820px;margin:0 auto;height:190px;user-select:none;--impro-color:#ffd93d;--impro-glow:rgba(255, 217, 61, 0.18)}.impro-white-keys{position:absolute;inset:0;display:flex;gap:6px;padding:6px}.impro-key{border-radius:14px;transition:transform .12s ease,box-shadow .12s ease,background .12s ease,opacity .12s ease;opacity:.5}.impro-key.allowed{opacity:1;box-shadow:0 0 0 2px var(--impro-glow)}.impro-key.white{flex:1;background:rgba(255,255,255,.85);border:1px solid rgba(0,0,0,.2)}.impro-key.black{position:absolute;top:6px;height:58%;background:rgba(15,16,28,.9);border:1px solid rgba(255,255,255,.12);border-radius:12px;z-index:2;opacity:.4}.impro-key.allowed.black{opacity:.9}.impro-key.playing{transform:translateY(-2px);box-shadow:0 0 0 4px rgba(107,203,119,.28),0 12px 28px rgba(0,0,0,.25)}.impro-key.playing.white{background:rgba(107,203,119,.92)}.impro-key.playing.black{background:rgba(107,203,119,.85)}.impro-key.contrast{box-shadow:0 0 0 4px rgba(255,107,255,.28),0 12px 28px rgba(0,0,0,.25)}.impro-controls{display:flex;flex-wrap:wrap;gap:.75rem;justify-content:center;margin-top:1.3rem}.impro-mix{display:flex;align-items:center;justify-content:center;gap:.8rem;margin-top:1.2rem;flex-wrap:wrap}.impro-slider{display:flex;align-items:center;gap:.6rem;font-size:.9rem;color:var(--text-muted)}.impro-slider input[type=range]{width:140px}.impro-loop-panel{margin-top:1.5rem;background:rgba(0,0,0,.18);border:1px solid rgba(255,255,255,.12);border-radius:1.2rem;padding:1rem 1.2rem}.impro-loop-status{font-size:.95rem;color:var(--text-light);margin-bottom:.8rem}.impro-loop-controls{display:flex;gap:.6rem;flex-wrap:wrap}.impro-btn{background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.14);border-radius:2rem;padding:.9rem 1.4rem;font-family:Fredoka,sans-serif;font-size:1.05rem;font-weight:500;color:var(--text-light);cursor:pointer;transition:transform .2s ease,box-shadow .2s ease,background .2s ease}.impro-btn:hover{transform:translateY(-1px);background:rgba(255,255,255,.12);box-shadow:0 8px 24px rgba(0,0,0,.22)}.impro-btn.primary{background:linear-gradient(135deg,var(--accent-gold),var(--accent-warm));border-color:transparent;color:#1a1a2e}@media (max-width:768px){.app-container{padding:1rem}.logo{font-size:2.5rem}.nav-tab{padding:.6rem 1rem;font-size:.9rem}.worlds-grid{grid-template-columns:1fr}.diary-header{flex-direction:column;gap:1rem}.echo-card{padding:1.4rem}.echo-piano{height:160px}.chord-card{padding:1.4rem}.chord-piano{height:150px}.impro-card{padding:1.4rem}.impro-piano{height:160px}.island-map{padding:1.6rem;min-height:460px}.island-landmark{min-width:130px}}@media (prefers-reduced-motion:reduce){*{animation-duration:0s!important;animation-iteration-count:1!important;transition-duration:0s!important}.bg-particles{display:none}.island-video{display:none}}</style></head><body><div class="bg-particles" id="particles"></div><div class="app-container"><header class="header"><h1 class="logo">üéπ KlangReise</h1><p class="tagline">Entdecke die Magie der Musik</p></header><section class="screen active island-screen" id="island"><div class="island-title">Deine Klang-Insel</div><div class="island-subtitle">Tippe ein Wahrzeichen an, um loszulegen.</div><div class="island-map" id="islandMap" data-theme="sunrise"><video autoplay class="island-video" id="islandVideo" loop muted playsinline preload="metadata"><source src="assets/video/island.mp4" type="video/mp4"></video><div class="island-glow"></div><button class="island-landmark" data-screen="play" data-landmark="echo" data-module="echo" style="left:8%;top:18%"><div class="landmark-icon">‚õ∞Ô∏è</div><div class="landmark-label">Echo-H√∂hlen</div><div class="landmark-badge" id="badgeEcho">Level 1</div></button> <button class="island-landmark" data-screen="play" data-landmark="chords" data-module="chords" style="right:10%;top:20%"><div class="landmark-icon">üíé</div><div class="landmark-label">Kristall-Lagune</div><div class="landmark-badge" id="badgeChords">Sch√§tze 0</div></button> <button class="island-landmark" data-screen="play" data-landmark="impro" data-module="impro" style="left:14%;bottom:16%"><div class="landmark-icon">üåæ</div><div class="landmark-label">Impro-Wiese</div><div class="landmark-badge" id="badgeImpro">Loops 0</div></button> <button class="island-landmark" data-screen="play" data-landmark="stories" data-module="stories" style="right:12%;bottom:18%" data-disabled="true" disabled="disabled"><div class="landmark-icon">üå≥</div><div class="landmark-label">Vorlese-Eiche</div><div class="landmark-badge mist">üå´Ô∏è</div></button> <button class="island-landmark" data-screen="play" data-landmark="feelings" data-module="feelings" style="left:52%;top:12%" data-disabled="true" disabled="disabled"><div class="landmark-icon">ü•ö</div><div class="landmark-label">Gef√ºhls-Nest</div><div class="landmark-badge mist">üå´Ô∏è</div></button> <button class="island-garden" id="islandGarden" data-screen="garden"><div class="landmark-icon">üåø</div><div class="landmark-label">Klanggarten</div><div class="landmark-badge" id="badgeGarden">Wachstum 0</div></button></div></section><section class="screen" id="welcome"><div class="welcome-container"><div class="welcome-illustration">üéµ</div><p class="welcome-text">Hallo, kleiner Klangentdecker! üåü<br><br>Hier gibt es keine richtigen oder falschen T√∂ne ‚Äì nur <em>deine</em> Musik. Stell dein Klavier bereit und lass uns zusammen herausfinden, welche Geschichten heute in deinen Fingern stecken!</p><button class="start-btn" id="startBtn">Los geht's! ‚ú®</button></div></section><section class="screen" id="play"><div class="prompt-card"><div class="prompt-label">Heute k√∂nntest du...</div><div class="prompt-text" id="dailyPrompt">Spiel mal, wie sich ein Schmetterling anh√∂rt! ü¶ã</div><button class="prompt-refresh" id="newPromptBtn">Andere Idee üé≤</button></div><div class="module-tabs" aria-label="Spielmodi"><button class="module-tab active" data-module="free">Frei</button> <button class="module-tab" data-module="echo">Echo</button> <button class="module-tab" data-module="chords">Akkorde</button> <button class="module-tab" data-module="stories" disabled="disabled">Geschichten</button> <button class="module-tab" data-module="impro">Impro</button> <button class="module-tab" data-module="feelings" disabled="disabled">Gef√ºhle</button></div><div class="active module-screen" id="module-free"><div class="play-container"><div class="visualization-area"><div class="mood-label" id="moodLabel">Frei spielen</div><canvas class="visualization-canvas" id="visualizer"></canvas></div><div class="controls-area"><button class="control-btn" id="micBtn" title="Mikrofon starten">üé§</button> <button class="control-btn" id="recordBtn" title="Aufnehmen">‚è∫Ô∏è</button> <button class="control-btn" id="saveBtn" title="Speichern">üíæ</button></div></div></div><div class="module-screen" id="module-echo"><div class="echo-card"><div class="echo-celebrate" id="echoCelebrate" aria-hidden="true">‚ú®</div><div class="echo-header"><div><div class="echo-title">Echo-Spiel</div><div class="echo-subtitle">Ich spiele vor. Du spielst nach Geh√∂r.</div></div><div class="echo-progress" id="echoProgress" aria-label="Reise-Fortschritt"></div></div><div class="echo-status" id="echoStatus">Tippe auf <strong>Vorh√∂ren</strong> und spiel dann nach. Wenn du willst, darf es auch ein bisschen daneben sein.</div><div class="echo-controls"><button class="echo-btn primary" id="echoPlayBtn">‚ñ∂Ô∏è Vorh√∂ren</button> <button class="echo-btn" id="echoReplayBtn" disabled="disabled">üîÅ Nochmal</button> <button class="echo-btn" id="echoNextBtn" disabled="disabled">‚ú® Weiter</button></div><div class="echo-piano-wrap"><div class="echo-piano" id="echoPiano" aria-label="Klaviatur (vereinfachte Anzeige)"></div></div></div></div><div class="module-screen" id="module-chords"><div class="chord-card"><div class="chord-header"><div><div class="chord-title">Kristall-Lagune</div><div class="chord-subtitle">Sp√ºre die Farbe deines Klangs.</div></div></div><div class="chord-status" id="chordStatus">Tippe auf üé§ und spiel. Ich h√∂re zu.</div><div class="chord-prompt"><span id="chordPromptText">ü¶ã Spiel mal, wie sich ein Schmetterling anh√∂rt.</span></div><div class="chord-controls"><button class="primary chord-btn" id="chordListenBtn">üé§ Zuh√∂ren</button> <button class="chord-btn" id="chordNextBtn">üé≤ Neue Idee</button></div><div class="chord-visual" id="chordVisual"><div class="chord-aura" id="chordAura"></div><div class="chord-particles" id="chordParticles"></div></div><div class="chord-piano-wrap"><div class="chord-piano" id="chordPiano" aria-label="Klaviatur (Akkorde)"></div></div><div class="chord-status" id="chordFeelingPrompt">üí´ Gef√ºhl w√§hlen</div><div class="chord-emoji-grid" id="chordEmojiGrid"></div></div></div><div class="module-screen" id="module-impro"><div class="impro-card"><div class="impro-header"><div><div class="impro-title">Impro-Spielplatz</div><div class="impro-subtitle">Hier gibt es keine falschen Noten. Spiel, wie es sich gut anf√ºhlt.</div></div></div><div class="impro-worlds" id="improWorlds"><div class="active impro-world sun" data-space="sun"><strong>‚òÄÔ∏è Sonnengarten</strong> <span>Leicht, hell, voller Schmetterlinge.</span></div><div class="impro-world moon" data-space="moon"><strong>üåô Mondsee</strong> <span>Tiefblau, ruhig, weit.</span></div><div class="impro-world adventure" data-space="adventure"><strong>üî• Abenteuer-Fels</strong> <span>Spannend, funkelnd, mutig.</span></div></div><div class="impro-status" id="improStatus">W√§hle eine Klangwiese und fang einfach an.</div><div class="impro-visual soft" id="improVisual"><div class="impro-aura" id="improAura"></div></div><div class="impro-piano-wrap"><div class="impro-piano" id="improPiano" aria-label="Klaviatur (safe-space)"></div></div><div class="impro-controls"><button class="impro-btn primary" id="improListenBtn">üé§ Zuh√∂ren</button> <button class="impro-btn" id="improResponseBtn">üå¨Ô∏è Antwort spielen</button></div><div class="impro-mix"><label class="impro-slider">Begleitung <input id="improBackingVolume" max="1" min="0" step="0.01" type="range" value="0.35"></label> <label class="impro-slider">Loop <input id="improLoopVolume" max="1" min="0" step="0.01" type="range" value="0.85"></label></div><div class="impro-loop-panel"><div class="impro-loop-status" id="improLoopStatus">Kein Loop aufgenommen.</div><div class="impro-loop-controls"><button class="impro-btn" id="improLoopBtn">üîÅ Loop aufnehmen</button> <button class="impro-btn" id="improLoopClearBtn">üßπ Loops l√∂schen</button></div></div></div></div></section><section class="screen" id="worlds"><div class="worlds-grid"><div class="world-card mysterious" data-world="mysterious"><div class="world-icon">üîÆ</div><div class="world-name">Geheimnisvoll</div><div class="world-desc">Die schwarzen Tasten erz√§hlen magische Geschichten...</div></div><div class="world-card joyful" data-world="joyful"><div class="world-icon">‚òÄÔ∏è</div><div class="world-name">Fr√∂hlich</div><div class="world-desc">Lass die T√∂ne h√ºpfen und tanzen!</div></div><div class="world-card dreamy" data-world="dreamy"><div class="world-icon">üåô</div><div class="world-name">Vertr√§umt</div><div class="world-desc">Sanfte Kl√§nge wie Wolken am Himmel...</div></div><div class="world-card exciting" data-world="exciting"><div class="world-icon">‚ö°</div><div class="world-name">Aufregend</div><div class="world-desc">Schnell, laut, voller Energie!</div></div><div class="world-card calm" data-world="calm"><div class="world-icon">üåø</div><div class="world-name">Ruhig</div><div class="world-desc">Wie ein stiller See im Wald...</div></div></div></section><section class="screen" id="diary"><div class="diary-container"><div class="diary-header"><h2 class="diary-title">üìî Mein Klangtagebuch</h2><div class="diary-stats"><div class="stat-item"><div class="stat-value" id="totalRecordings">0</div><div class="stat-label">Aufnahmen</div></div><div class="stat-item"><div class="stat-value" id="totalMinutes">0</div><div class="stat-label">Minuten</div></div></div></div><div class="diary-entries" id="diaryEntries"><div class="empty-diary"><div class="empty-diary-icon">üéµ</div><p>Noch keine Aufnahmen ‚Äì deine erste Klanggeschichte wartet auf dich!</p></div></div></div></section><section class="screen" id="garden"><div class="garden-container"><h2 class="garden-title">üå± Mein Klanggarten</h2><p class="garden-subtitle">Jede Entdeckung l√§sst etwas wachsen...</p><div class="garden-visual" id="gardenVisual"><div class="garden-message">Spiele und entdecke, um deinen Garten wachsen zu lassen!</div><div class="garden-ground"></div></div></div></section></div><button class="parent-btn" id="parentBtn" aria-label="Elternmen√º">‚òÄÔ∏è</button><div class="parent-backdrop" id="parentBackdrop"></div><aside aria-hidden="true" class="parent-drawer" id="parentDrawer"><h3>Elternbereich</h3><button class="parent-close" id="parentClose">Schlie√üen</button><nav class="nav-tabs"><button class="nav-tab active" data-screen="island">Insel</button> <button class="nav-tab" data-screen="welcome">Start</button> <button class="nav-tab" data-screen="play">Spielen</button> <button class="nav-tab" data-screen="worlds">Klangwelten</button> <button class="nav-tab" data-screen="diary">Klangtagebuch</button> <button class="nav-tab" data-screen="garden">Mein Garten</button></nav></aside><button class="compass-btn hidden" id="compassBtn" aria-label="Zur Insel">üß≠</button><div class="modal-overlay" id="micModal"><div class="modal-content"><div class="modal-icon">üé§</div><h3 class="modal-title">Darf ich zuh√∂ren?</h3><p class="modal-text">Damit ich h√∂ren kann, was du spielst, brauche ich Zugriff auf dein Mikrofon. Keine Sorge ‚Äì ich speichere nichts ohne deine Erlaubnis!</p><button class="modal-btn" id="allowMicBtn">Ja, h√∂r zu! üëÇ</button></div></div><script>function safeJsonParse(value,fallback){try{return JSON.parse(value)}catch(_){return fallback}}function clampNumber(value,min,max){return Math.min(max,Math.max(min,value))}function loadEchoProgress(){const fallback={level:1},parsed=safeJsonParse(localStorage.getItem("klangreise_echo")||"null",null);if(!parsed||"object"!=typeof parsed)return fallback;return{level:clampNumber("number"==typeof parsed.level?parsed.level:fallback.level,1,5)}}function saveEchoProgress(progress){try{localStorage.setItem("klangreise_echo",JSON.stringify(progress))}catch(err){console.warn("Could not save echo progress:",err)}}function loadImproPrefs(){const fallback={space:"sun",backingVolume:.35,loopVolume:.85},parsed=safeJsonParse(localStorage.getItem("klangreise_impro")||"null",null);return parsed&&"object"==typeof parsed?"string"!=typeof parsed.space?fallback:{space:parsed.space,backingVolume:"number"==typeof parsed.backingVolume?parsed.backingVolume:fallback.backingVolume,loopVolume:"number"==typeof parsed.loopVolume?parsed.loopVolume:fallback.loopVolume}:fallback}function saveImproPrefs(prefs){try{localStorage.setItem("klangreise_impro",JSON.stringify(prefs))}catch(err){console.warn("Could not save impro prefs:",err)}}const defaultAppState={user:{ageGroup:"entdecker",currentIslandTheme:"sunrise",lastVisit:Date.now(),introSeen:!1},garden:{unlockedPlants:[],growthPoints:0},progress:{echoCave:{currentLevel:1,completed:0},chordLagoon:{discoveredEmotions:[],totalChords:0},storyTree:{completedStories:[]},improMeadow:{loopsRecorded:0,sessions:0},feelingsNest:{used:0}},session:{activeScreen:"island",activeModule:"free",audioContextStarted:!1}};function deepMerge(target,source){return source&&"object"==typeof source?(Object.keys(source).forEach(key=>{const value=source[key];value&&"object"==typeof value&&!Array.isArray(value)?(target[key]&&"object"==typeof target[key]||(target[key]={}),deepMerge(target[key],value)):target[key]=value}),target):target}function loadAppState(){const fallback=JSON.parse(JSON.stringify(defaultAppState)),parsed=safeJsonParse(localStorage.getItem("klangreise_state")||"null",null);return parsed&&"object"==typeof parsed?deepMerge(fallback,parsed):fallback}function saveAppState(){try{localStorage.setItem("klangreise_state",JSON.stringify(appState))}catch(err){console.warn("Could not save app state:",err)}}const appState=loadAppState(),state={isListening:!1,isRecording:!1,currentWorld:null,currentModule:appState.session.activeModule||"free",audioContext:null,analyser:null,microphone:null,mediaStream:null,recordings:JSON.parse(localStorage.getItem("klangreise_recordings")||"[]"),gardenProgress:Math.max(parseInt(localStorage.getItem("klangreise_garden")||"0"),appState.garden.growthPoints||0),noteHistory:[],recordedChunks:[],mediaRecorder:null,recordingStart:null,recordingStop:null,echoProgress:loadEchoProgress(),echo:{mode:"idle",level:1,maxLevel:5,expected:[],step:0,mistakes:0,isPlaying:!1,playTimeouts:[],playNodes:[],pendingStart:!1,currentOctave:4,missTimeout:null,lastHintAt:0,lastHintStep:-1,heardRecently:null,lastRoundId:0},improPrefs:loadImproPrefs(),impro:{currentSpace:"sun",currentScale:"pentatonic_major",bpm:90,tempoSamples:[],lastNoteAt:0,lastResponseAt:0,callTimeout:null,backingTimer:null,isBacking:!1,responseEnabled:!0,pendingStart:!1,timeouts:[],visualTimeout:null,backingVolume:.35,loopVolume:.85,backingGain:.012,backingTracks:{},backingReady:{},activeBackingId:null,backingIntensity:0,loops:[],isLoopRecording:!1,loopRecorder:null,loopChunks:[],loopTimer:null,loopDurationMs:4e3,pendingLoopStart:!1},chord:{promptIndex:0,prompt:null,active:!1,pendingStart:!1,windowMs:800,windowTimeout:null,visualTimeout:null,timeouts:[],collected:new Map,noteWindow:[],lastDetectedAt:0,lastExpression:null,pendingChord:null,history:safeJsonParse(localStorage.getItem("klangreise_chords")||"[]",[])},pitchTracker:{stableFramesNeeded:4,minMsBetweenNotes:220,candidatePitchClass:null,candidateFrames:0,lastEmittedPitchClass:null,lastEmittedAt:0}},VISUALIZATION_FPS=30,NOTE_DETECT_MS=60,GARDEN_SAVE_MS=1e3,reduceMotionQuery=window.matchMedia("(prefers-reduced-motion: reduce)");let gardenSaveTimeout=null,visualizerStarted=!1,visualizerResize=null,activeAudio=null,islandZoomTimeout=null;const prompts=["Spiel mal, wie sich ein Schmetterling anh√∂rt! ü¶ã","Wie klingt es, wenn es regnet? üåßÔ∏è","Kannst du einen Elefanten spielen? üêò","Wie h√∂rt sich dein Lieblingstier an?","Spiel mal ganz leise... und dann ganz laut!","Wie klingt ein Sonnenaufgang? ‚òÄÔ∏è","Kannst du Fr√∂hlichkeit spielen?","Wie h√∂rt sich Nebel an? üå´Ô∏è","Spiel mal nur mit einem Finger!","Wie klingt ein springender Ball?","Kannst du eine Wolke spielen? ‚òÅÔ∏è","Wie h√∂rt sich Aufregung an?","Spiel mal, wie du dich gerade f√ºhlst!","Wie klingt ein Geheimnis? ü§´","Kannst du eine Geschichte ohne Worte erz√§hlen?"],flatToSharp={Db:"C#",Eb:"D#",Gb:"F#",Ab:"G#",Bb:"A#"},echoWhiteNotes=["C","D","E","F","G","A","B"],echoPhrases=[{id:"jakob",notes:["C","D","E","C"]},{id:"entchen",notes:["C","D","E","F"]},{id:"twinkle",notes:["C","C","G","G"]},{id:"mary",notes:["E","D","C","D"]}],improScales={pentatonic_major:[0,2,4,7,9],moon_minor:[0,3,5,7,10],blues:[0,3,5,6,7,10]},improSpaces=[{id:"sun",name:"Sonnengarten",scale:"pentatonic_major",color:"#ffd93d",vibe:"hell und fr√∂hlich",emoji:"ü¶ã"},{id:"moon",name:"Mondsee",scale:"moon_minor",color:"#4d96ff",vibe:"ruhig und weit",emoji:"üåô"},{id:"adventure",name:"Abenteuer-Fels",scale:"blues",color:"#9b5de5",vibe:"mutig und spannend",emoji:"üî•"}],chordExplorations=[{id:"bright",notes:["C","E","G"],mood:"fr√∂hlich",color:"#ffd93d",type:"major"},{id:"soft",notes:["C","Eb","G"],mood:"weich",color:"#4d96ff",type:"minor"},{id:"mystery",notes:["C","Eb","Gb"],mood:"spannend",color:"#9b5de5",type:"diminished"},{id:"floating",notes:["C","E","G#"],mood:"schwebend",color:"#ff6b6b",type:"augmented"},{id:"open",notes:["C","F","G"],mood:"offen",color:"#6bcb77",type:"sus4"},{id:"jazzy",notes:["C","E","G","B"],mood:"jazzig",color:"#ffd93d",type:"dom7"}],chordPrompts=[{id:"butterfly",text:"ü¶ã Spiel mal, wie sich ein Schmetterling anh√∂rt."},{id:"giant",text:"üêò Spiel mal, wie sich ein schlafender Riese anh√∂rt."},{id:"sparkle",text:"‚ú® Spiel glitzernde Tropfen."}],chordEmotionMap={major:["üòä","‚òÄÔ∏è","üöÄ","üéâ"],minor:["üò¢","üåô","‚òÅÔ∏è","üïØÔ∏è"],diminished:["üò±","üïµÔ∏è‚Äç‚ôÇÔ∏è","üåã","üåÄ"],augmented:["‚ú®","üéà","üöÄ","üí´"],sus4:["ü§î","‚ú®","ü™Å","üå§Ô∏è"],dom7:["üòé","üé∑","‚ú®","üåÄ"],mystery:["ü§î","‚ú®","üîÆ","ü™Ñ"]},chordPatterns=[{id:"major",intervals:[0,4,7],mood:"klar und hell",color:"#ffd93d"},{id:"minor",intervals:[0,3,7],mood:"weich und tief",color:"#4d96ff"},{id:"diminished",intervals:[0,3,6],mood:"spannend",color:"#9b5de5"},{id:"augmented",intervals:[0,4,8],mood:"schwebend",color:"#ff6b6b"},{id:"sus4",intervals:[0,5,7],mood:"offen",color:"#6bcb77"},{id:"dom7",intervals:[0,4,7,10],mood:"jazzig",color:"#ffd93d"}];function normalizeNoteName(noteName){return flatToSharp[noteName]||noteName}function noteNameToPitchClass(noteName){const normalized=normalizeNoteName(noteName);return noteStrings.indexOf(normalized)}function pitchClassDistance(a,b){const diff=Math.abs(a-b);return Math.min(diff,12-diff)}function midiToFrequency(midi){return 440*Math.pow(2,(midi-69)/12)}function noteNameToMidi(noteName,octave){const pc=noteNameToPitchClass(noteName);return pc<0?null:12*(octave+1)+pc}const noteStrings=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];function frequencyToNote(frequency){if(frequency<20||frequency>5e3)return null;const noteNum=Math.log(frequency/440)/Math.log(2)*12,note=Math.round(noteNum)+69,octave=Math.floor(note/12)-1,noteName=noteStrings[note%12];return{name:noteName,octave:octave,full:`${noteName}${octave}`,frequency:frequency,cents:100*(noteNum+69-note),midi:note}}function autoCorrelate(buffer,sampleRate){let SIZE=buffer.length,sumOfSquares=0;for(let i=0;i<SIZE;i++){const val=buffer[i];sumOfSquares+=val*val}if(Math.sqrt(sumOfSquares/SIZE)<.01)return-1;let r1=0,r2=SIZE-1;for(let i=0;i<SIZE/2;i++)if(Math.abs(buffer[i])<.2){r1=i;break}for(let i=1;i<SIZE/2;i++)if(Math.abs(buffer[SIZE-i])<.2){r2=SIZE-i;break}SIZE=(buffer=buffer.slice(r1,r2)).length;const c=new Array(SIZE).fill(0);for(let i=0;i<SIZE;i++)for(let j=0;j<SIZE-i;j++)c[i]+=buffer[j]*buffer[j+i];let d=0;for(;c[d]>c[d+1];)d++;let maxval=-1,maxpos=-1;for(let i=d;i<SIZE;i++)c[i]>maxval&&(maxval=c[i],maxpos=i);let T0=maxpos;const x1=c[T0-1],x2=c[T0],x3=c[T0+1],a=(x1+x3-2*x2)/2;return a&&(T0-=(x3-x1)/2/(2*a)),sampleRate/T0}async function setupAudio(){try{state.audioContext=new(window.AudioContext||window.webkitAudioContext);const stream=await navigator.mediaDevices.getUserMedia({audio:!0});return state.mediaStream=stream,"suspended"===state.audioContext.state&&await state.audioContext.resume(),state.microphone=state.audioContext.createMediaStreamSource(stream),state.analyser=state.audioContext.createAnalyser(),state.analyser.fftSize=2048,state.microphone.connect(state.analyser),"undefined"!=typeof MediaRecorder?(state.mediaRecorder=new MediaRecorder(stream),state.mediaRecorder.ondataavailable=e=>{e.data.size>0&&state.recordedChunks.push(e.data)},state.mediaRecorder.onstop=saveRecording):(state.mediaRecorder=null,console.warn("MediaRecorder is not supported in this browser.")),appState.session.audioContextStarted=!0,saveAppState(),!0}catch(err){return console.error("Audio setup failed:",err),!1}}function getIslandTheme(){const hour=(new Date).getHours();return hour>=20||hour<6?"night":hour>=6&&hour<11?"sunrise":hour>=17&&hour<20?"sunset":"day"}function applyIslandTheme(){const theme=getIslandTheme();appState.user.currentIslandTheme=theme,appState.user.lastVisit=Date.now(),saveAppState();const map=document.getElementById("islandMap");map&&(map.dataset.theme=theme)}function updateIslandView(){const echoBadge=document.getElementById("badgeEcho"),chordBadge=document.getElementById("badgeChords"),improBadge=document.getElementById("badgeImpro"),gardenBadge=document.getElementById("badgeGarden");if(echoBadge){const level=appState.progress.echoCave.currentLevel||state.echo.level||1;echoBadge.textContent=`Level ${level}`}chordBadge&&(chordBadge.textContent=`Sch√§tze ${appState.progress.chordLagoon.totalChords||0}`),improBadge&&(improBadge.textContent=`Loops ${appState.progress.improMeadow.loopsRecorded||0}`),gardenBadge&&(gardenBadge.textContent=`Wachstum ${appState.garden.growthPoints||0}`)}function updateIslandVideoPlayback(screenId){const video=document.getElementById("islandVideo");video&&(reduceMotionQuery.matches?video.pause():"island"===screenId?(video.muted=!0,video.play().catch(()=>{})):video.pause())}function triggerIslandZoom(targetEl,onDone){const map=document.getElementById("islandMap");if(!map||!targetEl)return void("function"==typeof onDone&&onDone());const mapRect=map.getBoundingClientRect(),targetRect=targetEl.getBoundingClientRect(),originX=(targetRect.left+targetRect.width/2-mapRect.left)/mapRect.width*100,originY=(targetRect.top+targetRect.height/2-mapRect.top)/mapRect.height*100;map.style.setProperty("--zoom-origin-x",`${originX}%`),map.style.setProperty("--zoom-origin-y",`${originY}%`),map.classList.remove("zooming"),map.offsetWidth,map.classList.add("zooming"),islandZoomTimeout&&clearTimeout(islandZoomTimeout),islandZoomTimeout=setTimeout(()=>{map.classList.remove("zooming"),islandZoomTimeout=null},520),"function"==typeof onDone&&setTimeout(onDone,260)}function updateCompassVisibility(screenId){const compass=document.getElementById("compassBtn");if(!compass)return;const hide="island"===screenId||"welcome"===screenId;compass.classList.toggle("hidden",hide)}function openScreen(screenId){if(document.body.classList.toggle("island-mode","island"===screenId),document.querySelectorAll(".nav-tab").forEach(tab=>{tab.classList.toggle("active",tab.dataset.screen===screenId)}),document.querySelectorAll(".screen").forEach(screen=>{screen.classList.toggle("active",screen.id===screenId)}),"garden"===screenId&&updateGardenView(),"diary"===screenId&&updateDiaryView(),"island"===screenId&&(applyIslandTheme(),updateIslandView()),"play"===screenId){const candidate=state.currentModule||"free";setActiveModule(document.getElementById(`module-${candidate}`)?candidate:"free")}updateIslandVideoPlayback(screenId),appState.session.activeScreen=screenId,appState.session.activeModule=state.currentModule,saveAppState(),updateCompassVisibility(screenId)}function openModule(moduleName){document.getElementById(`module-${moduleName}`)&&(state.currentModule=moduleName,openScreen("play"))}function setActiveModule(moduleName){state.currentModule=moduleName,document.querySelectorAll(".module-tab").forEach(t=>{t.classList.toggle("active",t.dataset.module===moduleName)}),document.querySelectorAll(".module-screen").forEach(s=>{s.classList.toggle("active",s.id===`module-${moduleName}`)}),appState.session.activeModule=moduleName,saveAppState(),"echo"===moduleName?enterEchoMode():exitEchoMode(),"chords"===moduleName?enterChordMode():exitChordMode(),"impro"===moduleName?enterImproMode():exitImproMode(),"free"===moduleName&&state.audioContext&&setupVisualization()}function setupModuleTabs(){document.querySelectorAll(".module-tab").forEach(tab=>{tab.disabled||tab.addEventListener("click",()=>setActiveModule(tab.dataset.module))})}const echoLevels=[{level:1,length:2,allowBlack:!1,tempoMs:650,octave:4},{level:2,length:2,allowBlack:!1,tempoMs:520,octave:4},{level:3,length:4,allowBlack:!0,tempoMs:460,octave:4},{level:4,length:4,allowBlack:!1,tempoMs:480,octave:4,phrases:echoPhrases},{level:5,length:4,allowBlack:!0,tempoMs:430,octave:4,rhythm:[520,260,260,520]}],echoUI={pianoEl:null,statusEl:null,progressEl:null,playBtn:null,replayBtn:null,nextBtn:null,celebrateEl:null,whiteContainer:null,magnetEl:null};function initEchoGame(){echoUI.pianoEl=document.getElementById("echoPiano"),echoUI.statusEl=document.getElementById("echoStatus"),echoUI.progressEl=document.getElementById("echoProgress"),echoUI.playBtn=document.getElementById("echoPlayBtn"),echoUI.replayBtn=document.getElementById("echoReplayBtn"),echoUI.nextBtn=document.getElementById("echoNextBtn"),echoUI.celebrateEl=document.getElementById("echoCelebrate"),state.echo.level=clampNumber(state.echoProgress.level||1,1,state.echo.maxLevel),appState.progress.echoCave.currentLevel=Math.max(appState.progress.echoCave.currentLevel||1,state.echo.level),appState.garden.growthPoints=Math.max(appState.garden.growthPoints||0,state.gardenProgress||0),saveAppState(),renderEchoProgress(),renderEchoPiano(),updateEchoControls(),echoUI.playBtn.addEventListener("click",()=>{startEchoRound({replay:!1})}),echoUI.replayBtn.addEventListener("click",()=>{startEchoRound({replay:!0})}),echoUI.nextBtn.addEventListener("click",()=>{advanceEchoLevel(),startEchoRound({replay:!1})}),window.addEventListener("resize",layoutEchoBlackKeys,{passive:!0})}function renderEchoProgress(){if(!echoUI.progressEl)return;const filled=clampNumber(state.echo.level,1,state.echo.maxLevel);echoUI.progressEl.innerHTML=Array.from({length:state.echo.maxLevel},(_,i)=>`<span class="${i<filled?"echo-dot filled":"echo-dot"}" aria-hidden="true"></span>`).join("")}function renderEchoPiano(){if(!echoUI.pianoEl)return;echoUI.pianoEl.innerHTML="";const whiteWrap=document.createElement("div");whiteWrap.className="echo-white-keys",echoUI.whiteContainer=whiteWrap,echoUI.pianoEl.appendChild(whiteWrap);const magnet=document.createElement("div");magnet.className="echo-magnet",echoUI.magnetEl=magnet,echoUI.pianoEl.appendChild(magnet),echoWhiteNotes.forEach(n=>{const key=document.createElement("div");key.className="echo-key white",key.dataset.note=n,key.setAttribute("aria-label",`Taste ${n}`),whiteWrap.appendChild(key)});["C#","D#","F#","G#","A#"].forEach(n=>{const key=document.createElement("div");key.className="echo-key black",key.dataset.note=n,key.setAttribute("aria-label",`Taste ${n}`),echoUI.pianoEl.appendChild(key)}),layoutEchoBlackKeys()}function layoutEchoBlackKeys(){if(!echoUI.pianoEl||!echoUI.whiteContainer)return;const pianoRect=echoUI.pianoEl.getBoundingClientRect(),whiteKeys=Array.from(echoUI.whiteContainer.querySelectorAll(".echo-key.white"));if(!pianoRect.width||whiteKeys.length<7)return;const blackMap={"C#":["C","D"],"D#":["D","E"],"F#":["F","G"],"G#":["G","A"],"A#":["A","B"]},getWhiteByNote=name=>whiteKeys[echoWhiteNotes.indexOf(name)],whiteW=whiteKeys[0].getBoundingClientRect().width,blackW=Math.max(24,Math.floor(.62*whiteW));echoUI.pianoEl.querySelectorAll(".echo-key.black").forEach(blackEl=>{const pair=blackMap[blackEl.dataset.note];if(!pair)return;const leftWhite=getWhiteByNote(pair[0]),rightWhite=getWhiteByNote(pair[1]);if(!leftWhite||!rightWhite)return;const leftRect=leftWhite.getBoundingClientRect(),rightRect=rightWhite.getBoundingClientRect(),center=(leftRect.right+rightRect.left)/2-pianoRect.left;blackEl.style.width=`${blackW}px`,blackEl.style.left=`${Math.round(center-blackW/2)}px`})}function setEchoStatus(text){echoUI.statusEl&&(echoUI.statusEl.textContent=text)}function updateEchoControls(){if(!echoUI.playBtn)return;const isPlaying=state.echo.isPlaying;echoUI.playBtn.disabled=isPlaying,echoUI.replayBtn.disabled=isPlaying||0===state.echo.expected.length,echoUI.nextBtn.disabled=isPlaying||"success"!==state.echo.mode,state.audioContext||"echo"!==state.currentModule||setEchoStatus("Tippe auf Vorh√∂ren. Dann frage ich dich nach dem Mikrofon.")}function enterEchoMode(){state.echo.mode="idle",state.echo.mistakes=0,state.echo.step=0,updateEchoControls()}function exitEchoMode(){state.echo.isPlaying&&cancelEchoPlayback(),state.echo.mode="idle",state.echo.step=0,state.echo.mistakes=0,clearEchoMissTimeout(),setEchoTarget(null),echoUI.magnetEl&&echoUI.magnetEl.classList.remove("active")}function getEchoLevelConfig(){const lvl=clampNumber(state.echo.level,1,state.echo.maxLevel);return echoLevels.find(l=>l.level===lvl)||echoLevels[0]}function getEchoTolerance(level){return{successThreshold:30,magneticThreshold:level<=2?120:100}}function evaluateEchoNote(targetFreq,playedFreq,level){if(!targetFreq||!playedFreq)return"MISS";if(!isFinite(targetFreq)||!isFinite(playedFreq))return"MISS";if(targetFreq<=0||playedFreq<=0)return"MISS";const distanceInCents=1200*Math.log2(playedFreq/targetFreq),absDistance=Math.abs(distanceInCents),{successThreshold:successThreshold,magneticThreshold:magneticThreshold}=getEchoTolerance(level);return absDistance<=successThreshold?"MATCH":absDistance<=magneticThreshold?"NEAR":"MISS"}function pickRandom(arr){return arr[Math.floor(Math.random()*arr.length)]}function generateEchoSequence(levelConfig){if(levelConfig.phrases&&levelConfig.phrases.length){return pickRandom(levelConfig.phrases).notes.slice(0,levelConfig.length)}const allowed=!!levelConfig.allowBlack?noteStrings.slice():echoWhiteNotes.slice(),seq=[];for(let i=0;i<levelConfig.length;i++){let candidate=null;for(let attempt=0;attempt<40;attempt++){const next=pickRandom(allowed);if(0===i){candidate=next;break}const prevPc=noteNameToPitchClass(seq[i-1]),nextPc=noteNameToPitchClass(next);if(prevPc<0||nextPc<0)continue;if(next===seq[i-1])continue;const minDist=1===levelConfig.level?4:1;if(!(pitchClassDistance(prevPc,nextPc)<minDist)){candidate=next;break}}seq.push(candidate||pickRandom(allowed))}return seq}function cancelEchoPlayback(){state.echo.playTimeouts.forEach(clearTimeout),state.echo.playTimeouts=[],state.echo.playNodes.forEach(n=>{try{n.osc.stop()}catch(_){}try{n.osc.disconnect()}catch(_){}try{n.gain.disconnect()}catch(_){}}),state.echo.playNodes=[],state.echo.isPlaying=!1,echoUI.pianoEl&&(echoUI.pianoEl.querySelectorAll(".echo-key.playing").forEach(k=>k.classList.remove("playing")),echoUI.pianoEl.querySelectorAll(".echo-key.heard").forEach(k=>k.classList.remove("heard")))}function clearEchoMissTimeout(){state.echo.missTimeout&&(clearTimeout(state.echo.missTimeout),state.echo.missTimeout=null)}function setEchoTarget(noteName){if(!echoUI.pianoEl)return;if(echoUI.pianoEl.querySelectorAll(".echo-key.target").forEach(k=>k.classList.remove("target")),!noteName)return;const normalized=normalizeNoteName(noteName),el=echoUI.pianoEl.querySelector(`.echo-key[data-note="${normalized}"]`);el&&el.classList.add("target")}function flashEchoTarget(noteName){if(!echoUI.pianoEl)return;const normalized=normalizeNoteName(noteName),el=echoUI.pianoEl.querySelector(`.echo-key[data-note="${normalized}"]`);if(!el)return;el.classList.add("flash");const t=setTimeout(()=>el.classList.remove("flash"),350);state.echo.playTimeouts.push(t)}function showMagnetFlow(fromNote,toNote){if(!echoUI.magnetEl||!echoUI.pianoEl)return;const fromEl=echoUI.pianoEl.querySelector(`.echo-key[data-note="${normalizeNoteName(fromNote)}"]`),toEl=echoUI.pianoEl.querySelector(`.echo-key[data-note="${normalizeNoteName(toNote)}"]`);if(!fromEl||!toEl)return;const pianoRect=echoUI.pianoEl.getBoundingClientRect(),fromRect=fromEl.getBoundingClientRect(),toRect=toEl.getBoundingClientRect(),fromX=fromRect.left+fromRect.width/2-pianoRect.left-8,fromY=fromRect.top+fromRect.height/2-pianoRect.top-8,toX=toRect.left+toRect.width/2-pianoRect.left-8,toY=toRect.top+toRect.height/2-pianoRect.top-8;echoUI.magnetEl.classList.remove("active"),echoUI.magnetEl.style.transform=`translate(${fromX}px, ${fromY}px)`,echoUI.magnetEl.offsetWidth,echoUI.magnetEl.classList.add("active"),echoUI.magnetEl.style.transform=`translate(${toX}px, ${toY}px)`;const t=setTimeout(()=>{echoUI.magnetEl&&echoUI.magnetEl.classList.remove("active")},520);state.echo.playTimeouts.push(t)}function playEchoWhisper(noteName){if(!state.audioContext)return;const midi=noteNameToMidi(noteName,state.echo.currentOctave||4),freq=midi?midiToFrequency(midi):null;if(!freq)return;const ctx=state.audioContext,when=ctx.currentTime+.02,osc=ctx.createOscillator(),gain=ctx.createGain();osc.type="sine",osc.frequency.setValueAtTime(freq,when),gain.gain.setValueAtTime(1e-4,when),gain.gain.linearRampToValueAtTime(.05,when+.02),gain.gain.exponentialRampToValueAtTime(1e-4,when+.26),osc.connect(gain),gain.connect(ctx.destination),osc.start(when),osc.stop(when+.3),state.echo.playNodes.push({osc:osc,gain:gain}),highlightEchoKey(noteName,"playing",220)}function playEchoChime(){if(!state.audioContext)return;const ctx=state.audioContext,when=ctx.currentTime+.02,osc=ctx.createOscillator(),gain=ctx.createGain();osc.type="triangle",osc.frequency.setValueAtTime(880,when),gain.gain.setValueAtTime(1e-4,when),gain.gain.linearRampToValueAtTime(.08,when+.02),gain.gain.exponentialRampToValueAtTime(1e-4,when+.35),osc.connect(gain),gain.connect(ctx.destination),osc.start(when),osc.stop(when+.4),state.echo.playNodes.push({osc:osc,gain:gain})}function highlightEchoKey(noteName,className,holdMs){if(!echoUI.pianoEl)return;const normalized=normalizeNoteName(noteName),el=echoUI.pianoEl.querySelector(`.echo-key[data-note="${normalized}"]`);if(!el)return;if(el.classList.add(className),!holdMs)return;const t=setTimeout(()=>el.classList.remove(className),holdMs);state.echo.playTimeouts.push(t)}async function playEchoSequence(sequence,levelConfig){if(!state.audioContext)return;if("suspended"===state.audioContext.state)try{await state.audioContext.resume()}catch(_){}cancelEchoPlayback(),clearEchoMissTimeout(),state.echo.isPlaying=!0,state.echo.mode="playing",updateEchoControls();const ctx=state.audioContext,tempoMs=levelConfig.tempoMs,rhythm=Array.isArray(levelConfig.rhythm)?levelConfig.rhythm:null,baseOctave="number"==typeof levelConfig.octave?levelConfig.octave:4;state.echo.currentOctave=baseOctave;const startAt=ctx.currentTime+.08;let cursor=0;sequence.forEach((noteName,i)=>{const durMs=rhythm&&rhythm[i]||tempoMs,durSec=Math.max(.14,durMs/1e3),when=startAt+cursor;cursor+=durSec+.05;const midi=noteNameToMidi(noteName,baseOctave),freq=midi?midiToFrequency(midi):null;if(!freq)return;const osc=ctx.createOscillator(),gain=ctx.createGain();osc.type="triangle",osc.frequency.setValueAtTime(freq,when);gain.gain.setValueAtTime(1e-4,when),gain.gain.linearRampToValueAtTime(.12,when+.02),gain.gain.exponentialRampToValueAtTime(1e-4,when+durSec),osc.connect(gain),gain.connect(ctx.destination),osc.start(when),osc.stop(when+durSec+.03),state.echo.playNodes.push({osc:osc,gain:gain});performance.now();const delayMs=Math.max(0,Math.round(1e3*(when-startAt)));state.echo.playTimeouts.push(setTimeout(()=>{highlightEchoKey(noteName,"playing",Math.max(180,Math.round(1e3*durSec)))},delayMs))});const totalMs=Math.round(1e3*(cursor+.1));await new Promise(resolve=>{const t=setTimeout(resolve,totalMs);state.echo.playTimeouts.push(t)}),state.echo.isPlaying=!1,state.echo.mode="awaiting",updateEchoControls(),setEchoStatus("Jetzt du. H√∂r mit deinen Ohren und spiel es nach."),setEchoTarget(state.echo.expected[state.echo.step])}async function startEchoRound({replay:replay}){if(!state.audioContext)return state.echo.pendingStart=!0,document.getElementById("micModal").classList.add("active"),void updateEchoControls();if(!state.isListening&&state.analyser){state.isListening=!0;const micBtn=document.getElementById("micBtn");micBtn&&micBtn.classList.add("listening"),startNoteDetection()}const levelConfig=getEchoLevelConfig();state.echo.mistakes=0,state.echo.step=0,state.echo.mode="idle",state.echo.lastRoundId=Date.now(),state.echo.lastHintStep=-1,state.echo.lastHintAt=0,clearEchoMissTimeout(),replay&&0!==state.echo.expected.length||(state.echo.expected=generateEchoSequence(levelConfig)),echoUI.pianoEl&&echoUI.pianoEl.querySelectorAll(".echo-key.heard").forEach(k=>k.classList.remove("heard")),setEchoTarget(null),setEchoStatus("Ich spiele vor..."),await playEchoSequence(state.echo.expected,levelConfig),echoUI.replayBtn.disabled=!1}function advanceEchoLevel(){const nextLevel=clampNumber(state.echo.level+1,1,state.echo.maxLevel);state.echo.level=nextLevel,state.echoProgress.level=nextLevel,saveEchoProgress(state.echoProgress),appState.progress.echoCave.currentLevel=nextLevel,saveAppState(),updateIslandView(),renderEchoProgress(),state.echo.mode="idle",state.echo.step=0,state.echo.expected=[],updateEchoControls()}function echoCelebrate(){echoUI.celebrateEl&&(echoUI.celebrateEl.classList.remove("active"),echoUI.celebrateEl.offsetWidth,echoUI.celebrateEl.classList.add("active"))}function onEchoStableNote(note){if("echo"!==state.currentModule)return;if(state.echo.isPlaying)return;if("awaiting"!==state.echo.mode)return;if(!state.echo.expected.length)return;if(noteNameToPitchClass(note.name)<0)return;highlightEchoKey(note.name,"heard",220);const expectedName=state.echo.expected[state.echo.step];if(noteNameToPitchClass(expectedName)<0)return;const playedFreq=note.frequency||null,targetMidi=noteNameToMidi(expectedName,state.echo.currentOctave||4),result=evaluateEchoNote(targetMidi?midiToFrequency(targetMidi):null,playedFreq,state.echo.level);if(clearEchoMissTimeout(),"NEAR"===result){const now=performance.now();return(now-state.echo.lastHintAt>700||state.echo.lastHintStep!==state.echo.step)&&(showMagnetFlow(note.name,expectedName),setEchoStatus("Fast da. Such den Klang noch ein bisschen."),state.echo.lastHintAt=now,state.echo.lastHintStep=state.echo.step),void(state.echo.level<=2&&handleEchoMatch())}if("MISS"===result)return state.echo.mistakes+=1,flashEchoTarget(expectedName),state.echo.missTimeout||(state.echo.missTimeout=setTimeout(()=>{state.echo.missTimeout=null,"awaiting"===state.echo.mode&&(state.echo.isPlaying||state.echo.expected[state.echo.step]===expectedName&&playEchoWhisper(expectedName))},2e3)),3===state.echo.mistakes&&setEchoStatus("Wenn du magst, spiele ich es dir nochmal vor."),void(state.echo.mistakes>=6&&(state.echo.mistakes=0,startEchoRound({replay:!0})));function handleEchoMatch(){if(highlightEchoKey(expectedName,"playing",260),state.echo.step+=1,state.echo.mistakes=0,setEchoStatus("Sch√∂n! Und jetzt kommt noch ein Klang..."),state.echo.step>=state.echo.expected.length)return state.echo.mode="success",setEchoStatus("Wow. Dein Echo war wundersch√∂n. Wenn du magst: weiter."),echoCelebrate(),playEchoChime(),updateEchoControls(),setEchoTarget(null),state.gardenProgress+=5,scheduleGardenSave(),appState.progress.echoCave.completed=(appState.progress.echoCave.completed||0)+1,appState.progress.echoCave.currentLevel=state.echo.level,saveAppState(),void updateIslandView();setEchoTarget(state.echo.expected[state.echo.step])}handleEchoMatch()}const chordUI={statusEl:null,promptTextEl:null,noteListEl:null,visualEl:null,auraEl:null,pianoEl:null,whiteContainer:null,feelingPromptEl:null,emojiGridEl:null,listenBtn:null,nextBtn:null};function initChordExplorer(){chordUI.statusEl=document.getElementById("chordStatus"),chordUI.promptTextEl=document.getElementById("chordPromptText"),chordUI.noteListEl=document.getElementById("chordNoteList"),chordUI.visualEl=document.getElementById("chordVisual"),chordUI.auraEl=document.getElementById("chordAura"),chordUI.pianoEl=document.getElementById("chordPiano"),chordUI.feelingPromptEl=document.getElementById("chordFeelingPrompt"),chordUI.emojiGridEl=document.getElementById("chordEmojiGrid"),chordUI.listenBtn=document.getElementById("chordListenBtn"),chordUI.nextBtn=document.getElementById("chordNextBtn"),renderChordPiano();setChordPrompt(Math.floor(Math.random()*chordExplorations.length),{announce:!1}),renderChordEmojis(),updateChordListenButton(),chordUI.listenBtn&&chordUI.listenBtn.addEventListener("click",()=>{ensureChordListening(!0)}),chordUI.nextBtn&&chordUI.nextBtn.addEventListener("click",()=>{setChordPrompt((state.chord.promptIndex+1)%chordExplorations.length,{announce:!0})}),chordUI.emojiGridEl&&chordUI.emojiGridEl.addEventListener("click",event=>{const btn=event.target.closest("button[data-emoji]");btn&&handleChordEmotionSelect(btn.dataset.emoji)}),window.addEventListener("resize",layoutChordBlackKeys,{passive:!0})}function enterChordMode(){clearChordWindow(),clearChordTimeouts(),state.chord.prompt||setChordPrompt(0,{announce:!1}),state.audioContext&&state.isListening?(state.chord.active=!0,setChordStatus("üéß Spiel zwei oder drei Tasten.")):(state.chord.active=!1,setChordStatus("Tippe auf üé§, dann spiel.")),updateChordListenButton()}function exitChordMode(){state.chord.active=!1,state.chord.pendingStart=!1,clearChordWindow(),clearChordTimeouts(),state.chord.pendingChord=null,state.chord.visualTimeout&&(clearTimeout(state.chord.visualTimeout),state.chord.visualTimeout=null),chordUI.visualEl&&chordUI.visualEl.classList.remove("active"),chordUI.pianoEl&&chordUI.pianoEl.querySelectorAll(".chord-key.playing").forEach(k=>k.classList.remove("playing"))}function setChordStatus(text){chordUI.statusEl&&(chordUI.statusEl.textContent=text)}function updateChordListenButton(){chordUI.listenBtn&&(state.audioContext?chordUI.listenBtn.textContent=state.isListening?"üéß Ich h√∂re":"üé§ Zuh√∂ren":chordUI.listenBtn.textContent="üé§ Zuh√∂ren")}function ensureChordListening(userInitiated){if(!state.audioContext)return userInitiated&&(state.chord.pendingStart=!0),document.getElementById("micModal").classList.add("active"),void updateChordListenButton();if(state.chord.pendingStart=!1,"suspended"===state.audioContext.state&&state.audioContext.resume().catch(()=>{}),!state.isListening&&state.analyser){state.isListening=!0;const micBtn=document.getElementById("micBtn");micBtn&&micBtn.classList.add("listening"),startNoteDetection()}state.chord.active=!0,setChordStatus("üéß Spiel. Gef√ºhl ausw√§hlen."),updateChordListenButton()}function setChordPrompt(index,{announce:announce}){const safeIndex=clampNumber(index,0,chordExplorations.length-1);state.chord.promptIndex=safeIndex,state.chord.prompt=chordExplorations[safeIndex],applyChordPrompt(),announce&&setChordStatus("‚ú® Neue Klangidee.")}function applyChordPrompt(){const prompt=state.chord.prompt||chordExplorations[0],cue=chordPrompts[state.chord.promptIndex%chordPrompts.length]||chordPrompts[0];chordUI.promptTextEl&&(chordUI.promptTextEl.textContent=cue.text),chordUI.visualEl&&chordUI.visualEl.classList.remove("flutter","deep"),setChordTargets(prompt.notes),updateChordAura(prompt.color||"#ffd93d"),renderChordEmojis(),state.chord.pendingChord=null}function renderChordPiano(){if(!chordUI.pianoEl)return;chordUI.pianoEl.innerHTML="";const whiteWrap=document.createElement("div");whiteWrap.className="chord-white-keys",chordUI.whiteContainer=whiteWrap,chordUI.pianoEl.appendChild(whiteWrap),echoWhiteNotes.forEach(n=>{const key=document.createElement("div");key.className="chord-key white",key.dataset.note=n,key.setAttribute("aria-label",`Taste ${n}`),whiteWrap.appendChild(key)});["C#","D#","F#","G#","A#"].forEach(n=>{const key=document.createElement("div");key.className="chord-key black",key.dataset.note=n,key.setAttribute("aria-label",`Taste ${n}`),chordUI.pianoEl.appendChild(key)}),layoutChordBlackKeys()}function layoutChordBlackKeys(){if(!chordUI.pianoEl||!chordUI.whiteContainer)return;const pianoRect=chordUI.pianoEl.getBoundingClientRect(),whiteKeys=Array.from(chordUI.whiteContainer.querySelectorAll(".chord-key.white"));if(!pianoRect.width||whiteKeys.length<7)return;const blackMap={"C#":["C","D"],"D#":["D","E"],"F#":["F","G"],"G#":["G","A"],"A#":["A","B"]},getWhiteByNote=name=>whiteKeys[echoWhiteNotes.indexOf(name)],whiteW=whiteKeys[0].getBoundingClientRect().width,blackW=Math.max(24,Math.floor(.62*whiteW));chordUI.pianoEl.querySelectorAll(".chord-key.black").forEach(blackEl=>{const pair=blackMap[blackEl.dataset.note];if(!pair)return;const leftWhite=getWhiteByNote(pair[0]),rightWhite=getWhiteByNote(pair[1]);if(!leftWhite||!rightWhite)return;const leftRect=leftWhite.getBoundingClientRect(),rightRect=rightWhite.getBoundingClientRect(),center=(leftRect.right+rightRect.left)/2-pianoRect.left;blackEl.style.width=`${blackW}px`,blackEl.style.left=`${Math.round(center-blackW/2)}px`})}function setChordTargets(notes){chordUI.pianoEl&&(chordUI.pianoEl.querySelectorAll(".chord-key.target").forEach(k=>k.classList.remove("target")),(notes||[]).forEach(note=>{const normalized=normalizeNoteName(note),key=chordUI.pianoEl.querySelector(`.chord-key[data-note="${normalized}"]`);key&&key.classList.add("target")}))}function highlightChordKey(noteName,className,holdMs){if(!chordUI.pianoEl)return;const normalized=normalizeNoteName(noteName),key=chordUI.pianoEl.querySelector(`.chord-key[data-note="${normalized}"]`);if(!key)return;key.classList.add(className);const t=setTimeout(()=>key.classList.remove(className),holdMs||260);state.chord.timeouts.push(t)}function updateChordAura(color){if(!chordUI.auraEl)return;const core=hexToRgba(color,.78),edge=hexToRgba(color,.12);chordUI.auraEl.style.background=`radial-gradient(circle, ${core}, ${edge})`,chordUI.auraEl.style.boxShadow=`0 0 40px ${hexToRgba(color,.35)}`}function pulseChordAura(color){chordUI.visualEl&&(updateChordAura(color),chordUI.visualEl.classList.add("active"),state.chord.visualTimeout&&clearTimeout(state.chord.visualTimeout),state.chord.visualTimeout=setTimeout(()=>{"chords"===state.currentModule&&chordUI.visualEl.classList.remove("active")},760))}function renderChordEmojis(){if(!chordUI.emojiGridEl)return;const emojis=["üòä","üò¢","üò±"];chordUI.emojiGridEl.innerHTML="";chordUI.emojiGridEl.style.setProperty("--ring-radius","70px"),emojis.forEach((emoji,index)=>{const btn=document.createElement("button");btn.className="chord-emoji-btn",btn.classList.add("suggested"),btn.dataset.emoji=emoji,btn.setAttribute("aria-label",`Gef√ºhl ${emoji}`),btn.textContent=emoji;const angle=360/emojis.length*index;btn.style.setProperty("--angle",`${angle}deg`),chordUI.emojiGridEl.appendChild(btn)})}function clearChordWindow(){state.chord.windowTimeout&&(clearTimeout(state.chord.windowTimeout),state.chord.windowTimeout=null),state.chord.collected.clear(),state.chord.noteWindow=[]}function analyzeChordExpression(noteWindow){if(!noteWindow||!noteWindow.length)return{id:"neutral",label:"‚ú®",status:"‚ú® Klang entdecken"};const midis=noteWindow.map(entry=>entry.midi).filter(value=>"number"==typeof value&&!Number.isNaN(value)),avgMidi=midis.length?midis.reduce((a,b)=>a+b,0)/midis.length:null,times=noteWindow.map(entry=>entry.time).filter(Boolean);let avgDelta=null;if(times.length>=2){const deltas=[];for(let i=1;i<times.length;i++){const delta=times[i]-times[i-1];delta>0&&deltas.push(delta)}deltas.length&&(avgDelta=deltas.reduce((a,b)=>a+b,0)/deltas.length)}return null!==avgMidi&&avgMidi>=72&&(null!==avgDelta&&avgDelta<350)?{id:"butterfly",label:"ü¶ã",status:"ü¶ã Hell & schnell",className:"flutter",color:"#ffd93d"}:null!==avgMidi&&avgMidi<=55&&(null!==avgDelta&&avgDelta>700)?{id:"giant",label:"üêò",status:"üêò Tief & ruhig",className:"deep",color:"#4d96ff"}:{id:"neutral",label:"‚ú®",status:"‚ú® Klang entdecken"}}function applyChordExpression(expression){expression&&chordUI.visualEl&&(chordUI.visualEl.classList.remove("flutter","deep"),expression.className&&chordUI.visualEl.classList.add(expression.className),expression.color&&updateChordAura(expression.color),expression.status&&setChordStatus(expression.status))}function clearChordTimeouts(){state.chord.timeouts.length&&(state.chord.timeouts.forEach(clearTimeout),state.chord.timeouts=[])}function detectChordType(pitchClasses){const unique=Array.from(new Set(pitchClasses)).sort((a,b)=>a-b);if(unique.length<2)return null;for(const root of unique){const intervals=unique.map(pc=>(pc-root+12)%12).sort((a,b)=>a-b);for(const pattern of chordPatterns){if(pattern.intervals.every(i=>intervals.includes(i)))return{...pattern,root:root}}}return null}function finalizeChordWindow(){state.chord.windowTimeout=null;const notes=Array.from(state.chord.collected.values());state.chord.collected.clear();const expression=analyzeChordExpression(state.chord.noteWindow);if(state.chord.noteWindow=[],!notes.length)return;const pitchClasses=notes.map(n=>noteNameToPitchClass(n.name)).filter(pc=>pc>=0),unique=Array.from(new Set(pitchClasses));if(unique.length<2)return void setChordStatus("Spiel noch eine Taste dazu.");const detected=detectChordType(unique),prompt=state.chord.prompt||chordExplorations[0],color=detected?.color||prompt.color||"#ffd93d";detected?.id||prompt.type;pulseChordAura(color),renderChordEmojis(),applyChordExpression(expression),state.chord.lastExpression=expression?.id||null,state.chord.pendingChord={timestamp:Date.now(),notes:notes.map(n=>n.full||n.name),pitchClasses:unique,detectedType:detected?.id||null,mood:detected?.mood||prompt.mood||"besonders",color:color,promptId:prompt.id||null},setChordStatus(`${expression?.status||"‚ú®"} ‚Äì Gef√ºhl w√§hlen.`)}function onChordStableNote(note){if("chords"!==state.currentModule)return;if(!state.chord.active)return;if(!state.isListening)return;if(!note||"number"!=typeof note.frequency)return;const pc=noteNameToPitchClass(note.name);if(pc<0)return;const now=performance.now();state.chord.lastDetectedAt=now,state.chord.windowTimeout||(clearChordWindow(),state.chord.pendingChord=null,setChordStatus("üéß Ich h√∂re..."),state.chord.windowTimeout=setTimeout(finalizeChordWindow,state.chord.windowMs)),state.chord.noteWindow.push({midi:note.midi,time:now}),state.chord.noteWindow.length>12&&state.chord.noteWindow.shift(),state.chord.collected.set(pc,note),highlightChordKey(note.name,"playing",260)}function handleChordEmotionSelect(emoji){const prompt=state.chord.prompt||chordExplorations[0];if(!state.chord.pendingChord)return void setChordStatus("Spiel zuerst.");const entry={id:Date.now(),timestamp:Date.now(),notes:state.chord.pendingChord.notes||prompt.notes,detectedType:state.chord.pendingChord.detectedType||prompt.type||null,userEmotion:emoji,colorContext:state.chord.pendingChord.color||prompt.color||"#ffd93d",label:"",promptId:state.chord.pendingChord.promptId||prompt.id||null};state.chord.history.unshift(entry),state.chord.history=state.chord.history.slice(0,60);try{localStorage.setItem("klangreise_chords",JSON.stringify(state.chord.history))}catch(err){console.warn("Could not save chord entries:",err)}appState.progress.chordLagoon.totalChords=(appState.progress.chordLagoon.totalChords||0)+1,appState.progress.chordLagoon.discoveredEmotions.includes(emoji)||appState.progress.chordLagoon.discoveredEmotions.push(emoji),state.gardenProgress+=4,scheduleGardenSave(),saveAppState(),updateIslandView(),state.chord.pendingChord=null,setChordStatus(`${emoji} Gespeichert.`)}const improUI={worldsEl:null,statusEl:null,visualEl:null,auraEl:null,pianoEl:null,whiteContainer:null,listenBtn:null,responseBtn:null,loopStatusEl:null,loopBtn:null,loopClearBtn:null,backingVolumeInput:null,loopVolumeInput:null};function initImproPlayground(){improUI.worldsEl=document.getElementById("improWorlds"),improUI.statusEl=document.getElementById("improStatus"),improUI.visualEl=document.getElementById("improVisual"),improUI.auraEl=document.getElementById("improAura"),improUI.pianoEl=document.getElementById("improPiano"),improUI.listenBtn=document.getElementById("improListenBtn"),improUI.responseBtn=document.getElementById("improResponseBtn"),improUI.loopStatusEl=document.getElementById("improLoopStatus"),improUI.loopBtn=document.getElementById("improLoopBtn"),improUI.loopClearBtn=document.getElementById("improLoopClearBtn"),improUI.backingVolumeInput=document.getElementById("improBackingVolume"),improUI.loopVolumeInput=document.getElementById("improLoopVolume"),state.impro.currentSpace=state.improPrefs.space||"sun",state.impro.backingVolume=clampNumber(state.improPrefs.backingVolume??.35,0,1),state.impro.loopVolume=clampNumber(state.improPrefs.loopVolume??.85,0,1),applyImproSpace(state.impro.currentSpace,{announce:!1}),renderImproPiano(),initImproBackingTracks(),updateImproLoopStatus(),updateImproBackingIntensity(),updateImproBackingVolume(),improUI.worldsEl&&improUI.worldsEl.querySelectorAll(".impro-world").forEach(card=>{card.addEventListener("click",()=>{applyImproSpace(card.dataset.space,{announce:!0})})}),improUI.listenBtn&&improUI.listenBtn.addEventListener("click",()=>{ensureImproListening(!0)}),improUI.responseBtn&&improUI.responseBtn.addEventListener("click",()=>{"impro"===state.currentModule&&playImproResponse(!0)}),improUI.loopBtn&&improUI.loopBtn.addEventListener("click",()=>{"impro"===state.currentModule&&startImproLoopRecording()}),improUI.loopClearBtn&&improUI.loopClearBtn.addEventListener("click",()=>{clearImproLoops()}),improUI.loopBtn&&"undefined"==typeof MediaRecorder&&(improUI.loopBtn.disabled=!0,improUI.loopStatusEl&&(improUI.loopStatusEl.textContent="Loop-Aufnahme ist in diesem Browser nicht verfuegbar.")),improUI.backingVolumeInput&&(improUI.backingVolumeInput.value=state.impro.backingVolume,improUI.backingVolumeInput.addEventListener("input",event=>{const value=parseFloat(event.target.value);state.impro.backingVolume=clampNumber(value,0,1),state.improPrefs.backingVolume=state.impro.backingVolume,saveImproPrefs(state.improPrefs),updateImproBackingVolume()})),improUI.loopVolumeInput&&(improUI.loopVolumeInput.value=state.impro.loopVolume,improUI.loopVolumeInput.addEventListener("input",event=>{const value=parseFloat(event.target.value);state.impro.loopVolume=clampNumber(value,0,1),state.improPrefs.loopVolume=state.impro.loopVolume,saveImproPrefs(state.improPrefs),updateImproLoopVolume()})),window.addEventListener("resize",layoutImproBlackKeys,{passive:!0})}function enterImproMode(){applyImproSpace(state.improPrefs.space||state.impro.currentSpace||"sun",{announce:!1}),ensureImproListening(!0),startImproBacking(),resumeImproLoops(),appState.progress.improMeadow.sessions=(appState.progress.improMeadow.sessions||0)+1,saveAppState(),state.audioContext?setImproStatus("Spiel los. Die leuchtenden Tasten klingen immer gut zusammen."):setImproStatus("Tippe auf ‚ÄûZuh√∂ren‚Äú, damit ich dich h√∂ren kann."),updateImproListenButton()}function exitImproMode(){if(stopImproBacking(),clearImproCall(),clearImproTimeouts(),pauseImproLoops(),state.impro.pendingStart=!1,state.impro.pendingLoopStart=!1,state.impro.loopTimer&&(clearTimeout(state.impro.loopTimer),state.impro.loopTimer=null),state.impro.loopRecorder&&"recording"===state.impro.loopRecorder.state){try{state.impro.loopRecorder.stop()}catch(_){}state.impro.loopRecorder=null,state.impro.isLoopRecording=!1,updateImproLoopStatus()}state.impro.visualTimeout&&(clearTimeout(state.impro.visualTimeout),state.impro.visualTimeout=null),improUI.pianoEl&&improUI.pianoEl.querySelectorAll(".impro-key.playing, .impro-key.contrast").forEach(k=>{k.classList.remove("playing","contrast")}),improUI.visualEl&&(improUI.visualEl.classList.remove("active","contrast"),improUI.visualEl.classList.add("soft"))}function applyImproSpace(spaceId,{announce:announce}){const space=improSpaces.find(s=>s.id===spaceId)||improSpaces[0];state.impro.currentSpace=space.id,state.impro.currentScale=space.scale,state.improPrefs.space=space.id,saveImproPrefs(state.improPrefs),improUI.worldsEl&&improUI.worldsEl.querySelectorAll(".impro-world").forEach(card=>{card.classList.toggle("active",card.dataset.space===space.id)}),improUI.pianoEl&&(improUI.pianoEl.style.setProperty("--impro-color",space.color),improUI.pianoEl.style.setProperty("--impro-glow",hexToRgba(space.color,.22))),updateImproAuraColor(space.color),updateImproKeyHighlights(),"impro"===state.currentModule&&(startImproBacking(),resumeImproLoops()),announce&&setImproStatus(`${space.emoji} ${space.name}: spiel frei und sp√ºr, wie es sich anf√ºhlt.`)}function renderImproPiano(){if(!improUI.pianoEl)return;improUI.pianoEl.innerHTML="";const whiteWrap=document.createElement("div");whiteWrap.className="impro-white-keys",improUI.whiteContainer=whiteWrap,improUI.pianoEl.appendChild(whiteWrap),echoWhiteNotes.forEach(n=>{const key=document.createElement("div");key.className="impro-key white",key.dataset.note=n,key.setAttribute("aria-label",`Taste ${n}`),whiteWrap.appendChild(key)});["C#","D#","F#","G#","A#"].forEach(n=>{const key=document.createElement("div");key.className="impro-key black",key.dataset.note=n,key.setAttribute("aria-label",`Taste ${n}`),improUI.pianoEl.appendChild(key)}),layoutImproBlackKeys(),updateImproKeyHighlights()}function layoutImproBlackKeys(){if(!improUI.pianoEl||!improUI.whiteContainer)return;const pianoRect=improUI.pianoEl.getBoundingClientRect(),whiteKeys=Array.from(improUI.whiteContainer.querySelectorAll(".impro-key.white"));if(!pianoRect.width||whiteKeys.length<7)return;const blackMap={"C#":["C","D"],"D#":["D","E"],"F#":["F","G"],"G#":["G","A"],"A#":["A","B"]},getWhiteByNote=name=>whiteKeys[echoWhiteNotes.indexOf(name)],whiteW=whiteKeys[0].getBoundingClientRect().width,blackW=Math.max(24,Math.floor(.62*whiteW));improUI.pianoEl.querySelectorAll(".impro-key.black").forEach(blackEl=>{const pair=blackMap[blackEl.dataset.note];if(!pair)return;const leftWhite=getWhiteByNote(pair[0]),rightWhite=getWhiteByNote(pair[1]);if(!leftWhite||!rightWhite)return;const leftRect=leftWhite.getBoundingClientRect(),rightRect=rightWhite.getBoundingClientRect(),center=(leftRect.right+rightRect.left)/2-pianoRect.left;blackEl.style.width=`${blackW}px`,blackEl.style.left=`${Math.round(center-blackW/2)}px`})}function updateImproKeyHighlights(){if(!improUI.pianoEl)return;const scale=improScales[state.impro.currentScale]||improScales.pentatonic_major;improUI.pianoEl.querySelectorAll(".impro-key").forEach(key=>{const pc=noteNameToPitchClass(key.dataset.note),allowed=scale.includes(pc);key.classList.toggle("allowed",allowed)})}function setImproStatus(text){improUI.statusEl&&(improUI.statusEl.textContent=text)}function updateImproListenButton(){improUI.listenBtn&&(state.audioContext?improUI.listenBtn.textContent=state.isListening?"üéß Ich h√∂re":"üé§ Zuh√∂ren":improUI.listenBtn.textContent="üé§ Zuh√∂ren")}function updateImproAuraColor(hexColor){if(!improUI.auraEl)return;const core=hexToRgba(hexColor,.78),edge=hexToRgba(hexColor,.1);improUI.auraEl.style.background=`radial-gradient(circle, ${core}, ${edge})`,improUI.auraEl.style.boxShadow=`0 0 40px ${hexToRgba(hexColor,.35)}`}function hexToRgba(hex,alpha){const clean=hex.replace("#","");if(6!==clean.length)return`rgba(255, 255, 255, ${alpha})`;return`rgba(${parseInt(clean.slice(0,2),16)}, ${parseInt(clean.slice(2,4),16)}, ${parseInt(clean.slice(4,6),16)}, ${alpha})`}function initImproBackingTracks(){Object.keys(state.impro.backingTracks).length||improSpaces.forEach(space=>{const audio=new Audio;audio.loop=!0,audio.preload="none",audio.volume=state.impro.backingVolume,audio._krCandidates=[`assets/audio/backing/${space.id}.wav`,`assets/audio/backing/${space.id}.mp3`,`assets/audio/backing/${space.id}.m4a`],audio._krCandidateIndex=0,audio._krStarted=!1,audio._krResolved=!1;audio.addEventListener("canplaythrough",()=>{audio._krResolved||(audio._krResolved=!0,state.impro.backingReady[space.id]=!0,"impro"===state.currentModule&&state.impro.currentSpace===space.id&&startImproBacking())}),audio.addEventListener("error",()=>{audio._krResolved||(audio._krCandidateIndex+=1,(()=>{if(audio._krCandidateIndex>=audio._krCandidates.length)return audio._krResolved=!0,void(state.impro.backingReady[space.id]=!1);audio.src=audio._krCandidates[audio._krCandidateIndex],audio.load()})())}),state.impro.backingTracks[space.id]=audio,state.impro.backingReady[space.id]=!1})}function requestImproBackingLoad(spaceId){const audio=state.impro.backingTracks[spaceId];audio&&(audio._krStarted||(audio._krStarted=!0,audio._krCandidateIndex=0,audio._krResolved=!1,audio.src=audio._krCandidates[0],audio.load()))}function playImproBackingTrack(spaceId){requestImproBackingLoad(spaceId);const audio=state.impro.backingTracks[spaceId];return!(!audio||!state.impro.backingReady[spaceId])&&(state.impro.activeBackingId&&state.impro.activeBackingId!==spaceId&&stopImproBackingAudio(),audio.volume=getImproBackingVolume(),audio.currentTime=0,audio.play().catch(()=>{}),state.impro.activeBackingId=spaceId,!0)}function stopImproBackingAudio(){if(!state.impro.activeBackingId)return;const audio=state.impro.backingTracks[state.impro.activeBackingId];audio&&(audio.pause(),audio.currentTime=0),state.impro.activeBackingId=null}function getImproBackingVolume(){return clampNumber((state.impro.backingVolume||0)*(.55+.45*(state.impro.backingIntensity||0)),0,1)}function updateImproBackingVolume(){if(state.impro.activeBackingId){const audio=state.impro.backingTracks[state.impro.activeBackingId];audio&&(audio.volume=getImproBackingVolume())}}function updateImproBackingIntensity(){const intensity=clampNumber((state.impro.bpm-60)/80,0,1);state.impro.backingIntensity=intensity,state.impro.backingGain=.008+.01*intensity,updateImproBackingVolume()}function updateImproLoopVolume(){state.impro.loops.forEach(loop=>{loop.audio&&(loop.audio.volume=state.impro.loopVolume)})}function updateImproLoopStatus(){if(!improUI.loopStatusEl)return;if("undefined"==typeof MediaRecorder)return improUI.loopStatusEl.textContent="Loop-Aufnahme ist in diesem Browser nicht verfuegbar.",void updateImproLoopButton();if(state.impro.isLoopRecording)return improUI.loopStatusEl.textContent="Loop nimmt auf...",void updateImproLoopButton();const count=state.impro.loops.length;improUI.loopStatusEl.textContent=0===count?"Kein Loop aufgenommen.":`${count} Loop${1===count?"":"s"} aktiv.`,updateImproLoopButton(),improUI.loopClearBtn&&(improUI.loopClearBtn.disabled=0===count)}function updateImproLoopButton(){improUI.loopBtn&&(state.impro.isLoopRecording?(improUI.loopBtn.textContent="‚è∫Ô∏è Aufnahme...",improUI.loopBtn.disabled=!0):(improUI.loopBtn.textContent="üîÅ Loop aufnehmen",improUI.loopBtn.disabled="undefined"==typeof MediaRecorder))}function startImproLoopRecording(){if(state.impro.isLoopRecording)return;if(!state.mediaStream)return state.impro.pendingStart=!0,state.impro.pendingLoopStart=!0,document.getElementById("micModal").classList.add("active"),void(improUI.loopStatusEl&&(improUI.loopStatusEl.textContent="Erst Mikrofon erlauben, dann nehmen wir den Loop auf."));if("undefined"==typeof MediaRecorder)return void(improUI.loopStatusEl&&(improUI.loopStatusEl.textContent="Loop-Aufnahme ist hier nicht verfuegbar."));ensureImproListening(!0),state.impro.isLoopRecording=!0,updateImproLoopStatus();const recorder=new MediaRecorder(state.mediaStream);state.impro.loopRecorder=recorder,state.impro.loopChunks=[],recorder.ondataavailable=event=>{event.data.size>0&&state.impro.loopChunks.push(event.data)},recorder.onstop=()=>{const blob=new Blob(state.impro.loopChunks,{type:"audio/webm"});state.impro.loopChunks=[],addImproLoop(blob),state.impro.isLoopRecording=!1,state.impro.loopRecorder=null,updateImproLoopStatus()},recorder.start(),state.impro.loopTimer&&clearTimeout(state.impro.loopTimer),state.impro.loopTimer=setTimeout(()=>{try{recorder.stop()}catch(_){}state.impro.loopTimer=null},state.impro.loopDurationMs)}function addImproLoop(blob){const url=URL.createObjectURL(blob),audio=new Audio(url);audio.loop=!0,audio.volume=state.impro.loopVolume,audio.play().catch(()=>{});const loop={id:Date.now(),url:url,audio:audio};state.impro.loops.push(loop),appState.progress.improMeadow.loopsRecorded=(appState.progress.improMeadow.loopsRecorded||0)+1,state.gardenProgress+=3,scheduleGardenSave(),saveAppState(),updateIslandView(),updateImproLoopStatus()}function clearImproLoops(){state.impro.loops.forEach(loop=>{loop.audio&&loop.audio.pause(),loop.url&&URL.revokeObjectURL(loop.url)}),state.impro.loops=[],updateImproLoopStatus()}function pauseImproLoops(){state.impro.loops.forEach(loop=>{loop.audio&&loop.audio.pause()})}function resumeImproLoops(){state.impro.loops.forEach(loop=>{loop.audio&&loop.audio.play().catch(()=>{})})}function ensureImproListening(userInitiated){if(!state.audioContext)return userInitiated&&(state.impro.pendingStart=!0),document.getElementById("micModal").classList.add("active"),void updateImproListenButton();if("suspended"===state.audioContext.state&&state.audioContext.resume().catch(()=>{}),!state.isListening&&state.analyser){state.isListening=!0;const micBtn=document.getElementById("micBtn");micBtn&&micBtn.classList.add("listening"),startNoteDetection()}updateImproListenButton()}function onImproStableNote(note){if("impro"!==state.currentModule)return;if(state.echo.isPlaying)return;if(!note||"number"!=typeof note.frequency)return;const scale=improScales[state.impro.currentScale]||improScales.pentatonic_major,pc=noteNameToPitchClass(note.name),isAllowed=scale.includes(pc);highlightImproKey(note.name,isAllowed?"playing":"contrast",260),updateImproVisual(isAllowed),updateImproTempo(),scheduleImproCall(),setImproStatus(isAllowed?"Das klingt warm und rund. Spiel weiter.":"Oh, ein spannender Kontrast.")}function highlightImproKey(noteName,className,holdMs){if(!improUI.pianoEl)return;const normalized=normalizeNoteName(noteName),el=improUI.pianoEl.querySelector(`.impro-key[data-note="${normalized}"]`);if(!el)return;el.classList.add(className);const t=setTimeout(()=>el.classList.remove(className),holdMs||240);state.impro.timeouts.push(t)}function updateImproVisual(isAllowed){improUI.visualEl&&(state.impro.visualTimeout&&(clearTimeout(state.impro.visualTimeout),state.impro.visualTimeout=null),isAllowed?(improUI.visualEl.classList.add("active"),improUI.visualEl.classList.remove("contrast"),improUI.visualEl.classList.remove("soft"),state.impro.visualTimeout=setTimeout(()=>{"impro"===state.currentModule&&(improUI.visualEl.classList.remove("active"),improUI.visualEl.classList.add("soft"))},520)):(improUI.visualEl.classList.add("contrast"),improUI.visualEl.classList.remove("active"),improUI.visualEl.classList.remove("soft"),setTimeout(()=>{"impro"===state.currentModule&&(improUI.visualEl.classList.remove("contrast"),improUI.visualEl.classList.add("soft"))},420)))}function updateImproTempo(){const now=performance.now();if(state.impro.lastNoteAt){const delta=now-state.impro.lastNoteAt;if(delta>120&&delta<2e3){state.impro.tempoSamples.push(delta),state.impro.tempoSamples.length>6&&state.impro.tempoSamples.shift();const avg=state.impro.tempoSamples.reduce((a,b)=>a+b,0)/state.impro.tempoSamples.length,bpm=clampNumber(Math.round(6e4/avg),60,140);state.impro.bpm=bpm,updateImproBackingIntensity()}}state.impro.lastNoteAt=now}function scheduleImproCall(){state.impro.responseEnabled&&(clearImproCall(),state.impro.callTimeout=setTimeout(()=>{if("impro"!==state.currentModule)return;performance.now()-state.impro.lastNoteAt<1500||playImproResponse(!1)},1800))}function clearImproCall(){state.impro.callTimeout&&(clearTimeout(state.impro.callTimeout),state.impro.callTimeout=null)}function clearImproTimeouts(){state.impro.timeouts.length&&(state.impro.timeouts.forEach(clearTimeout),state.impro.timeouts=[])}function playImproResponse(userInitiated){if(!state.audioContext)return;if(!state.impro.responseEnabled)return;"suspended"===state.audioContext.state&&state.audioContext.resume().catch(()=>{});const now=performance.now();if(!userInitiated&&now-state.impro.lastResponseAt<2500)return;const scale=improScales[state.impro.currentScale]||improScales.pentatonic_major,rootPc=scale[0],otherPc=scale[Math.floor(Math.random()*scale.length)],noteNames=[noteStrings[rootPc],noteStrings[otherPc]],tempoMs=clampNumber(Math.round(6e4/state.impro.bpm),380,900),startAt=state.audioContext.currentTime+.05;noteNames.forEach((noteName,i)=>{const when=startAt+i*tempoMs/1e3,duration=Math.max(.18,tempoMs/1e3*.8);playImproTone(noteName,when,duration,.06);const delay=Math.max(0,Math.round(1e3*(when-startAt)));setTimeout(()=>highlightImproKey(noteName,"playing",240),delay)}),state.impro.lastResponseAt=performance.now()}function playImproTone(noteName,when,duration,volume){const midi=noteNameToMidi(noteName,4),freq=midi?midiToFrequency(midi):null;if(!freq)return;const ctx=state.audioContext,osc=ctx.createOscillator(),gain=ctx.createGain();osc.type="triangle",osc.frequency.setValueAtTime(freq,when);const peak=volume||.05;gain.gain.setValueAtTime(1e-4,when),gain.gain.linearRampToValueAtTime(peak,when+.02),gain.gain.exponentialRampToValueAtTime(1e-4,when+duration),osc.connect(gain),gain.connect(ctx.destination),osc.start(when),osc.stop(when+duration+.03),state.echo.playNodes.push({osc:osc,gain:gain})}function startImproBacking(){if(!state.audioContext)return;"suspended"===state.audioContext.state&&state.audioContext.resume().catch(()=>{});if(playImproBackingTrack(state.impro.currentSpace))return state.impro.isBacking=!1,void(state.impro.backingTimer&&(clearTimeout(state.impro.backingTimer),state.impro.backingTimer=null));stopImproBackingAudio(),state.impro.isBacking||(state.impro.isBacking=!0,runImproBacking())}function stopImproBacking(){state.impro.isBacking=!1,state.impro.backingTimer&&(clearTimeout(state.impro.backingTimer),state.impro.backingTimer=null),stopImproBackingAudio()}function runImproBacking(){if(!state.impro.isBacking||"impro"!==state.currentModule)return;const tempoMs=clampNumber(Math.round(6e4/state.impro.bpm),420,900),ctx=state.audioContext,recentlyActive=performance.now()-state.impro.lastNoteAt<5e3,when=ctx.currentTime+.02;if(recentlyActive){const osc=ctx.createOscillator(),gain=ctx.createGain();osc.type="sine",osc.frequency.setValueAtTime(220,when),gain.gain.setValueAtTime(1e-4,when),gain.gain.linearRampToValueAtTime(state.impro.backingGain,when+.04),gain.gain.exponentialRampToValueAtTime(1e-4,when+.25),osc.connect(gain),gain.connect(ctx.destination),osc.start(when),osc.stop(when+.3),state.echo.playNodes.push({osc:osc,gain:gain})}state.impro.backingTimer=setTimeout(runImproBacking,tempoMs)}function setupVisualization(){if(visualizerStarted)return void("function"==typeof visualizerResize&&visualizerResize());visualizerStarted=!0;const canvas=document.getElementById("visualizer"),ctx=canvas.getContext("2d"),particles=[],maxParticles=reduceMotionQuery.matches?0:120,frameInterval=1e3/(reduceMotionQuery.matches?12:30);let dataArray=null,bufferLength=0,lastFrameTime=0;function resize(){const dpr=window.devicePixelRatio||1,rect=canvas.getBoundingClientRect();canvas.width=Math.max(1,Math.floor(rect.width*dpr)),canvas.height=Math.max(1,Math.floor(rect.height*dpr))}visualizerResize=resize,resize(),window.addEventListener("resize",resize,{passive:!0}),requestAnimationFrame(function animate(now){if(requestAnimationFrame(animate),!(document.hidden||now-lastFrameTime<frameInterval)){if(lastFrameTime=now,ctx.fillStyle="rgba(26, 26, 46, 0.1)",ctx.fillRect(0,0,canvas.width,canvas.height),state.isListening&&state.analyser){const data=state.analyser?(dataArray&&bufferLength===state.analyser.frequencyBinCount||(bufferLength=state.analyser.frequencyBinCount,dataArray=new Uint8Array(bufferLength)),state.analyser.getByteFrequencyData(dataArray),dataArray):null;if(data){let sum=0;for(let i=0;i<bufferLength;i++)sum+=data[i];sum/bufferLength>20&&particles.length<maxParticles&&particles.push({x:canvas.width/2+200*(Math.random()-.5),y:canvas.height/2,vx:10*(Math.random()-.5),vy:10*(Math.random()-.5)-5,radius:20*Math.random()+5,color:getWorldColor(),life:1});const barWidth=canvas.width/64,step=Math.max(1,Math.floor(bufferLength/64));for(let i=0;i<64;i++){const barHeight=1.5*data[i*step],hue=4*i+(state.currentWorld?getWorldHue():260);ctx.fillStyle=`hsla(${hue}, 80%, 60%, 0.6)`,ctx.fillRect(i*barWidth,canvas.height-barHeight,barWidth-2,barHeight)}}}for(let i=particles.length-1;i>=0;i--){const p=particles[i];p.x+=p.vx,p.y+=p.vy,p.vy+=.1,p.life-=.02,p.life<=0?particles.splice(i,1):(ctx.beginPath(),ctx.arc(p.x,p.y,p.radius*p.life,0,2*Math.PI),ctx.fillStyle=p.color.replace("1)",`${p.life})`),ctx.fill())}}})}function getWorldColor(){return{mysterious:"rgba(155, 93, 229, 1)",joyful:"rgba(255, 217, 61, 1)",dreamy:"rgba(77, 150, 255, 1)",exciting:"rgba(255, 107, 107, 1)",calm:"rgba(107, 203, 119, 1)"}[state.currentWorld]||"rgba(155, 93, 229, 1)"}function getWorldHue(){return{mysterious:270,joyful:45,dreamy:210,exciting:0,calm:140}[state.currentWorld]||260}function startNoteDetection(){if(!state.analyser)return;const bufferLength=state.analyser.fftSize,buffer=new Float32Array(bufferLength);let lastDetectTime=0;requestAnimationFrame(function detect(now){if(!state.isListening)return;if(document.hidden)return void requestAnimationFrame(detect);if(now-lastDetectTime<60)return void requestAnimationFrame(detect);lastDetectTime=now,state.analyser.getFloatTimeDomainData(buffer);const frequency=autoCorrelate(buffer,state.audioContext.sampleRate);if(frequency>0){const note=frequencyToNote(frequency);note&&updateNoteDisplay(note)}requestAnimationFrame(detect)})}function feedPitchTracker(note,nowMs){const pc=noteNameToPitchClass(note.name);if(pc<0)return;const t=state.pitchTracker;t.candidatePitchClass===pc?t.candidateFrames+=1:(t.candidatePitchClass=pc,t.candidateFrames=1),t.candidateFrames<t.stableFramesNeeded||t.lastEmittedPitchClass!==pc&&(nowMs-t.lastEmittedAt<t.minMsBetweenNotes||(t.lastEmittedPitchClass=pc,t.lastEmittedAt=nowMs,onEchoStableNote(note),onChordStableNote(note),onImproStableNote(note)))}function updateNoteDisplay(note){feedPitchTracker(note,performance.now());const noteEl=document.getElementById("currentNote"),historyEl=document.getElementById("noteHistory");noteEl&&(noteEl.textContent=note.full,noteEl.style.color=getWorldColor()),0!==state.noteHistory.length&&state.noteHistory[state.noteHistory.length-1]===note.full||(state.noteHistory.push(note.full),state.noteHistory.length>8&&state.noteHistory.shift(),historyEl&&(historyEl.innerHTML=state.noteHistory.map(n=>`<span class="note-bubble">${n}</span>`).join("")),state.gardenProgress++,scheduleGardenSave())}function scheduleGardenSave(){gardenSaveTimeout||(gardenSaveTimeout=setTimeout(()=>{syncGardenProgress(),gardenSaveTimeout=null},1e3))}function syncGardenProgress(){localStorage.setItem("klangreise_garden",state.gardenProgress),appState.garden.growthPoints=state.gardenProgress,saveAppState(),updateIslandView()}function toggleRecording(){const btn=document.getElementById("recordBtn");state.mediaRecorder?state.isRecording?(state.recordingStop=performance.now(),state.mediaRecorder.stop(),state.isRecording=!1,btn.classList.remove("recording"),btn.textContent="‚è∫Ô∏è"):(state.recordedChunks=[],state.recordingStart=performance.now(),state.recordingStop=null,state.mediaRecorder.start(),state.isRecording=!0,btn.classList.add("recording"),btn.textContent="‚èπÔ∏è"):alert("Aufnahmen werden in diesem Browser nicht unterst√ºtzt.")}function saveRecording(){const blob=new Blob(state.recordedChunks,{type:"audio/webm"}),url=URL.createObjectURL(blob),durationMs=state.recordingStart&&state.recordingStop?state.recordingStop-state.recordingStart:null,duration=durationMs?Math.max(1,Math.round(durationMs/1e3)):Math.floor(state.recordedChunks.length/2),recording={id:Date.now(),url:url,date:(new Date).toLocaleDateString("de-DE"),time:(new Date).toLocaleTimeString("de-DE",{hour:"2-digit",minute:"2-digit"}),emoji:["üéµ","üé∂","üéπ","‚ú®","üåü","üí´","üéº"][Math.floor(7*Math.random())],world:state.currentWorld,duration:duration};state.recordings.unshift(recording),localStorage.setItem("klangreise_recordings",JSON.stringify(state.recordings.map(r=>({...r,url:null})))),state.recordingStart=null,state.recordingStop=null,updateDiaryView(),alert("üéâ Toll gemacht! Deine Aufnahme wurde im Klangtagebuch gespeichert!")}function playRecording(url){if(!url)return;activeAudio&&(activeAudio.pause(),activeAudio.currentTime=0);const audio=new Audio(url);activeAudio=audio,audio.play(),audio.addEventListener("ended",()=>{activeAudio===audio&&(activeAudio=null)})}function updateDiaryView(){const container=document.getElementById("diaryEntries"),totalEl=document.getElementById("totalRecordings"),minutesEl=document.getElementById("totalMinutes");totalEl.textContent=state.recordings.length,minutesEl.textContent=Math.floor(state.recordings.reduce((a,r)=>a+(r.duration||0),0)/60),0!==state.recordings.length?container.innerHTML=state.recordings.map(r=>`\n                <div class="diary-entry">\n                    <div class="entry-emoji">${r.emoji}</div>\n                    <div class="entry-info">\n                        <div class="entry-date">${r.date} um ${r.time}</div>\n                        <div class="entry-title">${r.world?"Klangwelt: "+r.world:"Freies Spielen"}</div>\n                        <div class="entry-duration">${r.duration||"?"} Sekunden</div>\n                    </div>\n                    ${r.url?`<button class="entry-play" onclick="playRecording('${r.url}')">‚ñ∂Ô∏è</button>`:""}\n                </div>\n            `).join(""):container.innerHTML='\n                    <div class="empty-diary">\n                        <div class="empty-diary-icon">üéµ</div>\n                        <p>Noch keine Aufnahmen ‚Äì deine erste Klanggeschichte wartet auf dich!</p>\n                    </div>\n                '}function updateGardenView(){const garden=document.getElementById("gardenVisual"),progress=state.gardenProgress,plants=["üå±","üåø","üå∏","üå∫","üåª","üå∑","üåπ","ü™ª","üåº","üíê"],trees=["üå≤","üå≥","üå¥"];let plantsHTML="";const numPlants=Math.min(Math.floor(progress/10),15);for(let i=0;i<numPlants;i++){const plant=progress>100&&i<3?trees[i%3]:plants[i%plants.length];plantsHTML+=`<div class="plant" style="left: ${10+6*i+3*Math.random()}%; animation-delay: ${.2*i}s;">${plant}</div>`}const message=progress<10?"Spiele und entdecke, um deinen Garten wachsen zu lassen!":progress<50?"Dein Garten beginnt zu wachsen! üå±":progress<100?"Wunderbar! So viele sch√∂ne Pflanzen! üå∏":"Wow! Dein Garten ist ein Paradies! üå≥‚ú®";garden.innerHTML=`\n                <div class="garden-message">${message}</div>\n                ${plantsHTML}\n                <div class="garden-ground"></div>\n            `}let parentHoldTimer=null;function openParentDrawer(){const drawer=document.getElementById("parentDrawer"),backdrop=document.getElementById("parentBackdrop");drawer&&(drawer.classList.add("open"),drawer.setAttribute("aria-hidden","false")),backdrop&&backdrop.classList.add("active")}function closeParentDrawer(){const drawer=document.getElementById("parentDrawer"),backdrop=document.getElementById("parentBackdrop");drawer&&(drawer.classList.remove("open"),drawer.setAttribute("aria-hidden","true")),backdrop&&backdrop.classList.remove("active")}function attachParentMenu(){const btn=document.getElementById("parentBtn"),backdrop=document.getElementById("parentBackdrop"),closeBtn=document.getElementById("parentClose");if(!btn)return;const cancelHold=()=>{parentHoldTimer&&(clearTimeout(parentHoldTimer),parentHoldTimer=null),btn.classList.remove("holding")};btn.addEventListener("pointerdown",()=>{parentHoldTimer||(btn.classList.add("holding"),parentHoldTimer=setTimeout(()=>{parentHoldTimer=null,btn.classList.remove("holding"),openParentDrawer()},1200))}),btn.addEventListener("pointerup",cancelHold),btn.addEventListener("pointerleave",cancelHold),btn.addEventListener("pointercancel",cancelHold),backdrop&&backdrop.addEventListener("click",closeParentDrawer),closeBtn&&closeBtn.addEventListener("click",closeParentDrawer)}document.querySelectorAll(".nav-tab").forEach(tab=>{tab.addEventListener("click",()=>{openScreen(tab.dataset.screen),closeParentDrawer()})}),document.getElementById("startBtn").addEventListener("click",()=>{appState.user.introSeen=!0,saveAppState(),openScreen("island")}),document.querySelectorAll(".island-landmark").forEach(landmark=>{"true"===landmark.dataset.disabled?landmark.classList.add("disabled"):landmark.addEventListener("click",()=>{const screen=landmark.dataset.screen||"play",module=landmark.dataset.module||null;triggerIslandZoom(landmark,()=>{module?openModule(module):openScreen(screen)})})});const islandGardenBtn=document.getElementById("islandGarden");islandGardenBtn&&islandGardenBtn.addEventListener("click",()=>openScreen("garden"));const compassBtn=document.getElementById("compassBtn");function createBackgroundParticles(){if(reduceMotionQuery.matches)return;const container=document.getElementById("particles"),colors=["#9b5de5","#4d96ff","#6bcb77","#ffd93d","#ff6b6b"],fragment=document.createDocumentFragment();for(let i=0;i<20;i++){const particle=document.createElement("div");particle.className="particle",particle.style.width=100*Math.random()+20+"px",particle.style.height=particle.style.width,particle.style.left=100*Math.random()+"%",particle.style.top=100*Math.random()+"%",particle.style.background=colors[Math.floor(Math.random()*colors.length)],particle.style.animationDelay=20*Math.random()+"s",particle.style.animationDuration=20*Math.random()+15+"s",fragment.appendChild(particle)}container.appendChild(fragment)}function registerServiceWorker(){"serviceWorker"in navigator&&window.addEventListener("load",()=>{navigator.serviceWorker.register("service-worker.js").catch(err=>{console.warn("Service worker registration failed:",err)})})}compassBtn&&compassBtn.addEventListener("click",()=>openScreen("island")),document.getElementById("allowMicBtn").addEventListener("click",async()=>{await setupAudio()&&(document.getElementById("micModal").classList.remove("active"),state.isListening=!0,document.getElementById("micBtn").classList.add("listening"),startNoteDetection(),setupVisualization(),updateEchoControls(),updateChordListenButton(),updateImproListenButton(),"echo"===state.currentModule&&state.echo.pendingStart&&(state.echo.pendingStart=!1,startEchoRound({replay:!1})),"chords"===state.currentModule&&state.chord.pendingStart&&(state.chord.pendingStart=!1,ensureChordListening(!1)),"impro"===state.currentModule&&state.impro.pendingStart&&(state.impro.pendingStart=!1,enterImproMode(),state.impro.pendingLoopStart&&(state.impro.pendingLoopStart=!1,startImproLoopRecording())))}),document.getElementById("micBtn").addEventListener("click",async()=>{state.audioContext?(state.isListening=!state.isListening,document.getElementById("micBtn").classList.toggle("listening",state.isListening),state.isListening&&startNoteDetection(),updateEchoControls(),updateChordListenButton(),updateImproListenButton()):document.getElementById("micModal").classList.add("active")}),document.getElementById("recordBtn").addEventListener("click",()=>{state.audioContext?toggleRecording():alert("Bitte aktiviere zuerst das Mikrofon! üé§")}),document.getElementById("saveBtn").addEventListener("click",()=>{alert("üíæ Bald kannst du hier kleine Klangnotizen speichern!")}),document.getElementById("newPromptBtn").addEventListener("click",()=>{const prompt=prompts[Math.floor(Math.random()*prompts.length)];document.getElementById("dailyPrompt").textContent=prompt}),document.querySelectorAll(".world-card").forEach(card=>{card.addEventListener("click",()=>{document.querySelectorAll(".world-card").forEach(c=>c.classList.remove("active")),card.classList.add("active"),state.currentWorld=card.dataset.world,document.getElementById("moodLabel").textContent=card.querySelector(".world-name").textContent,document.querySelector('[data-screen="play"]').click()})}),window.addEventListener("beforeunload",()=>{gardenSaveTimeout&&(syncGardenProgress(),gardenSaveTimeout=null)}),createBackgroundParticles(),setupModuleTabs(),initEchoGame(),initChordExplorer(),initImproPlayground(),attachParentMenu(),registerServiceWorker(),applyIslandTheme(),updateIslandView(),openScreen("island"),updateDiaryView(),updateChordListenButton(),updateImproListenButton(),document.getElementById("dailyPrompt").textContent=prompts[Math.floor(Math.random()*prompts.length)]</script></body></html>