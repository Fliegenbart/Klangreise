<!doctype html><html lang="de"><head><meta charset="UTF-8"><meta content="width=device-width,initial-scale=1" name="viewport"><title>KlangReise ‚Äì Entdecke die Magie der Musik</title><link href="https://fonts.googleapis.com" rel="preconnect"><link href="https://fonts.gstatic.com" rel="preconnect" crossorigin><link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@300;400;500;600&family=Nunito:wght@400;600;700&display=swap" rel="stylesheet"><style>:root{--bg-gradient-start:#1a1a2e;--bg-gradient-end:#16213e;--accent-warm:#ff6b6b;--accent-gold:#ffd93d;--accent-teal:#6bcb77;--accent-blue:#4d96ff;--accent-purple:#9b5de5;--text-light:#f8f8f8;--text-muted:#a0a0b0;--card-bg:rgba(255, 255, 255, 0.08);--card-border:rgba(255, 255, 255, 0.12)}*{margin:0;padding:0;box-sizing:border-box}body{font-family:Nunito,sans-serif;background:linear-gradient(135deg,var(--bg-gradient-start) 0,var(--bg-gradient-end) 100%);min-height:100vh;color:var(--text-light);overflow-x:hidden}.bg-particles{position:fixed;top:0;left:0;width:100%;height:100%;pointer-events:none;overflow:hidden;z-index:0}.particle{position:absolute;border-radius:50%;opacity:.3;animation:float 20s infinite ease-in-out}@keyframes float{0%,100%{transform:translateY(0) rotate(0)}50%{transform:translateY(-100px) rotate(180deg)}}.app-container{position:relative;z-index:1;max-width:1200px;margin:0 auto;padding:2rem}.header{text-align:center;margin-bottom:3rem;animation:fadeInDown .8s ease-out}@keyframes fadeInDown{from{opacity:0;transform:translateY(-30px)}to{opacity:1;transform:translateY(0)}}.logo{font-family:Fredoka,sans-serif;font-size:3.5rem;font-weight:600;background:linear-gradient(135deg,var(--accent-gold) 0,var(--accent-warm) 50%,var(--accent-purple) 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;margin-bottom:.5rem;letter-spacing:-1px}.tagline{font-size:1.2rem;color:var(--text-muted);font-weight:400}.nav-tabs{display:flex;justify-content:center;gap:.5rem;margin-bottom:2rem;flex-wrap:wrap}.nav-tab{background:var(--card-bg);border:1px solid var(--card-border);border-radius:2rem;padding:.8rem 1.5rem;font-family:Nunito,sans-serif;font-size:1rem;font-weight:600;color:var(--text-muted);cursor:pointer;transition:all .3s ease}.nav-tab:hover{background:rgba(255,255,255,.12);color:var(--text-light)}.nav-tab.active{background:linear-gradient(135deg,var(--accent-purple),var(--accent-blue));color:#fff;border-color:transparent;box-shadow:0 4px 20px rgba(155,93,229,.4)}.screen{display:none;animation:fadeIn .5s ease-out}.screen.active{display:block}@keyframes fadeIn{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}.welcome-container{text-align:center;padding:3rem}.welcome-illustration{width:200px;height:200px;margin:0 auto 2rem;background:linear-gradient(135deg,var(--accent-purple) 0,var(--accent-blue) 100%);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:5rem;animation:pulse 3s infinite ease-in-out;box-shadow:0 0 60px rgba(155,93,229,.5)}@keyframes pulse{0%,100%{transform:scale(1);box-shadow:0 0 60px rgba(155,93,229,.5)}50%{transform:scale(1.05);box-shadow:0 0 80px rgba(155,93,229,.7)}}.welcome-text{font-size:1.4rem;line-height:1.8;max-width:600px;margin:0 auto 2rem;color:var(--text-light)}.start-btn{background:linear-gradient(135deg,var(--accent-gold) 0,var(--accent-warm) 100%);border:none;border-radius:3rem;padding:1.2rem 3rem;font-family:Fredoka,sans-serif;font-size:1.4rem;font-weight:500;color:#1a1a2e;cursor:pointer;transition:all .3s ease;box-shadow:0 4px 30px rgba(255,107,107,.4)}.start-btn:hover{transform:translateY(-3px);box-shadow:0 8px 40px rgba(255,107,107,.6)}.play-container{display:grid;grid-template-columns:1fr;gap:2rem}.visualization-area{background:var(--card-bg);border:1px solid var(--card-border);border-radius:2rem;padding:2rem;min-height:300px;position:relative;overflow:hidden}.visualization-canvas{width:100%;height:250px;border-radius:1rem}.mood-label{position:absolute;top:1rem;left:1.5rem;font-family:Fredoka,sans-serif;font-size:1.2rem;color:var(--accent-gold)}.controls-area{display:flex;justify-content:center;gap:1rem;flex-wrap:wrap}.control-btn{background:var(--card-bg);border:2px solid var(--card-border);border-radius:50%;width:70px;height:70px;display:flex;align-items:center;justify-content:center;font-size:1.8rem;cursor:pointer;transition:all .3s ease}.control-btn:hover{transform:scale(1.1);border-color:var(--accent-purple)}.control-btn.recording{background:var(--accent-warm);border-color:var(--accent-warm);animation:recordPulse 1s infinite}@keyframes recordPulse{0%,100%{box-shadow:0 0 0 0 rgba(255,107,107,.4)}50%{box-shadow:0 0 0 15px rgba(255,107,107,0)}}.control-btn.listening{background:var(--accent-teal);border-color:var(--accent-teal)}.notes-display{background:var(--card-bg);border:1px solid var(--card-border);border-radius:1.5rem;padding:1.5rem;text-align:center}.notes-label{font-size:.9rem;color:var(--text-muted);margin-bottom:.5rem}.detected-note{font-family:Fredoka,sans-serif;font-size:3rem;font-weight:600;color:var(--accent-gold);min-height:4rem;display:flex;align-items:center;justify-content:center}.note-history{display:flex;justify-content:center;gap:.5rem;margin-top:1rem;flex-wrap:wrap}.note-bubble{background:linear-gradient(135deg,var(--accent-purple),var(--accent-blue));border-radius:1rem;padding:.5rem 1rem;font-family:Fredoka,sans-serif;font-size:1rem;animation:popIn .3s ease-out}@keyframes popIn{from{transform:scale(0);opacity:0}to{transform:scale(1);opacity:1}}.worlds-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:1.5rem}.world-card{background:var(--card-bg);border:2px solid var(--card-border);border-radius:1.5rem;padding:2rem;text-align:center;cursor:pointer;transition:all .3s ease;position:relative;overflow:hidden}.world-card::before{content:'';position:absolute;top:0;left:0;right:0;bottom:0;opacity:0;transition:opacity .3s ease}.world-card:hover{transform:translateY(-5px);border-color:var(--accent-purple)}.world-card:hover::before{opacity:.1}.world-card.mysterious{--world-color:#9b5de5}.world-card.mysterious::before{background:var(--world-color)}.world-card.joyful{--world-color:#ffd93d}.world-card.joyful::before{background:var(--world-color)}.world-card.dreamy{--world-color:#4d96ff}.world-card.dreamy::before{background:var(--world-color)}.world-card.exciting{--world-color:#ff6b6b}.world-card.exciting::before{background:var(--world-color)}.world-card.calm{--world-color:#6bcb77}.world-card.calm::before{background:var(--world-color)}.world-card.active{border-color:var(--world-color);box-shadow:0 0 30px rgba(155,93,229,.3)}.world-icon{font-size:3rem;margin-bottom:1rem}.world-name{font-family:Fredoka,sans-serif;font-size:1.4rem;font-weight:500;margin-bottom:.5rem}.world-desc{font-size:.95rem;color:var(--text-muted);line-height:1.5}.diary-container{max-width:800px;margin:0 auto}.diary-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:2rem}.diary-title{font-family:Fredoka,sans-serif;font-size:2rem;font-weight:500}.diary-stats{display:flex;gap:2rem}.stat-item{text-align:center}.stat-value{font-family:Fredoka,sans-serif;font-size:2rem;font-weight:600;color:var(--accent-gold)}.stat-label{font-size:.85rem;color:var(--text-muted)}.diary-entries{display:flex;flex-direction:column;gap:1rem}.diary-entry{background:var(--card-bg);border:1px solid var(--card-border);border-radius:1.5rem;padding:1.5rem;display:flex;align-items:center;gap:1.5rem;transition:all .3s ease}.diary-entry:hover{background:rgba(255,255,255,.1);transform:translateX(5px)}.entry-emoji{font-size:2.5rem;width:60px;height:60px;display:flex;align-items:center;justify-content:center;background:var(--card-bg);border-radius:1rem}.entry-info{flex:1}.entry-date{font-size:.85rem;color:var(--text-muted);margin-bottom:.3rem}.entry-title{font-family:Fredoka,sans-serif;font-size:1.2rem;font-weight:500}.entry-duration{font-size:.85rem;color:var(--accent-teal);margin-top:.3rem}.entry-play{background:linear-gradient(135deg,var(--accent-purple),var(--accent-blue));border:none;border-radius:50%;width:50px;height:50px;display:flex;align-items:center;justify-content:center;font-size:1.2rem;cursor:pointer;transition:all .3s ease}.entry-play:hover{transform:scale(1.1)}.empty-diary{text-align:center;padding:4rem 2rem;color:var(--text-muted)}.empty-diary-icon{font-size:4rem;margin-bottom:1rem;opacity:.5}.garden-container{text-align:center;padding:2rem}.garden-title{font-family:Fredoka,sans-serif;font-size:2rem;font-weight:500;margin-bottom:1rem}.garden-subtitle{color:var(--text-muted);margin-bottom:2rem}.garden-visual{background:linear-gradient(180deg,#1a1a2e 0,#2d4a3e 100%);border-radius:2rem;padding:3rem;min-height:300px;position:relative;overflow:hidden}.garden-ground{position:absolute;bottom:0;left:0;right:0;height:60px;background:linear-gradient(180deg,#3d5a4a 0,#2d4a3e 100%);border-radius:0 0 2rem 2rem}.plant{position:absolute;bottom:50px;font-size:3rem;animation:sway 3s infinite ease-in-out}@keyframes sway{0%,100%{transform:rotate(-5deg)}50%{transform:rotate(5deg)}}.garden-message{position:relative;z-index:1;font-family:Fredoka,sans-serif;font-size:1.2rem;color:var(--accent-gold)}.prompt-card{background:linear-gradient(135deg,rgba(155,93,229,.2),rgba(77,150,255,.2));border:1px solid var(--accent-purple);border-radius:1.5rem;padding:2rem;text-align:center;margin-bottom:2rem}.prompt-label{font-size:.9rem;color:var(--accent-purple);margin-bottom:.5rem;text-transform:uppercase;letter-spacing:1px}.prompt-text{font-family:Fredoka,sans-serif;font-size:1.6rem;font-weight:500;line-height:1.4}.prompt-refresh{background:0 0;border:1px solid var(--card-border);border-radius:2rem;padding:.5rem 1.5rem;color:var(--text-muted);font-family:Nunito,sans-serif;cursor:pointer;margin-top:1rem;transition:all .3s ease}.prompt-refresh:hover{border-color:var(--accent-purple);color:var(--text-light)}.modal-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.8);display:flex;align-items:center;justify-content:center;z-index:1000;opacity:0;visibility:hidden;transition:all .3s ease}.modal-overlay.active{opacity:1;visibility:visible}.modal-content{background:var(--bg-gradient-start);border:1px solid var(--card-border);border-radius:2rem;padding:3rem;max-width:500px;text-align:center;transform:scale(.9);transition:transform .3s ease}.modal-overlay.active .modal-content{transform:scale(1)}.modal-icon{font-size:4rem;margin-bottom:1.5rem}.modal-title{font-family:Fredoka,sans-serif;font-size:1.8rem;margin-bottom:1rem}.modal-text{color:var(--text-muted);margin-bottom:2rem;line-height:1.6}.modal-btn{background:linear-gradient(135deg,var(--accent-teal),var(--accent-blue));border:none;border-radius:2rem;padding:1rem 2.5rem;font-family:Fredoka,sans-serif;font-size:1.1rem;color:#fff;cursor:pointer;transition:all .3s ease}.modal-btn:hover{transform:translateY(-2px);box-shadow:0 4px 20px rgba(107,203,119,.4)}.module-tabs{display:flex;justify-content:center;gap:.5rem;margin:1.25rem 0 1.5rem;flex-wrap:wrap}.module-tab{background:rgba(255,255,255,.06);border:1px solid var(--card-border);border-radius:2rem;padding:.6rem 1.1rem;font-family:Nunito,sans-serif;font-size:.95rem;font-weight:700;color:var(--text-muted);cursor:pointer;transition:all .25s ease}.module-tab:hover{background:rgba(255,255,255,.1);color:var(--text-light)}.module-tab.active{background:linear-gradient(135deg,var(--accent-teal),var(--accent-blue));color:#fff;border-color:transparent;box-shadow:0 4px 18px rgba(77,150,255,.28)}.module-tab:disabled{opacity:.45;cursor:not-allowed}.module-screen{display:none;animation:fadeIn .45s ease-out}.module-screen.active{display:block}.echo-card{background:var(--card-bg);border:1px solid var(--card-border);border-radius:2rem;padding:2rem;overflow:hidden;position:relative}.echo-header{display:flex;align-items:flex-start;justify-content:space-between;gap:1rem;margin-bottom:1rem}.echo-title{font-family:Fredoka,sans-serif;font-size:1.8rem;font-weight:600;margin-bottom:.25rem}.echo-subtitle{color:var(--text-muted);line-height:1.5}.echo-progress{display:flex;gap:.45rem;margin-top:.35rem;flex-shrink:0}.echo-dot{width:12px;height:12px;border-radius:999px;background:rgba(255,255,255,.12);border:1px solid rgba(255,255,255,.16)}.echo-dot.filled{background:linear-gradient(135deg,var(--accent-gold),var(--accent-warm));border-color:rgba(255,255,255,.18);box-shadow:0 0 18px rgba(255,217,61,.25)}.echo-status{background:rgba(0,0,0,.18);border:1px solid rgba(255,255,255,.12);border-radius:1.2rem;padding:1rem 1.2rem;color:var(--text-light);line-height:1.6;margin:1rem 0 1.2rem;min-height:3.6rem}.echo-controls{display:flex;gap:.75rem;justify-content:center;flex-wrap:wrap;margin-bottom:1.5rem}.echo-btn{background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.14);border-radius:2rem;padding:.9rem 1.4rem;font-family:Fredoka,sans-serif;font-size:1.05rem;font-weight:500;color:var(--text-light);cursor:pointer;transition:transform .2s ease,box-shadow .2s ease,background .2s ease}.echo-btn:hover{transform:translateY(-1px);background:rgba(255,255,255,.12);box-shadow:0 8px 24px rgba(0,0,0,.22)}.echo-btn.primary{background:linear-gradient(135deg,var(--accent-gold),var(--accent-warm));border-color:transparent;color:#1a1a2e;box-shadow:0 8px 26px rgba(255,107,107,.25)}.echo-btn:disabled{opacity:.5;cursor:not-allowed;transform:none;box-shadow:none}.echo-piano-wrap{background:rgba(0,0,0,.16);border:1px solid rgba(255,255,255,.12);border-radius:1.5rem;padding:1.25rem}.echo-piano{position:relative;width:100%;max-width:820px;margin:0 auto;height:190px;user-select:none;touch-action:manipulation}.echo-white-keys{position:absolute;inset:0;display:flex;gap:6px;padding:6px}.echo-key{border-radius:14px;transition:transform .12s ease,box-shadow .12s ease,background .12s ease}.echo-key.white{flex:1;background:rgba(255,255,255,.92);border:1px solid rgba(0,0,0,.22);box-shadow:0 10px 26px rgba(0,0,0,.18)}.echo-key.black{position:absolute;top:6px;height:58%;background:rgba(15,16,28,.92);border:1px solid rgba(255,255,255,.12);box-shadow:0 10px 24px rgba(0,0,0,.35);border-radius:12px;z-index:2}.echo-key.playing{transform:translateY(-2px);box-shadow:0 0 0 4px rgba(255,217,61,.28),0 18px 38px rgba(0,0,0,.28)}.echo-key.playing.white{background:rgba(255,217,61,.95)}.echo-key.playing.black{background:rgba(255,107,107,.95)}.echo-key.heard{transform:translateY(-2px);box-shadow:0 0 0 4px rgba(107,203,119,.26),0 18px 38px rgba(0,0,0,.26)}.echo-key.heard.white{background:rgba(107,203,119,.92)}.echo-key.heard.black{background:rgba(107,203,119,.85)}.echo-key.target{box-shadow:0 0 0 3px rgba(255,217,61,.22),0 0 22px rgba(255,217,61,.25);animation:echoPulse 1.6s ease-in-out infinite}.echo-key.flash{box-shadow:0 0 0 4px rgba(255,107,107,.32),0 0 28px rgba(255,107,107,.38)}@keyframes echoPulse{0%,100%{transform:translateY(0)}50%{transform:translateY(-3px)}}.echo-magnet{position:absolute;width:16px;height:16px;border-radius:999px;background:radial-gradient(circle,rgba(107,203,119,.95),rgba(107,203,119,.2));box-shadow:0 0 18px rgba(107,203,119,.45);opacity:0;transform:translate(-9999px,-9999px);pointer-events:none;transition:transform .5s ease-out,opacity .3s ease-out;z-index:5}.echo-magnet.active{opacity:1}.echo-celebrate{position:absolute;inset:0;pointer-events:none;opacity:0;display:flex;align-items:center;justify-content:center;font-size:3rem;transform:scale(.98)}.echo-celebrate.active{animation:echoCelebrate 1.1s ease-out}@keyframes echoCelebrate{0%{opacity:0;transform:scale(.92)}12%{opacity:1;transform:scale(1.02)}100%{opacity:0;transform:scale(1.08)}}@media (max-width:768px){.app-container{padding:1rem}.logo{font-size:2.5rem}.nav-tab{padding:.6rem 1rem;font-size:.9rem}.worlds-grid{grid-template-columns:1fr}.diary-header{flex-direction:column;gap:1rem}.echo-card{padding:1.4rem}.echo-piano{height:160px}}@media (prefers-reduced-motion:reduce){*{animation-duration:0s!important;animation-iteration-count:1!important;transition-duration:0s!important}.bg-particles{display:none}}</style></head><body><div class="bg-particles" id="particles"></div><div class="app-container"><header class="header"><h1 class="logo">üéπ KlangReise</h1><p class="tagline">Entdecke die Magie der Musik</p></header><nav class="nav-tabs"><button class="nav-tab active" data-screen="welcome">Start</button> <button class="nav-tab" data-screen="play">Spielen</button> <button class="nav-tab" data-screen="worlds">Klangwelten</button> <button class="nav-tab" data-screen="diary">Klangtagebuch</button> <button class="nav-tab" data-screen="garden">Mein Garten</button></nav><section class="screen active" id="welcome"><div class="welcome-container"><div class="welcome-illustration">üéµ</div><p class="welcome-text">Hallo, kleiner Klangentdecker! üåü<br><br>Hier gibt es keine richtigen oder falschen T√∂ne ‚Äì nur <em>deine</em> Musik. Stell dein Klavier bereit und lass uns zusammen herausfinden, welche Geschichten heute in deinen Fingern stecken!</p><button class="start-btn" id="startBtn">Los geht's! ‚ú®</button></div></section><section class="screen" id="play"><div class="prompt-card"><div class="prompt-label">Heute k√∂nntest du...</div><div class="prompt-text" id="dailyPrompt">Spiel mal, wie sich ein Schmetterling anh√∂rt! ü¶ã</div><button class="prompt-refresh" id="newPromptBtn">Andere Idee üé≤</button></div><div class="module-tabs" aria-label="Spielmodi"><button class="module-tab active" data-module="free">Frei</button> <button class="module-tab" data-module="echo">Echo</button> <button class="module-tab" data-module="chords" disabled="disabled">Akkorde</button> <button class="module-tab" data-module="stories" disabled="disabled">Geschichten</button> <button class="module-tab" data-module="impro" disabled="disabled">Impro</button> <button class="module-tab" data-module="feelings" disabled="disabled">Gef√ºhle</button></div><div class="active module-screen" id="module-free"><div class="play-container"><div class="visualization-area"><div class="mood-label" id="moodLabel">Frei spielen</div><canvas class="visualization-canvas" id="visualizer"></canvas></div><div class="notes-display"><div class="notes-label">Du spielst gerade:</div><div class="detected-note" id="currentNote">üéπ</div><div class="note-history" id="noteHistory"></div></div><div class="controls-area"><button class="control-btn" id="micBtn" title="Mikrofon starten">üé§</button> <button class="control-btn" id="recordBtn" title="Aufnehmen">‚è∫Ô∏è</button> <button class="control-btn" id="saveBtn" title="Speichern">üíæ</button></div></div></div><div class="module-screen" id="module-echo"><div class="echo-card"><div class="echo-celebrate" id="echoCelebrate" aria-hidden="true">‚ú®</div><div class="echo-header"><div><div class="echo-title">Echo-Spiel</div><div class="echo-subtitle">Ich spiele vor. Du spielst nach Geh√∂r.</div></div><div class="echo-progress" id="echoProgress" aria-label="Reise-Fortschritt"></div></div><div class="echo-status" id="echoStatus">Tippe auf <strong>Vorh√∂ren</strong> und spiel dann nach. Wenn du willst, darf es auch ein bisschen daneben sein.</div><div class="echo-controls"><button class="echo-btn primary" id="echoPlayBtn">‚ñ∂Ô∏è Vorh√∂ren</button> <button class="echo-btn" id="echoReplayBtn" disabled="disabled">üîÅ Nochmal</button> <button class="echo-btn" id="echoNextBtn" disabled="disabled">‚ú® Weiter</button></div><div class="echo-piano-wrap"><div class="echo-piano" id="echoPiano" aria-label="Klaviatur (vereinfachte Anzeige)"></div></div></div></div></section><section class="screen" id="worlds"><div class="worlds-grid"><div class="world-card mysterious" data-world="mysterious"><div class="world-icon">üîÆ</div><div class="world-name">Geheimnisvoll</div><div class="world-desc">Die schwarzen Tasten erz√§hlen magische Geschichten...</div></div><div class="world-card joyful" data-world="joyful"><div class="world-icon">‚òÄÔ∏è</div><div class="world-name">Fr√∂hlich</div><div class="world-desc">Lass die T√∂ne h√ºpfen und tanzen!</div></div><div class="world-card dreamy" data-world="dreamy"><div class="world-icon">üåô</div><div class="world-name">Vertr√§umt</div><div class="world-desc">Sanfte Kl√§nge wie Wolken am Himmel...</div></div><div class="world-card exciting" data-world="exciting"><div class="world-icon">‚ö°</div><div class="world-name">Aufregend</div><div class="world-desc">Schnell, laut, voller Energie!</div></div><div class="world-card calm" data-world="calm"><div class="world-icon">üåø</div><div class="world-name">Ruhig</div><div class="world-desc">Wie ein stiller See im Wald...</div></div></div></section><section class="screen" id="diary"><div class="diary-container"><div class="diary-header"><h2 class="diary-title">üìî Mein Klangtagebuch</h2><div class="diary-stats"><div class="stat-item"><div class="stat-value" id="totalRecordings">0</div><div class="stat-label">Aufnahmen</div></div><div class="stat-item"><div class="stat-value" id="totalMinutes">0</div><div class="stat-label">Minuten</div></div></div></div><div class="diary-entries" id="diaryEntries"><div class="empty-diary"><div class="empty-diary-icon">üéµ</div><p>Noch keine Aufnahmen ‚Äì deine erste Klanggeschichte wartet auf dich!</p></div></div></div></section><section class="screen" id="garden"><div class="garden-container"><h2 class="garden-title">üå± Mein Klanggarten</h2><p class="garden-subtitle">Jede Entdeckung l√§sst etwas wachsen...</p><div class="garden-visual" id="gardenVisual"><div class="garden-message">Spiele und entdecke, um deinen Garten wachsen zu lassen!</div><div class="garden-ground"></div></div></div></section></div><div class="modal-overlay" id="micModal"><div class="modal-content"><div class="modal-icon">üé§</div><h3 class="modal-title">Darf ich zuh√∂ren?</h3><p class="modal-text">Damit ich h√∂ren kann, was du spielst, brauche ich Zugriff auf dein Mikrofon. Keine Sorge ‚Äì ich speichere nichts ohne deine Erlaubnis!</p><button class="modal-btn" id="allowMicBtn">Ja, h√∂r zu! üëÇ</button></div></div><script>function safeJsonParse(value,fallback){try{return JSON.parse(value)}catch(_){return fallback}}function clampNumber(value,min,max){return Math.min(max,Math.max(min,value))}function loadEchoProgress(){const fallback={level:1},parsed=safeJsonParse(localStorage.getItem("klangreise_echo")||"null",null);if(!parsed||"object"!=typeof parsed)return fallback;return{level:clampNumber("number"==typeof parsed.level?parsed.level:fallback.level,1,5)}}function saveEchoProgress(progress){try{localStorage.setItem("klangreise_echo",JSON.stringify(progress))}catch(err){console.warn("Could not save echo progress:",err)}}const state={isListening:!1,isRecording:!1,currentWorld:null,currentModule:"free",audioContext:null,analyser:null,microphone:null,recordings:JSON.parse(localStorage.getItem("klangreise_recordings")||"[]"),gardenProgress:parseInt(localStorage.getItem("klangreise_garden")||"0"),noteHistory:[],recordedChunks:[],mediaRecorder:null,recordingStart:null,recordingStop:null,echoProgress:loadEchoProgress(),echo:{mode:"idle",level:1,maxLevel:5,expected:[],step:0,mistakes:0,isPlaying:!1,playTimeouts:[],playNodes:[],pendingStart:!1,currentOctave:4,missTimeout:null,lastHintAt:0,lastHintStep:-1,heardRecently:null,lastRoundId:0},pitchTracker:{stableFramesNeeded:4,minMsBetweenNotes:220,candidatePitchClass:null,candidateFrames:0,lastEmittedPitchClass:null,lastEmittedAt:0}},VISUALIZATION_FPS=30,NOTE_DETECT_MS=60,GARDEN_SAVE_MS=1e3,reduceMotionQuery=window.matchMedia("(prefers-reduced-motion: reduce)");let gardenSaveTimeout=null,visualizerStarted=!1,visualizerResize=null,activeAudio=null;const prompts=["Spiel mal, wie sich ein Schmetterling anh√∂rt! ü¶ã","Wie klingt es, wenn es regnet? üåßÔ∏è","Kannst du einen Elefanten spielen? üêò","Wie h√∂rt sich dein Lieblingstier an?","Spiel mal ganz leise... und dann ganz laut!","Wie klingt ein Sonnenaufgang? ‚òÄÔ∏è","Kannst du Fr√∂hlichkeit spielen?","Wie h√∂rt sich Nebel an? üå´Ô∏è","Spiel mal nur mit einem Finger!","Wie klingt ein springender Ball?","Kannst du eine Wolke spielen? ‚òÅÔ∏è","Wie h√∂rt sich Aufregung an?","Spiel mal, wie du dich gerade f√ºhlst!","Wie klingt ein Geheimnis? ü§´","Kannst du eine Geschichte ohne Worte erz√§hlen?"],flatToSharp={Db:"C#",Eb:"D#",Gb:"F#",Ab:"G#",Bb:"A#"},echoWhiteNotes=["C","D","E","F","G","A","B"],echoPhrases=[{id:"jakob",notes:["C","D","E","C"]},{id:"entchen",notes:["C","D","E","F"]},{id:"twinkle",notes:["C","C","G","G"]},{id:"mary",notes:["E","D","C","D"]}];function normalizeNoteName(noteName){return flatToSharp[noteName]||noteName}function noteNameToPitchClass(noteName){const normalized=normalizeNoteName(noteName);return noteStrings.indexOf(normalized)}function pitchClassDistance(a,b){const diff=Math.abs(a-b);return Math.min(diff,12-diff)}function midiToFrequency(midi){return 440*Math.pow(2,(midi-69)/12)}function noteNameToMidi(noteName,octave){const pc=noteNameToPitchClass(noteName);return pc<0?null:12*(octave+1)+pc}const noteStrings=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];function frequencyToNote(frequency){if(frequency<20||frequency>5e3)return null;const noteNum=Math.log(frequency/440)/Math.log(2)*12,note=Math.round(noteNum)+69,octave=Math.floor(note/12)-1,noteName=noteStrings[note%12];return{name:noteName,octave:octave,full:`${noteName}${octave}`,frequency:frequency,cents:100*(noteNum+69-note),midi:note}}function autoCorrelate(buffer,sampleRate){let SIZE=buffer.length,sumOfSquares=0;for(let i=0;i<SIZE;i++){const val=buffer[i];sumOfSquares+=val*val}if(Math.sqrt(sumOfSquares/SIZE)<.01)return-1;let r1=0,r2=SIZE-1;for(let i=0;i<SIZE/2;i++)if(Math.abs(buffer[i])<.2){r1=i;break}for(let i=1;i<SIZE/2;i++)if(Math.abs(buffer[SIZE-i])<.2){r2=SIZE-i;break}SIZE=(buffer=buffer.slice(r1,r2)).length;const c=new Array(SIZE).fill(0);for(let i=0;i<SIZE;i++)for(let j=0;j<SIZE-i;j++)c[i]+=buffer[j]*buffer[j+i];let d=0;for(;c[d]>c[d+1];)d++;let maxval=-1,maxpos=-1;for(let i=d;i<SIZE;i++)c[i]>maxval&&(maxval=c[i],maxpos=i);let T0=maxpos;const x1=c[T0-1],x2=c[T0],x3=c[T0+1],a=(x1+x3-2*x2)/2;return a&&(T0-=(x3-x1)/2/(2*a)),sampleRate/T0}async function setupAudio(){try{state.audioContext=new(window.AudioContext||window.webkitAudioContext);const stream=await navigator.mediaDevices.getUserMedia({audio:!0});return"suspended"===state.audioContext.state&&await state.audioContext.resume(),state.microphone=state.audioContext.createMediaStreamSource(stream),state.analyser=state.audioContext.createAnalyser(),state.analyser.fftSize=2048,state.microphone.connect(state.analyser),"undefined"!=typeof MediaRecorder?(state.mediaRecorder=new MediaRecorder(stream),state.mediaRecorder.ondataavailable=e=>{e.data.size>0&&state.recordedChunks.push(e.data)},state.mediaRecorder.onstop=saveRecording):(state.mediaRecorder=null,console.warn("MediaRecorder is not supported in this browser.")),!0}catch(err){return console.error("Audio setup failed:",err),!1}}function setActiveModule(moduleName){state.currentModule=moduleName,document.querySelectorAll(".module-tab").forEach(t=>{t.classList.toggle("active",t.dataset.module===moduleName)}),document.querySelectorAll(".module-screen").forEach(s=>{s.classList.toggle("active",s.id===`module-${moduleName}`)}),"echo"===moduleName?enterEchoMode():exitEchoMode(),"free"===moduleName&&state.audioContext&&setupVisualization()}function setupModuleTabs(){document.querySelectorAll(".module-tab").forEach(tab=>{tab.disabled||tab.addEventListener("click",()=>setActiveModule(tab.dataset.module))})}const echoLevels=[{level:1,length:2,allowBlack:!1,tempoMs:650,octave:4},{level:2,length:2,allowBlack:!1,tempoMs:520,octave:4},{level:3,length:4,allowBlack:!0,tempoMs:460,octave:4},{level:4,length:4,allowBlack:!1,tempoMs:480,octave:4,phrases:echoPhrases},{level:5,length:4,allowBlack:!0,tempoMs:430,octave:4,rhythm:[520,260,260,520]}],echoUI={pianoEl:null,statusEl:null,progressEl:null,playBtn:null,replayBtn:null,nextBtn:null,celebrateEl:null,whiteContainer:null,magnetEl:null};function initEchoGame(){echoUI.pianoEl=document.getElementById("echoPiano"),echoUI.statusEl=document.getElementById("echoStatus"),echoUI.progressEl=document.getElementById("echoProgress"),echoUI.playBtn=document.getElementById("echoPlayBtn"),echoUI.replayBtn=document.getElementById("echoReplayBtn"),echoUI.nextBtn=document.getElementById("echoNextBtn"),echoUI.celebrateEl=document.getElementById("echoCelebrate"),state.echo.level=clampNumber(state.echoProgress.level||1,1,state.echo.maxLevel),renderEchoProgress(),renderEchoPiano(),updateEchoControls(),echoUI.playBtn.addEventListener("click",()=>{startEchoRound({replay:!1})}),echoUI.replayBtn.addEventListener("click",()=>{startEchoRound({replay:!0})}),echoUI.nextBtn.addEventListener("click",()=>{advanceEchoLevel(),startEchoRound({replay:!1})}),window.addEventListener("resize",layoutEchoBlackKeys,{passive:!0})}function renderEchoProgress(){if(!echoUI.progressEl)return;const filled=clampNumber(state.echo.level,1,state.echo.maxLevel);echoUI.progressEl.innerHTML=Array.from({length:state.echo.maxLevel},(_,i)=>`<span class="${i<filled?"echo-dot filled":"echo-dot"}" aria-hidden="true"></span>`).join("")}function renderEchoPiano(){if(!echoUI.pianoEl)return;echoUI.pianoEl.innerHTML="";const whiteWrap=document.createElement("div");whiteWrap.className="echo-white-keys",echoUI.whiteContainer=whiteWrap,echoUI.pianoEl.appendChild(whiteWrap);const magnet=document.createElement("div");magnet.className="echo-magnet",echoUI.magnetEl=magnet,echoUI.pianoEl.appendChild(magnet),echoWhiteNotes.forEach(n=>{const key=document.createElement("div");key.className="echo-key white",key.dataset.note=n,key.setAttribute("aria-label",`Taste ${n}`),whiteWrap.appendChild(key)});["C#","D#","F#","G#","A#"].forEach(n=>{const key=document.createElement("div");key.className="echo-key black",key.dataset.note=n,key.setAttribute("aria-label",`Taste ${n}`),echoUI.pianoEl.appendChild(key)}),layoutEchoBlackKeys()}function layoutEchoBlackKeys(){if(!echoUI.pianoEl||!echoUI.whiteContainer)return;const pianoRect=echoUI.pianoEl.getBoundingClientRect(),whiteKeys=Array.from(echoUI.whiteContainer.querySelectorAll(".echo-key.white"));if(!pianoRect.width||whiteKeys.length<7)return;const blackMap={"C#":["C","D"],"D#":["D","E"],"F#":["F","G"],"G#":["G","A"],"A#":["A","B"]},getWhiteByNote=name=>whiteKeys[echoWhiteNotes.indexOf(name)],whiteW=whiteKeys[0].getBoundingClientRect().width,blackW=Math.max(24,Math.floor(.62*whiteW));echoUI.pianoEl.querySelectorAll(".echo-key.black").forEach(blackEl=>{const pair=blackMap[blackEl.dataset.note];if(!pair)return;const leftWhite=getWhiteByNote(pair[0]),rightWhite=getWhiteByNote(pair[1]);if(!leftWhite||!rightWhite)return;const leftRect=leftWhite.getBoundingClientRect(),rightRect=rightWhite.getBoundingClientRect(),center=(leftRect.right+rightRect.left)/2-pianoRect.left;blackEl.style.width=`${blackW}px`,blackEl.style.left=`${Math.round(center-blackW/2)}px`})}function setEchoStatus(text){echoUI.statusEl&&(echoUI.statusEl.textContent=text)}function updateEchoControls(){if(!echoUI.playBtn)return;const isPlaying=state.echo.isPlaying;echoUI.playBtn.disabled=isPlaying,echoUI.replayBtn.disabled=isPlaying||0===state.echo.expected.length,echoUI.nextBtn.disabled=isPlaying||"success"!==state.echo.mode,state.audioContext||"echo"!==state.currentModule||setEchoStatus("Tippe auf Vorh√∂ren. Dann frage ich dich nach dem Mikrofon.")}function enterEchoMode(){state.echo.mode="idle",state.echo.mistakes=0,state.echo.step=0,updateEchoControls()}function exitEchoMode(){state.echo.isPlaying&&cancelEchoPlayback(),state.echo.mode="idle",state.echo.step=0,state.echo.mistakes=0,clearEchoMissTimeout(),setEchoTarget(null),echoUI.magnetEl&&echoUI.magnetEl.classList.remove("active")}function getEchoLevelConfig(){const lvl=clampNumber(state.echo.level,1,state.echo.maxLevel);return echoLevels.find(l=>l.level===lvl)||echoLevels[0]}function getEchoTolerance(level){return{successThreshold:30,magneticThreshold:level<=2?120:100}}function evaluateEchoNote(targetFreq,playedFreq,level){if(!targetFreq||!playedFreq)return"MISS";if(!isFinite(targetFreq)||!isFinite(playedFreq))return"MISS";if(targetFreq<=0||playedFreq<=0)return"MISS";const distanceInCents=1200*Math.log2(playedFreq/targetFreq),absDistance=Math.abs(distanceInCents),{successThreshold:successThreshold,magneticThreshold:magneticThreshold}=getEchoTolerance(level);return absDistance<=successThreshold?"MATCH":absDistance<=magneticThreshold?"NEAR":"MISS"}function pickRandom(arr){return arr[Math.floor(Math.random()*arr.length)]}function generateEchoSequence(levelConfig){if(levelConfig.phrases&&levelConfig.phrases.length){return pickRandom(levelConfig.phrases).notes.slice(0,levelConfig.length)}const allowed=!!levelConfig.allowBlack?noteStrings.slice():echoWhiteNotes.slice(),seq=[];for(let i=0;i<levelConfig.length;i++){let candidate=null;for(let attempt=0;attempt<40;attempt++){const next=pickRandom(allowed);if(0===i){candidate=next;break}const prevPc=noteNameToPitchClass(seq[i-1]),nextPc=noteNameToPitchClass(next);if(prevPc<0||nextPc<0)continue;if(next===seq[i-1])continue;const minDist=1===levelConfig.level?4:1;if(!(pitchClassDistance(prevPc,nextPc)<minDist)){candidate=next;break}}seq.push(candidate||pickRandom(allowed))}return seq}function cancelEchoPlayback(){state.echo.playTimeouts.forEach(clearTimeout),state.echo.playTimeouts=[],state.echo.playNodes.forEach(n=>{try{n.osc.stop()}catch(_){}try{n.osc.disconnect()}catch(_){}try{n.gain.disconnect()}catch(_){}}),state.echo.playNodes=[],state.echo.isPlaying=!1,echoUI.pianoEl&&(echoUI.pianoEl.querySelectorAll(".echo-key.playing").forEach(k=>k.classList.remove("playing")),echoUI.pianoEl.querySelectorAll(".echo-key.heard").forEach(k=>k.classList.remove("heard")))}function clearEchoMissTimeout(){state.echo.missTimeout&&(clearTimeout(state.echo.missTimeout),state.echo.missTimeout=null)}function setEchoTarget(noteName){if(!echoUI.pianoEl)return;if(echoUI.pianoEl.querySelectorAll(".echo-key.target").forEach(k=>k.classList.remove("target")),!noteName)return;const normalized=normalizeNoteName(noteName),el=echoUI.pianoEl.querySelector(`.echo-key[data-note="${normalized}"]`);el&&el.classList.add("target")}function flashEchoTarget(noteName){if(!echoUI.pianoEl)return;const normalized=normalizeNoteName(noteName),el=echoUI.pianoEl.querySelector(`.echo-key[data-note="${normalized}"]`);if(!el)return;el.classList.add("flash");const t=setTimeout(()=>el.classList.remove("flash"),350);state.echo.playTimeouts.push(t)}function showMagnetFlow(fromNote,toNote){if(!echoUI.magnetEl||!echoUI.pianoEl)return;const fromEl=echoUI.pianoEl.querySelector(`.echo-key[data-note="${normalizeNoteName(fromNote)}"]`),toEl=echoUI.pianoEl.querySelector(`.echo-key[data-note="${normalizeNoteName(toNote)}"]`);if(!fromEl||!toEl)return;const pianoRect=echoUI.pianoEl.getBoundingClientRect(),fromRect=fromEl.getBoundingClientRect(),toRect=toEl.getBoundingClientRect(),fromX=fromRect.left+fromRect.width/2-pianoRect.left-8,fromY=fromRect.top+fromRect.height/2-pianoRect.top-8,toX=toRect.left+toRect.width/2-pianoRect.left-8,toY=toRect.top+toRect.height/2-pianoRect.top-8;echoUI.magnetEl.classList.remove("active"),echoUI.magnetEl.style.transform=`translate(${fromX}px, ${fromY}px)`,echoUI.magnetEl.offsetWidth,echoUI.magnetEl.classList.add("active"),echoUI.magnetEl.style.transform=`translate(${toX}px, ${toY}px)`;const t=setTimeout(()=>{echoUI.magnetEl&&echoUI.magnetEl.classList.remove("active")},520);state.echo.playTimeouts.push(t)}function playEchoWhisper(noteName){if(!state.audioContext)return;const midi=noteNameToMidi(noteName,state.echo.currentOctave||4),freq=midi?midiToFrequency(midi):null;if(!freq)return;const ctx=state.audioContext,when=ctx.currentTime+.02,osc=ctx.createOscillator(),gain=ctx.createGain();osc.type="sine",osc.frequency.setValueAtTime(freq,when),gain.gain.setValueAtTime(1e-4,when),gain.gain.linearRampToValueAtTime(.05,when+.02),gain.gain.exponentialRampToValueAtTime(1e-4,when+.26),osc.connect(gain),gain.connect(ctx.destination),osc.start(when),osc.stop(when+.3),state.echo.playNodes.push({osc:osc,gain:gain}),highlightEchoKey(noteName,"playing",220)}function playEchoChime(){if(!state.audioContext)return;const ctx=state.audioContext,when=ctx.currentTime+.02,osc=ctx.createOscillator(),gain=ctx.createGain();osc.type="triangle",osc.frequency.setValueAtTime(880,when),gain.gain.setValueAtTime(1e-4,when),gain.gain.linearRampToValueAtTime(.08,when+.02),gain.gain.exponentialRampToValueAtTime(1e-4,when+.35),osc.connect(gain),gain.connect(ctx.destination),osc.start(when),osc.stop(when+.4),state.echo.playNodes.push({osc:osc,gain:gain})}function highlightEchoKey(noteName,className,holdMs){if(!echoUI.pianoEl)return;const normalized=normalizeNoteName(noteName),el=echoUI.pianoEl.querySelector(`.echo-key[data-note="${normalized}"]`);if(!el)return;if(el.classList.add(className),!holdMs)return;const t=setTimeout(()=>el.classList.remove(className),holdMs);state.echo.playTimeouts.push(t)}async function playEchoSequence(sequence,levelConfig){if(!state.audioContext)return;if("suspended"===state.audioContext.state)try{await state.audioContext.resume()}catch(_){}cancelEchoPlayback(),clearEchoMissTimeout(),state.echo.isPlaying=!0,state.echo.mode="playing",updateEchoControls();const ctx=state.audioContext,tempoMs=levelConfig.tempoMs,rhythm=Array.isArray(levelConfig.rhythm)?levelConfig.rhythm:null,baseOctave="number"==typeof levelConfig.octave?levelConfig.octave:4;state.echo.currentOctave=baseOctave;const startAt=ctx.currentTime+.08;let cursor=0;sequence.forEach((noteName,i)=>{const durMs=rhythm&&rhythm[i]||tempoMs,durSec=Math.max(.14,durMs/1e3),when=startAt+cursor;cursor+=durSec+.05;const midi=noteNameToMidi(noteName,baseOctave),freq=midi?midiToFrequency(midi):null;if(!freq)return;const osc=ctx.createOscillator(),gain=ctx.createGain();osc.type="triangle",osc.frequency.setValueAtTime(freq,when);gain.gain.setValueAtTime(1e-4,when),gain.gain.linearRampToValueAtTime(.12,when+.02),gain.gain.exponentialRampToValueAtTime(1e-4,when+durSec),osc.connect(gain),gain.connect(ctx.destination),osc.start(when),osc.stop(when+durSec+.03),state.echo.playNodes.push({osc:osc,gain:gain});performance.now();const delayMs=Math.max(0,Math.round(1e3*(when-startAt)));state.echo.playTimeouts.push(setTimeout(()=>{highlightEchoKey(noteName,"playing",Math.max(180,Math.round(1e3*durSec)))},delayMs))});const totalMs=Math.round(1e3*(cursor+.1));await new Promise(resolve=>{const t=setTimeout(resolve,totalMs);state.echo.playTimeouts.push(t)}),state.echo.isPlaying=!1,state.echo.mode="awaiting",updateEchoControls(),setEchoStatus("Jetzt du. H√∂r mit deinen Ohren und spiel es nach."),setEchoTarget(state.echo.expected[state.echo.step])}async function startEchoRound({replay:replay}){if(!state.audioContext)return state.echo.pendingStart=!0,document.getElementById("micModal").classList.add("active"),void updateEchoControls();if(!state.isListening&&state.analyser){state.isListening=!0;const micBtn=document.getElementById("micBtn");micBtn&&micBtn.classList.add("listening"),startNoteDetection()}const levelConfig=getEchoLevelConfig();state.echo.mistakes=0,state.echo.step=0,state.echo.mode="idle",state.echo.lastRoundId=Date.now(),state.echo.lastHintStep=-1,state.echo.lastHintAt=0,clearEchoMissTimeout(),replay&&0!==state.echo.expected.length||(state.echo.expected=generateEchoSequence(levelConfig)),echoUI.pianoEl&&echoUI.pianoEl.querySelectorAll(".echo-key.heard").forEach(k=>k.classList.remove("heard")),setEchoTarget(null),setEchoStatus("Ich spiele vor..."),await playEchoSequence(state.echo.expected,levelConfig),echoUI.replayBtn.disabled=!1}function advanceEchoLevel(){const nextLevel=clampNumber(state.echo.level+1,1,state.echo.maxLevel);state.echo.level=nextLevel,state.echoProgress.level=nextLevel,saveEchoProgress(state.echoProgress),renderEchoProgress(),state.echo.mode="idle",state.echo.step=0,state.echo.expected=[],updateEchoControls()}function echoCelebrate(){echoUI.celebrateEl&&(echoUI.celebrateEl.classList.remove("active"),echoUI.celebrateEl.offsetWidth,echoUI.celebrateEl.classList.add("active"))}function onEchoStableNote(note){if("echo"!==state.currentModule)return;if(state.echo.isPlaying)return;if("awaiting"!==state.echo.mode)return;if(!state.echo.expected.length)return;if(noteNameToPitchClass(note.name)<0)return;highlightEchoKey(note.name,"heard",220);const expectedName=state.echo.expected[state.echo.step];if(noteNameToPitchClass(expectedName)<0)return;const playedFreq=note.frequency||null,targetMidi=noteNameToMidi(expectedName,state.echo.currentOctave||4),result=evaluateEchoNote(targetMidi?midiToFrequency(targetMidi):null,playedFreq,state.echo.level);if(clearEchoMissTimeout(),"NEAR"===result){const now=performance.now();return(now-state.echo.lastHintAt>700||state.echo.lastHintStep!==state.echo.step)&&(showMagnetFlow(note.name,expectedName),setEchoStatus("Fast da. Such den Klang noch ein bisschen."),state.echo.lastHintAt=now,state.echo.lastHintStep=state.echo.step),void(state.echo.level<=2&&handleEchoMatch())}if("MISS"===result)return state.echo.mistakes+=1,flashEchoTarget(expectedName),state.echo.missTimeout||(state.echo.missTimeout=setTimeout(()=>{state.echo.missTimeout=null,"awaiting"===state.echo.mode&&(state.echo.isPlaying||state.echo.expected[state.echo.step]===expectedName&&playEchoWhisper(expectedName))},2e3)),3===state.echo.mistakes&&setEchoStatus("Wenn du magst, spiele ich es dir nochmal vor."),void(state.echo.mistakes>=6&&(state.echo.mistakes=0,startEchoRound({replay:!0})));function handleEchoMatch(){if(highlightEchoKey(expectedName,"playing",260),state.echo.step+=1,state.echo.mistakes=0,setEchoStatus("Sch√∂n! Und jetzt kommt noch ein Klang..."),state.echo.step>=state.echo.expected.length)return state.echo.mode="success",setEchoStatus("Wow. Dein Echo war wundersch√∂n. Wenn du magst: weiter."),echoCelebrate(),playEchoChime(),updateEchoControls(),setEchoTarget(null),state.gardenProgress+=5,void scheduleGardenSave();setEchoTarget(state.echo.expected[state.echo.step])}handleEchoMatch()}function setupVisualization(){if(visualizerStarted)return void("function"==typeof visualizerResize&&visualizerResize());visualizerStarted=!0;const canvas=document.getElementById("visualizer"),ctx=canvas.getContext("2d"),particles=[],maxParticles=reduceMotionQuery.matches?0:120,frameInterval=1e3/(reduceMotionQuery.matches?12:30);let dataArray=null,bufferLength=0,lastFrameTime=0;function resize(){const dpr=window.devicePixelRatio||1,rect=canvas.getBoundingClientRect();canvas.width=Math.max(1,Math.floor(rect.width*dpr)),canvas.height=Math.max(1,Math.floor(rect.height*dpr))}visualizerResize=resize,resize(),window.addEventListener("resize",resize,{passive:!0}),requestAnimationFrame(function animate(now){if(requestAnimationFrame(animate),!(document.hidden||now-lastFrameTime<frameInterval)){if(lastFrameTime=now,ctx.fillStyle="rgba(26, 26, 46, 0.1)",ctx.fillRect(0,0,canvas.width,canvas.height),state.isListening&&state.analyser){const data=state.analyser?(dataArray&&bufferLength===state.analyser.frequencyBinCount||(bufferLength=state.analyser.frequencyBinCount,dataArray=new Uint8Array(bufferLength)),state.analyser.getByteFrequencyData(dataArray),dataArray):null;if(data){let sum=0;for(let i=0;i<bufferLength;i++)sum+=data[i];sum/bufferLength>20&&particles.length<maxParticles&&particles.push({x:canvas.width/2+200*(Math.random()-.5),y:canvas.height/2,vx:10*(Math.random()-.5),vy:10*(Math.random()-.5)-5,radius:20*Math.random()+5,color:getWorldColor(),life:1});const barWidth=canvas.width/64,step=Math.max(1,Math.floor(bufferLength/64));for(let i=0;i<64;i++){const barHeight=1.5*data[i*step],hue=4*i+(state.currentWorld?getWorldHue():260);ctx.fillStyle=`hsla(${hue}, 80%, 60%, 0.6)`,ctx.fillRect(i*barWidth,canvas.height-barHeight,barWidth-2,barHeight)}}}for(let i=particles.length-1;i>=0;i--){const p=particles[i];p.x+=p.vx,p.y+=p.vy,p.vy+=.1,p.life-=.02,p.life<=0?particles.splice(i,1):(ctx.beginPath(),ctx.arc(p.x,p.y,p.radius*p.life,0,2*Math.PI),ctx.fillStyle=p.color.replace("1)",`${p.life})`),ctx.fill())}}})}function getWorldColor(){return{mysterious:"rgba(155, 93, 229, 1)",joyful:"rgba(255, 217, 61, 1)",dreamy:"rgba(77, 150, 255, 1)",exciting:"rgba(255, 107, 107, 1)",calm:"rgba(107, 203, 119, 1)"}[state.currentWorld]||"rgba(155, 93, 229, 1)"}function getWorldHue(){return{mysterious:270,joyful:45,dreamy:210,exciting:0,calm:140}[state.currentWorld]||260}function startNoteDetection(){if(!state.analyser)return;const bufferLength=state.analyser.fftSize,buffer=new Float32Array(bufferLength);let lastDetectTime=0;requestAnimationFrame(function detect(now){if(!state.isListening)return;if(document.hidden)return void requestAnimationFrame(detect);if(now-lastDetectTime<60)return void requestAnimationFrame(detect);lastDetectTime=now,state.analyser.getFloatTimeDomainData(buffer);const frequency=autoCorrelate(buffer,state.audioContext.sampleRate);if(frequency>0){const note=frequencyToNote(frequency);note&&updateNoteDisplay(note)}requestAnimationFrame(detect)})}function feedPitchTracker(note,nowMs){const pc=noteNameToPitchClass(note.name);if(pc<0)return;const t=state.pitchTracker;t.candidatePitchClass===pc?t.candidateFrames+=1:(t.candidatePitchClass=pc,t.candidateFrames=1),t.candidateFrames<t.stableFramesNeeded||t.lastEmittedPitchClass!==pc&&(nowMs-t.lastEmittedAt<t.minMsBetweenNotes||(t.lastEmittedPitchClass=pc,t.lastEmittedAt=nowMs,onEchoStableNote(note)))}function updateNoteDisplay(note){feedPitchTracker(note,performance.now());const noteEl=document.getElementById("currentNote"),historyEl=document.getElementById("noteHistory");noteEl&&(noteEl.textContent=note.full,noteEl.style.color=getWorldColor()),0!==state.noteHistory.length&&state.noteHistory[state.noteHistory.length-1]===note.full||(state.noteHistory.push(note.full),state.noteHistory.length>8&&state.noteHistory.shift(),historyEl&&(historyEl.innerHTML=state.noteHistory.map(n=>`<span class="note-bubble">${n}</span>`).join("")),state.gardenProgress++,scheduleGardenSave())}function scheduleGardenSave(){gardenSaveTimeout||(gardenSaveTimeout=setTimeout(()=>{localStorage.setItem("klangreise_garden",state.gardenProgress),gardenSaveTimeout=null},1e3))}function toggleRecording(){const btn=document.getElementById("recordBtn");state.mediaRecorder?state.isRecording?(state.recordingStop=performance.now(),state.mediaRecorder.stop(),state.isRecording=!1,btn.classList.remove("recording"),btn.textContent="‚è∫Ô∏è"):(state.recordedChunks=[],state.recordingStart=performance.now(),state.recordingStop=null,state.mediaRecorder.start(),state.isRecording=!0,btn.classList.add("recording"),btn.textContent="‚èπÔ∏è"):alert("Aufnahmen werden in diesem Browser nicht unterst√ºtzt.")}function saveRecording(){const blob=new Blob(state.recordedChunks,{type:"audio/webm"}),url=URL.createObjectURL(blob),durationMs=state.recordingStart&&state.recordingStop?state.recordingStop-state.recordingStart:null,duration=durationMs?Math.max(1,Math.round(durationMs/1e3)):Math.floor(state.recordedChunks.length/2),recording={id:Date.now(),url:url,date:(new Date).toLocaleDateString("de-DE"),time:(new Date).toLocaleTimeString("de-DE",{hour:"2-digit",minute:"2-digit"}),emoji:["üéµ","üé∂","üéπ","‚ú®","üåü","üí´","üéº"][Math.floor(7*Math.random())],world:state.currentWorld,duration:duration};state.recordings.unshift(recording),localStorage.setItem("klangreise_recordings",JSON.stringify(state.recordings.map(r=>({...r,url:null})))),state.recordingStart=null,state.recordingStop=null,updateDiaryView(),alert("üéâ Toll gemacht! Deine Aufnahme wurde im Klangtagebuch gespeichert!")}function playRecording(url){if(!url)return;activeAudio&&(activeAudio.pause(),activeAudio.currentTime=0);const audio=new Audio(url);activeAudio=audio,audio.play(),audio.addEventListener("ended",()=>{activeAudio===audio&&(activeAudio=null)})}function updateDiaryView(){const container=document.getElementById("diaryEntries"),totalEl=document.getElementById("totalRecordings"),minutesEl=document.getElementById("totalMinutes");totalEl.textContent=state.recordings.length,minutesEl.textContent=Math.floor(state.recordings.reduce((a,r)=>a+(r.duration||0),0)/60),0!==state.recordings.length?container.innerHTML=state.recordings.map(r=>`\n                <div class="diary-entry">\n                    <div class="entry-emoji">${r.emoji}</div>\n                    <div class="entry-info">\n                        <div class="entry-date">${r.date} um ${r.time}</div>\n                        <div class="entry-title">${r.world?"Klangwelt: "+r.world:"Freies Spielen"}</div>\n                        <div class="entry-duration">${r.duration||"?"} Sekunden</div>\n                    </div>\n                    ${r.url?`<button class="entry-play" onclick="playRecording('${r.url}')">‚ñ∂Ô∏è</button>`:""}\n                </div>\n            `).join(""):container.innerHTML='\n                    <div class="empty-diary">\n                        <div class="empty-diary-icon">üéµ</div>\n                        <p>Noch keine Aufnahmen ‚Äì deine erste Klanggeschichte wartet auf dich!</p>\n                    </div>\n                '}function updateGardenView(){const garden=document.getElementById("gardenVisual"),progress=state.gardenProgress,plants=["üå±","üåø","üå∏","üå∫","üåª","üå∑","üåπ","ü™ª","üåº","üíê"],trees=["üå≤","üå≥","üå¥"];let plantsHTML="";const numPlants=Math.min(Math.floor(progress/10),15);for(let i=0;i<numPlants;i++){const plant=progress>100&&i<3?trees[i%3]:plants[i%plants.length];plantsHTML+=`<div class="plant" style="left: ${10+6*i+3*Math.random()}%; animation-delay: ${.2*i}s;">${plant}</div>`}const message=progress<10?"Spiele und entdecke, um deinen Garten wachsen zu lassen!":progress<50?"Dein Garten beginnt zu wachsen! üå±":progress<100?"Wunderbar! So viele sch√∂ne Pflanzen! üå∏":"Wow! Dein Garten ist ein Paradies! üå≥‚ú®";garden.innerHTML=`\n                <div class="garden-message">${message}</div>\n                ${plantsHTML}\n                <div class="garden-ground"></div>\n            `}function createBackgroundParticles(){if(reduceMotionQuery.matches)return;const container=document.getElementById("particles"),colors=["#9b5de5","#4d96ff","#6bcb77","#ffd93d","#ff6b6b"],fragment=document.createDocumentFragment();for(let i=0;i<20;i++){const particle=document.createElement("div");particle.className="particle",particle.style.width=100*Math.random()+20+"px",particle.style.height=particle.style.width,particle.style.left=100*Math.random()+"%",particle.style.top=100*Math.random()+"%",particle.style.background=colors[Math.floor(Math.random()*colors.length)],particle.style.animationDelay=20*Math.random()+"s",particle.style.animationDuration=20*Math.random()+15+"s",fragment.appendChild(particle)}container.appendChild(fragment)}document.querySelectorAll(".nav-tab").forEach(tab=>{tab.addEventListener("click",()=>{document.querySelectorAll(".nav-tab").forEach(t=>t.classList.remove("active")),document.querySelectorAll(".screen").forEach(s=>s.classList.remove("active")),tab.classList.add("active"),document.getElementById(tab.dataset.screen).classList.add("active"),"garden"===tab.dataset.screen&&updateGardenView(),"diary"===tab.dataset.screen&&updateDiaryView()})}),document.getElementById("startBtn").addEventListener("click",()=>{document.querySelector('[data-screen="play"]').click(),document.getElementById("micModal").classList.add("active")}),document.getElementById("allowMicBtn").addEventListener("click",async()=>{await setupAudio()&&(document.getElementById("micModal").classList.remove("active"),state.isListening=!0,document.getElementById("micBtn").classList.add("listening"),startNoteDetection(),setupVisualization(),updateEchoControls(),"echo"===state.currentModule&&state.echo.pendingStart&&(state.echo.pendingStart=!1,startEchoRound({replay:!1})))}),document.getElementById("micBtn").addEventListener("click",async()=>{state.audioContext?(state.isListening=!state.isListening,document.getElementById("micBtn").classList.toggle("listening",state.isListening),state.isListening&&startNoteDetection(),updateEchoControls()):document.getElementById("micModal").classList.add("active")}),document.getElementById("recordBtn").addEventListener("click",()=>{state.audioContext?toggleRecording():alert("Bitte aktiviere zuerst das Mikrofon! üé§")}),document.getElementById("saveBtn").addEventListener("click",()=>{alert("üíæ Bald kannst du hier kleine Klangnotizen speichern!")}),document.getElementById("newPromptBtn").addEventListener("click",()=>{const prompt=prompts[Math.floor(Math.random()*prompts.length)];document.getElementById("dailyPrompt").textContent=prompt}),document.querySelectorAll(".world-card").forEach(card=>{card.addEventListener("click",()=>{document.querySelectorAll(".world-card").forEach(c=>c.classList.remove("active")),card.classList.add("active"),state.currentWorld=card.dataset.world,document.getElementById("moodLabel").textContent=card.querySelector(".world-name").textContent,document.querySelector('[data-screen="play"]').click()})}),window.addEventListener("beforeunload",()=>{gardenSaveTimeout&&(localStorage.setItem("klangreise_garden",state.gardenProgress),gardenSaveTimeout=null)}),createBackgroundParticles(),setupModuleTabs(),initEchoGame(),updateDiaryView(),document.getElementById("dailyPrompt").textContent=prompts[Math.floor(Math.random()*prompts.length)]</script></body></html>